/*
                      EUROPEAN UNION PUBLIC LICENCE v. 1.2
                      EUPL © the European Union 2007, 2016

This European Union Public Licence (the ‘EUPL’) applies to the Work (as defined
below) which is provided under the terms of this Licence. Any use of the Work,
other than as authorised under this Licence is prohibited (to the extent such
use is covered by a right of the copyright holder of the Work).

The Work is provided under the terms of this Licence when the Licensor (as
defined below) has placed the following notice immediately following the
copyright notice for the Work:

        Licensed under the EUPL

or has expressed by any other means his willingness to license under the EUPL.

1. Definitions

In this Licence, the following terms have the following meaning:

- ‘The Licence’: this Licence.

- ‘The Original Work’: the work or software distributed or communicated by the
  Licensor under this Licence, available as Source Code and also as Executable
  Code as the case may be.

- ‘Derivative Works’: the works or software that could be created by the
  Licensee, based upon the Original Work or modifications thereof. This Licence
  does not define the extent of modification or dependence on the Original Work
  required in order to classify a work as a Derivative Work; this extent is
  determined by copyright law applicable in the country mentioned in Article 15.

- ‘The Work’: the Original Work or its Derivative Works.

- ‘The Source Code’: the human-readable form of the Work which is the most
  convenient for people to study and modify.

- ‘The Executable Code’: any code which has generally been compiled and which is
  meant to be interpreted by a computer as a program.

- ‘The Licensor’: the natural or legal person that distributes or communicates
  the Work under the Licence.

- ‘Contributor(s)’: any natural or legal person who modifies the Work under the
  Licence, or otherwise contributes to the creation of a Derivative Work.

- ‘The Licensee’ or ‘You’: any natural or legal person who makes any usage of
  the Work under the terms of the Licence.

- ‘Distribution’ or ‘Communication’: any act of selling, giving, lending,
  renting, distributing, communicating, transmitting, or otherwise making
  available, online or offline, copies of the Work or providing access to its
  essential functionalities at the disposal of any other natural or legal
  person.

2. Scope of the rights granted by the Licence

The Licensor hereby grants You a worldwide, royalty-free, non-exclusive,
sublicensable licence to do the following, for the duration of copyright vested
in the Original Work:

- use the Work in any circumstance and for all usage,
- reproduce the Work,
- modify the Work, and make Derivative Works based upon the Work,
- communicate to the public, including the right to make available or display
  the Work or copies thereof to the public and perform publicly, as the case may
  be, the Work,
- distribute the Work or copies thereof,
- lend and rent the Work or copies thereof,
- sublicense rights in the Work or copies thereof.

Those rights can be exercised on any media, supports and formats, whether now
known or later invented, as far as the applicable law permits so.

In the countries where moral rights apply, the Licensor waives his right to
exercise his moral right to the extent allowed by law in order to make effective
the licence of the economic rights here above listed.

The Licensor grants to the Licensee royalty-free, non-exclusive usage rights to
any patents held by the Licensor, to the extent necessary to make use of the
rights granted on the Work under this Licence.

3. Communication of the Source Code

The Licensor may provide the Work either in its Source Code form, or as
Executable Code. If the Work is provided as Executable Code, the Licensor
provides in addition a machine-readable copy of the Source Code of the Work
along with each copy of the Work that the Licensor distributes or indicates, in
a notice following the copyright notice attached to the Work, a repository where
the Source Code is easily and freely accessible for as long as the Licensor
continues to distribute or communicate the Work.

4. Limitations on copyright

Nothing in this Licence is intended to deprive the Licensee of the benefits from
any exception or limitation to the exclusive rights of the rights owners in the
Work, of the exhaustion of those rights or of other applicable limitations
thereto.

5. Obligations of the Licensee

The grant of the rights mentioned above is subject to some restrictions and
obligations imposed on the Licensee. Those obligations are the following:

Attribution right: The Licensee shall keep intact all copyright, patent or
trademarks notices and all notices that refer to the Licence and to the
disclaimer of warranties. The Licensee must include a copy of such notices and a
copy of the Licence with every copy of the Work he/she distributes or
communicates. The Licensee must cause any Derivative Work to carry prominent
notices stating that the Work has been modified and the date of modification.

Copyleft clause: If the Licensee distributes or communicates copies of the
Original Works or Derivative Works, this Distribution or Communication will be
done under the terms of this Licence or of a later version of this Licence
unless the Original Work is expressly distributed only under this version of the
Licence — for example by communicating ‘EUPL v. 1.2 only’. The Licensee
(becoming Licensor) cannot offer or impose any additional terms or conditions on
the Work or Derivative Work that alter or restrict the terms of the Licence.

Compatibility clause: If the Licensee Distributes or Communicates Derivative
Works or copies thereof based upon both the Work and another work licensed under
a Compatible Licence, this Distribution or Communication can be done under the
terms of this Compatible Licence. For the sake of this clause, ‘Compatible
Licence’ refers to the licences listed in the appendix attached to this Licence.
Should the Licensee's obligations under the Compatible Licence conflict with
his/her obligations under this Licence, the obligations of the Compatible
Licence shall prevail.

Provision of Source Code: When distributing or communicating copies of the Work,
the Licensee will provide a machine-readable copy of the Source Code or indicate
a repository where this Source will be easily and freely available for as long
as the Licensee continues to distribute or communicate the Work.

Legal Protection: This Licence does not grant permission to use the trade names,
trademarks, service marks, or names of the Licensor, except as required for
reasonable and customary use in describing the origin of the Work and
reproducing the content of the copyright notice.

6. Chain of Authorship

The original Licensor warrants that the copyright in the Original Work granted
hereunder is owned by him/her or licensed to him/her and that he/she has the
power and authority to grant the Licence.

Each Contributor warrants that the copyright in the modifications he/she brings
to the Work are owned by him/her or licensed to him/her and that he/she has the
power and authority to grant the Licence.

Each time You accept the Licence, the original Licensor and subsequent
Contributors grant You a licence to their contributions to the Work, under the
terms of this Licence.

7. Disclaimer of Warranty

The Work is a work in progress, which is continuously improved by numerous
Contributors. It is not a finished work and may therefore contain defects or
‘bugs’ inherent to this type of development.

For the above reason, the Work is provided under the Licence on an ‘as is’ basis
and without warranties of any kind concerning the Work, including without
limitation merchantability, fitness for a particular purpose, absence of defects
or errors, accuracy, non-infringement of intellectual property rights other than
copyright as stated in Article 6 of this Licence.

This disclaimer of warranty is an essential part of the Licence and a condition
for the grant of any rights to the Work.

8. Disclaimer of Liability

Except in the cases of wilful misconduct or damages directly caused to natural
persons, the Licensor will in no event be liable for any direct or indirect,
material or moral, damages of any kind, arising out of the Licence or of the use
of the Work, including without limitation, damages for loss of goodwill, work
stoppage, computer failure or malfunction, loss of data or any commercial
damage, even if the Licensor has been advised of the possibility of such damage.
However, the Licensor will be liable under statutory product liability laws as
far such laws apply to the Work.

9. Additional agreements

While distributing the Work, You may choose to conclude an additional agreement,
defining obligations or services consistent with this Licence. However, if
accepting obligations, You may act only on your own behalf and on your sole
responsibility, not on behalf of the original Licensor or any other Contributor,
and only if You agree to indemnify, defend, and hold each Contributor harmless
for any liability incurred by, or claims asserted against such Contributor by
the fact You have accepted any warranty or additional liability.

10. Acceptance of the Licence

The provisions of this Licence can be accepted by clicking on an icon ‘I agree’
placed under the bottom of a window displaying the text of this Licence or by
affirming consent in any other similar way, in accordance with the rules of
applicable law. Clicking on that icon indicates your clear and irrevocable
acceptance of this Licence and all of its terms and conditions.

Similarly, you irrevocably accept this Licence and all of its terms and
conditions by exercising any rights granted to You by Article 2 of this Licence,
such as the use of the Work, the creation by You of a Derivative Work or the
Distribution or Communication by You of the Work or copies thereof.

11. Information to the public

In case of any Distribution or Communication of the Work by means of electronic
communication by You (for example, by offering to download the Work from a
remote location) the distribution channel or media (for example, a website) must
at least provide to the public the information requested by the applicable law
regarding the Licensor, the Licence and the way it may be accessible, concluded,
stored and reproduced by the Licensee.

12. Termination of the Licence

The Licence and the rights granted hereunder will terminate automatically upon
any breach by the Licensee of the terms of the Licence.

Such a termination will not terminate the licences of any person who has
received the Work from the Licensee under the Licence, provided such persons
remain in full compliance with the Licence.

13. Miscellaneous

Without prejudice of Article 9 above, the Licence represents the complete
agreement between the Parties as to the Work.

If any provision of the Licence is invalid or unenforceable under applicable
law, this will not affect the validity or enforceability of the Licence as a
whole. Such provision will be construed or reformed so as necessary to make it
valid and enforceable.

The European Commission may publish other linguistic versions or new versions of
this Licence or updated versions of the Appendix, so far this is required and
reasonable, without reducing the scope of the rights granted by the Licence. New
versions of the Licence will be published with a unique version number.

All linguistic versions of this Licence, approved by the European Commission,
have identical value. Parties can take advantage of the linguistic version of
their choice.

14. Jurisdiction

Without prejudice to specific agreement between parties,

- any litigation resulting from the interpretation of this License, arising
  between the European Union institutions, bodies, offices or agencies, as a
  Licensor, and any Licensee, will be subject to the jurisdiction of the Court
  of Justice of the European Union, as laid down in article 272 of the Treaty on
  the Functioning of the European Union,

- any litigation arising between other parties and resulting from the
  interpretation of this License, will be subject to the exclusive jurisdiction
  of the competent court where the Licensor resides or conducts its primary
  business.

15. Applicable Law

Without prejudice to specific agreement between parties,

- this Licence shall be governed by the law of the European Union Member State
  where the Licensor has his seat, resides or has his registered office,

- this licence shall be governed by Belgian law if the Licensor has no seat,
  residence or registered office inside a European Union Member State.

Appendix

‘Compatible Licences’ according to Article 5 EUPL are:

- GNU General Public License (GPL) v. 2, v. 3
- GNU Affero General Public License (AGPL) v. 3
- Open Software License (OSL) v. 2.1, v. 3.0
- Eclipse Public License (EPL) v. 1.0
- CeCILL v. 2.0, v. 2.1
- Mozilla Public Licence (MPL) v. 2
- GNU Lesser General Public Licence (LGPL) v. 2.1, v. 3
- Creative Commons Attribution-ShareAlike v. 3.0 Unported (CC BY-SA 3.0) for
  works other than software
- European Union Public Licence (EUPL) v. 1.1, v. 1.2
- Québec Free and Open-Source Licence — Reciprocity (LiLiQ-R) or Strong
  Reciprocity (LiLiQ-R+).

The European Commission may update this Appendix to later versions of the above
licences without producing a new version of the EUPL, as long as they provide
the rights granted in Article 2 of this Licence and protect the covered Source
Code from exclusive appropriation.

All other changes or additions to this Appendix require the production of a new
EUPL version.
*/
package it.eng.auriga.ui.module.layout.server.protocollazione.datasource;

import java.io.File;
import java.io.InputStream;
import java.io.StringReader;
import java.io.StringWriter;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Vector;
import java.util.concurrent.ThreadLocalRandom;

import javax.xml.bind.JAXBException;

import org.apache.commons.beanutils.BeanUtilsBean2;
import org.apache.commons.beanutils.ConvertUtils;
import org.apache.commons.io.FileDeleteStrategy;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;
import org.jfree.util.Log;
import org.jsoup.helper.StringUtil;
import org.springframework.beans.factory.NoSuchBeanDefinitionException;

import it.eng.auriga.compiler.ModelliUtil;
import it.eng.auriga.database.store.bean.SchemaBean;
import it.eng.auriga.database.store.dmpk_core.bean.DmpkCoreDel_ud_doc_verBean;
import it.eng.auriga.database.store.dmpk_core.bean.DmpkCoreFindfascinarchivioBean;
import it.eng.auriga.database.store.dmpk_core.bean.DmpkCoreFindudBean;
import it.eng.auriga.database.store.dmpk_core.bean.DmpkCoreUpddocudBean;
import it.eng.auriga.database.store.dmpk_int_mgo_email.bean.DmpkIntMgoEmailPreparaemailnotassinvioccBean;
import it.eng.auriga.database.store.dmpk_load_combo.bean.DmpkLoadComboDmfn_load_comboBean;
import it.eng.auriga.database.store.dmpk_modelli_doc.bean.DmpkModelliDocExtractvermodelloBean;
import it.eng.auriga.database.store.dmpk_modelli_doc.bean.DmpkModelliDocGetdatixgendamodelloBean;
import it.eng.auriga.database.store.dmpk_repository_gui.bean.DmpkRepositoryGuiGetprotdapgwebBean;
import it.eng.auriga.database.store.dmpk_utility.bean.DmpkUtilityFinddoctype_jBean;
import it.eng.auriga.database.store.result.bean.StoreResultBean;
import it.eng.auriga.exception.StoreException;
import it.eng.auriga.module.business.beans.AurigaLoginBean;
import it.eng.auriga.ui.module.layout.server.archivio.datasource.bean.ArchivioBean;
import it.eng.auriga.ui.module.layout.server.archivio.datasource.bean.OperazioneMassivaArchivioBean;
import it.eng.auriga.ui.module.layout.server.attributiDinamici.datasource.bean.DocumentBean;
import it.eng.auriga.ui.module.layout.server.common.FirmaUtility;
import it.eng.auriga.ui.module.layout.server.common.SezioneCacheAttributiDinamici;
import it.eng.auriga.ui.module.layout.server.common.TipoIdBean;
import it.eng.auriga.ui.module.layout.server.invioMail.datasource.bean.AttachmentBean;
import it.eng.auriga.ui.module.layout.server.postaElettronica.datasource.ArchiviazioneEmailDataSource;
import it.eng.auriga.ui.module.layout.server.postaElettronica.datasource.ProtocolloUtility;
import it.eng.auriga.ui.module.layout.server.postaElettronica.datasource.bean.ArchiviazioneEmailBean;
import it.eng.auriga.ui.module.layout.server.postaElettronica.datasource.bean.PostaElettronicaBean;
import it.eng.auriga.ui.module.layout.server.postaElettronica.datasource.bean.StampaFileBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.AllegatoProtocolloBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.AltraViaProtBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.AltroRifBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.AssPreselMittBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.AssegnazioneBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.AttiRichiestiBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.ClassificazioneFascicoloBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.ContribuenteBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.DatiProtPGWebXmlBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.DestInvioBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.DestInvioCCBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.DestinatarioProtBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.DocCollegatoBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.DownloadDocsZipBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.FolderCustomBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.MezzoTrasmissioneDestinatarioBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.MittenteProtBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.OperazioneMassivaProtocollazioneBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.OpzioniTimbroDocBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.ProtocollazioneBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.SoggEsternoProtBean;
import it.eng.auriga.ui.module.layout.server.protocollazione.datasource.bean.TipoDocumentoBean;
import it.eng.auriga.ui.module.layout.server.timbra.OpzioniTimbroBean;
import it.eng.auriga.ui.module.layout.server.timbra.TimbraResultBean;
import it.eng.auriga.ui.module.layout.server.timbra.TimbraUtility;
import it.eng.auriga.ui.module.layout.shared.util.TipoModelloDoc;
import it.eng.auriga.ui.module.layout.shared.util.TipoRichiedente;
import it.eng.aurigamailbusiness.bean.EmailSentReferenceBean;
import it.eng.aurigamailbusiness.bean.LockBean;
import it.eng.aurigamailbusiness.bean.ResultBean;
import it.eng.aurigamailbusiness.bean.SenderBean;
import it.eng.aurigamailbusiness.bean.TEmailMgoBean;
import it.eng.aurigamailbusiness.bean.TRelEmailFolderBean;
import it.eng.client.AurigaMailService;
import it.eng.client.CheckService;
import it.eng.client.DmpkCoreDel_ud_doc_ver;
import it.eng.client.DmpkCoreFindfascinarchivio;
import it.eng.client.DmpkCoreFindud;
import it.eng.client.DmpkCoreUpddocud;
import it.eng.client.DmpkIntMgoEmailPreparaemailnotassinviocc;
import it.eng.client.DmpkLoadComboDmfn_load_combo;
import it.eng.client.DmpkModelliDocExtractvermodello;
import it.eng.client.DmpkModelliDocGetdatixgendamodello;
import it.eng.client.DmpkRepositoryGuiGetprotdapgweb;
import it.eng.client.DmpkUtilityFinddoctype_j;
import it.eng.client.GestioneDocumenti;
import it.eng.client.GestioneEmail;
import it.eng.client.RecuperoDocumenti;
import it.eng.client.RecuperoFile;
import it.eng.converter.DateConverter;
import it.eng.core.business.FileUtil;
import it.eng.core.business.TFilterFetch;
import it.eng.core.business.TPagingList;
import it.eng.document.NumeroColonna;
import it.eng.document.function.bean.AllegatiBean;
import it.eng.document.function.bean.AltreUbicazioniBean;
import it.eng.document.function.bean.AltreUoCoinvolteBean;
import it.eng.document.function.bean.AltriRiferimentiBean;
import it.eng.document.function.bean.AssegnatariBean;
import it.eng.document.function.bean.AttachAndPosizioneBean;
import it.eng.document.function.bean.AttachAndPosizioneCollectionBean;
import it.eng.document.function.bean.AttiRichiestiXMLBean;
import it.eng.document.function.bean.ClassificheFascicoliDocumentoBean;
import it.eng.document.function.bean.CreaModAttoInBean;
import it.eng.document.function.bean.CreaModDocumentoInBean;
import it.eng.document.function.bean.CreaModDocumentoOutBean;
import it.eng.document.function.bean.DestinatariBean;
import it.eng.document.function.bean.DistribuzioneBean;
import it.eng.document.function.bean.DocumentoCollegato;
import it.eng.document.function.bean.DocumentoXmlOutBean;
import it.eng.document.function.bean.EmailProvBean;
import it.eng.document.function.bean.FileExtractedIn;
import it.eng.document.function.bean.FileExtractedOut;
import it.eng.document.function.bean.FileInfoBean;
import it.eng.document.function.bean.FilePrimarioBean;
import it.eng.document.function.bean.Firmatario;
import it.eng.document.function.bean.Flag;
import it.eng.document.function.bean.FolderCustom;
import it.eng.document.function.bean.GenericFile;
import it.eng.document.function.bean.MailDocumentoIn;
import it.eng.document.function.bean.MittentiDocumentoBean;
import it.eng.document.function.bean.ProtocolloRicevuto;
import it.eng.document.function.bean.RebuildedFile;
import it.eng.document.function.bean.RecuperaDocumentoInBean;
import it.eng.document.function.bean.RecuperaDocumentoOutBean;
import it.eng.document.function.bean.RegistroEmergenza;
import it.eng.document.function.bean.SoggettoEsternoBean;
import it.eng.document.function.bean.TipoAssegnatario;
import it.eng.document.function.bean.TipoDestinatario;
import it.eng.document.function.bean.TipoFile;
import it.eng.document.function.bean.TipoMittente;
import it.eng.document.function.bean.TipoNumerazioneBean;
import it.eng.document.function.bean.TipoProtocollo;
import it.eng.document.function.bean.TipoProvenienza;
import it.eng.document.function.bean.VersionaDocumentoInBean;
import it.eng.document.function.bean.VersionaDocumentoOutBean;
import it.eng.jaxb.context.SingletonJAXBContext;
import it.eng.jaxb.variabili.Lista;
import it.eng.jaxb.variabili.Riga;
import it.eng.jaxb.variabili.Riga.Colonna;
import it.eng.jaxb.variabili.SezioneCache;
import it.eng.services.fileop.InfoFileUtility;
import it.eng.spring.utility.SpringAppContext;
import it.eng.utility.DocumentConfiguration;
import it.eng.utility.FormatiAmmessiUtil;
import it.eng.utility.MessageUtil;
import it.eng.utility.XmlUtility;
import it.eng.utility.module.config.StorageImplementation;
import it.eng.utility.storageutil.exception.StorageException;
import it.eng.utility.storageutil.util.StorageUtil;
import it.eng.utility.ui.module.core.server.bean.AdvancedCriteria;
import it.eng.utility.ui.module.core.server.bean.ExportBean;
import it.eng.utility.ui.module.core.server.bean.OrderByBean;
import it.eng.utility.ui.module.core.server.bean.PaginatorBean;
import it.eng.utility.ui.module.core.server.datasource.AbstractDataSource;
import it.eng.utility.ui.module.core.server.datasource.annotation.Datasource;
import it.eng.utility.ui.module.core.server.service.ErrorBean;
import it.eng.utility.ui.module.core.shared.message.MessageType;
import it.eng.utility.ui.module.layout.shared.bean.FileDaFirmareBean;
import it.eng.utility.ui.module.layout.shared.bean.OpzioniTimbroAttachEmail;
import it.eng.utility.ui.servlet.bean.MimeTypeFirmaBean;
import it.eng.utility.ui.user.AurigaUserUtil;
import it.eng.utility.ui.user.ParametriDBUtil;
import it.eng.utility.ui.user.UserUtil;
import it.eng.xml.XmlListaUtility;
import it.eng.xml.XmlUtilityDeserializer;
import it.eng.xml.XmlUtilitySerializer;

@Datasource(id = "ProtocolloDataSource")
public class ProtocolloDataSource extends AbstractDataSource<ProtocollazioneBean, ProtocollazioneBean> {

	private static final Logger logProtDS = Logger.getLogger(ProtocolloDataSource.class);

	public static final String _COD_ISTAT_ITALIA = "200";
	public static final String _NOME_STATO_ITALIA = "ITALIA";

	// public static final String _COD_ISTAT_MILANO = "015146";
	// public static final String _NOME_COMUNE_MILANO = "MILANO";

	public static int OK = 0;
	public static int SUPERATO_LIMITE = 1;
	public static int NESSUN_FILE = 2;

	public ProtocollazioneBean trasformaSecondarioInPrimario(ProtocollazioneBean bean) throws Exception {
		String index = getExtraparams().get("index");
		int indice = Integer.valueOf(index);
		// Recupero se è presente un primario
		AllegatoProtocolloBean lAllegatoProtocolloBeanPrimario = null;
		if (bean.getInfoFile() != null && StringUtils.isNotBlank(bean.getUriFilePrimario()) && StringUtils.isNotBlank(bean.getNomeFilePrimario())) {
			lAllegatoProtocolloBeanPrimario = new AllegatoProtocolloBean();
			lAllegatoProtocolloBeanPrimario.setNomeFileAllegato(bean.getNomeFilePrimario());
			lAllegatoProtocolloBeanPrimario.setUriFileAllegato(bean.getUriFilePrimario());
			lAllegatoProtocolloBeanPrimario.setRemoteUri(bean.getRemoteUriFilePrimario());
			lAllegatoProtocolloBeanPrimario.setIdAttachEmail(bean.getIdAttachEmailPrimario());
			lAllegatoProtocolloBeanPrimario.setInfoFile(bean.getInfoFile());
			lAllegatoProtocolloBeanPrimario.setFlgTimbraFilePostReg(bean.getFlgTimbraFilePostReg());
			lAllegatoProtocolloBeanPrimario.setFlgTimbratoFilePostReg(bean.getFlgTimbratoFilePostReg());
			lAllegatoProtocolloBeanPrimario.setOpzioniTimbro(bean.getOpzioniTimbro());
			lAllegatoProtocolloBeanPrimario.setIsChanged(true);
			lAllegatoProtocolloBeanPrimario.setFlgDatiSensibili(bean.getFlgDatiSensibili());
			// Vers. con omissis
			if(bean.getFilePrimarioOmissis() != null) {
				lAllegatoProtocolloBeanPrimario.setNomeFileOmissis(bean.getFilePrimarioOmissis().getNomeFile());
				lAllegatoProtocolloBeanPrimario.setUriFileOmissis(bean.getFilePrimarioOmissis().getUriFile());
				lAllegatoProtocolloBeanPrimario.setRemoteUriOmissis(bean.getFilePrimarioOmissis().getRemoteUri());
				lAllegatoProtocolloBeanPrimario.setInfoFileOmissis(bean.getFilePrimarioOmissis().getInfoFile());
				lAllegatoProtocolloBeanPrimario.setFlgTimbraFilePostRegOmissis(bean.getFilePrimarioOmissis().getFlgTimbraFilePostReg());
				lAllegatoProtocolloBeanPrimario.setFlgTimbratoFilePostRegOmissis(bean.getFlgTimbratoFilePostReg());
				lAllegatoProtocolloBeanPrimario.setOpzioniTimbroOmissis(bean.getFilePrimarioOmissis().getOpzioniTimbro());
				lAllegatoProtocolloBeanPrimario.setIsChangedOmissis(true);
			}
		}
		AllegatoProtocolloBean lAllegatoProtocolloBean = bean.getListaAllegati().get(indice);
		bean.setNomeFilePrimario(lAllegatoProtocolloBean.getNomeFileAllegato());
		bean.setUriFilePrimario(lAllegatoProtocolloBean.getUriFileAllegato());
		bean.setRemoteUriFilePrimario(lAllegatoProtocolloBean.getRemoteUri());
		bean.setIdAttachEmailPrimario(lAllegatoProtocolloBean.getIdAttachEmail());
		bean.setInfoFile(lAllegatoProtocolloBean.getInfoFile());
		bean.setFlgTimbraFilePostReg(lAllegatoProtocolloBean.getFlgTimbraFilePostReg());
		bean.setFlgTimbratoFilePostReg(lAllegatoProtocolloBean.getFlgTimbratoFilePostReg());
		bean.setOpzioniTimbro(lAllegatoProtocolloBean.getOpzioniTimbro());		
		bean.setIsDocPrimarioChanged(true);
		bean.setFlgDatiSensibili(lAllegatoProtocolloBean.getFlgDatiSensibili());
		// Vers. con omissis
		if(bean.getFilePrimarioOmissis() != null) {
			bean.getFilePrimarioOmissis().setNomeFile(lAllegatoProtocolloBean.getNomeFileOmissis());
			bean.getFilePrimarioOmissis().setUriFile(lAllegatoProtocolloBean.getUriFileOmissis());
			bean.getFilePrimarioOmissis().setRemoteUri(lAllegatoProtocolloBean.getRemoteUriOmissis());
			bean.getFilePrimarioOmissis().setInfoFile(lAllegatoProtocolloBean.getInfoFileOmissis());
			bean.getFilePrimarioOmissis().setFlgTimbraFilePostReg(lAllegatoProtocolloBean.getFlgTimbraFilePostRegOmissis());
			bean.getFilePrimarioOmissis().setFlgTimbratoFilePostReg(lAllegatoProtocolloBean.getFlgTimbratoFilePostReg());
			bean.getFilePrimarioOmissis().setOpzioniTimbro(lAllegatoProtocolloBean.getOpzioniTimbroOmissis());		
			bean.getFilePrimarioOmissis().setIsChanged(true);			
		}
		List<AllegatoProtocolloBean> lListAllegati = bean.getListaAllegati();
		if (lAllegatoProtocolloBeanPrimario != null)
			lListAllegati.set(indice, lAllegatoProtocolloBeanPrimario);
		else
			lListAllegati.remove(indice);
		bean.setListaAllegati(lListAllegati);
		return bean;
	}

	public ProtocollazioneBean trasformaPrimarioInSecondario(ProtocollazioneBean bean) throws Exception {
		AllegatoProtocolloBean lAllegatoProtocolloBean = new AllegatoProtocolloBean();
		lAllegatoProtocolloBean.setNomeFileAllegato(bean.getNomeFilePrimario());
		lAllegatoProtocolloBean.setUriFileAllegato(bean.getUriFilePrimario());
		lAllegatoProtocolloBean.setRemoteUri(bean.getRemoteUriFilePrimario());
		lAllegatoProtocolloBean.setIdAttachEmail(bean.getIdAttachEmailPrimario());
		lAllegatoProtocolloBean.setInfoFile(bean.getInfoFile());
		lAllegatoProtocolloBean.setFlgTimbraFilePostReg(bean.getFlgTimbraFilePostReg());
		lAllegatoProtocolloBean.setOpzioniTimbro(bean.getOpzioniTimbro());
		lAllegatoProtocolloBean.setFlgDatiSensibili(bean.getFlgDatiSensibili());
		// Vers. con omissis
		if(bean.getFilePrimarioOmissis() != null) {
			lAllegatoProtocolloBean.setNomeFileOmissis(bean.getFilePrimarioOmissis().getNomeFile());
			lAllegatoProtocolloBean.setUriFileOmissis(bean.getFilePrimarioOmissis().getUriFile());
			lAllegatoProtocolloBean.setRemoteUriOmissis(bean.getFilePrimarioOmissis().getRemoteUri());
			lAllegatoProtocolloBean.setInfoFileOmissis(bean.getFilePrimarioOmissis().getInfoFile());
			lAllegatoProtocolloBean.setFlgTimbraFilePostRegOmissis(bean.getFilePrimarioOmissis().getFlgTimbraFilePostReg());
			lAllegatoProtocolloBean.setOpzioniTimbroOmissis(bean.getFilePrimarioOmissis().getOpzioniTimbro());			
		}		
		List<AllegatoProtocolloBean> lListAllegati = bean.getListaAllegati() != null ? bean.getListaAllegati() : new ArrayList<AllegatoProtocolloBean>();
		lListAllegati.add(lAllegatoProtocolloBean);
		bean.setNomeFilePrimario(null);
		bean.setUriFilePrimario(null);
		bean.setRemoteUriFilePrimario(null);
		bean.setIdAttachEmailPrimario(null);
		bean.setInfoFile(null);
		bean.setFlgTimbraFilePostReg(false);
		bean.setOpzioniTimbro(null);
		bean.setFlgDatiSensibili(false);
		// Vers. con omissis
		if(bean.getFilePrimarioOmissis() != null) {
			bean.getFilePrimarioOmissis().setNomeFile(null);
			bean.getFilePrimarioOmissis().setUriFile(null);
			bean.getFilePrimarioOmissis().setRemoteUri(null);
			bean.getFilePrimarioOmissis().setInfoFile(null);
			bean.getFilePrimarioOmissis().setFlgTimbraFilePostReg(false);
			bean.getFilePrimarioOmissis().setOpzioniTimbro(null);
		}
		bean.setListaAllegati(lListAllegati);
		return bean;
	}

	@Override
	public ProtocollazioneBean get(ProtocollazioneBean bean) throws Exception {
		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());
		String idProcess = getExtraparams().get("idProcess");
		String taskName = getExtraparams().get("taskName");
		RecuperaDocumentoInBean lRecuperaDocumentoInBean = new RecuperaDocumentoInBean();
		lRecuperaDocumentoInBean.setIdUd(bean.getIdUd());
		lRecuperaDocumentoInBean.setFlgSoloAbilAzioni(getExtraparams().get("flgSoloAbilAzioni"));
		lRecuperaDocumentoInBean.setTsAnnDati(getExtraparams().get("tsAnnDati"));
		lRecuperaDocumentoInBean.setIdProcess(StringUtils.isNotBlank(idProcess) ? new BigDecimal(idProcess) : null);
		lRecuperaDocumentoInBean.setTaskName(StringUtils.isNotBlank(taskName) ? taskName : "#NONE");
		RecuperoDocumenti lRecuperoDocumenti = new RecuperoDocumenti();
		RecuperaDocumentoOutBean lRecuperaDocumentoOutBean = lRecuperoDocumenti.loaddocumento(getLocale(), lAurigaLoginBean, lRecuperaDocumentoInBean);
		if (StringUtils.isNotBlank(lRecuperaDocumentoOutBean.getDefaultMessage())) {
			throw new StoreException(lRecuperaDocumentoOutBean.getDefaultMessage());
		}
		DocumentoXmlOutBean lDocumentoXmlOutBean = lRecuperaDocumentoOutBean.getDocumento();
		
		ProtocolloUtility lProtocolloUtility = new ProtocolloUtility(getSession());
		ProtocollazioneBean lProtocollazioneBean = lProtocolloUtility.getProtocolloFromDocumentoXml(lDocumentoXmlOutBean, getExtraparams());
		lProtocollazioneBean.setIdUd(bean.getIdUd());
		if(lProtocollazioneBean.getFlgPresentiAssPreselMitt() != null && lProtocollazioneBean.getFlgPresentiAssPreselMitt() && bean.getIdUd() != null) {			
			DmpkLoadComboDmfn_load_comboBean lDmpkLoadComboDmfn_load_comboBean = new DmpkLoadComboDmfn_load_comboBean();			
			DmpkLoadComboDmfn_load_combo lDmpkLoadComboDmfn_load_combo = new DmpkLoadComboDmfn_load_combo();
			lDmpkLoadComboDmfn_load_comboBean.setTipocomboin("ASS_PRESEL_MITT");
			lDmpkLoadComboDmfn_load_comboBean.setAltriparametriin("ID_UD|*|" + String.valueOf(bean.getIdUd().longValue()));				
			StoreResultBean<DmpkLoadComboDmfn_load_comboBean> lStoreResultBean =  lDmpkLoadComboDmfn_load_combo.execute(getLocale(), AurigaUserUtil.getLoginInfo(getSession()), lDmpkLoadComboDmfn_load_comboBean);			
			lProtocollazioneBean.setListaAssPreselMitt(XmlListaUtility.recuperaLista(lStoreResultBean.getResultBean().getListaxmlout(), AssPreselMittBean.class));				
		} 
		lProtocollazioneBean.setIdEmailArrivo(lDocumentoXmlOutBean.getIdEmailArrivo());
		lProtocollazioneBean.setEmailArrivoInteroperabile(lDocumentoXmlOutBean.getEmailArrivoInteroperabile());
		lProtocollazioneBean.setEmailInviataFlgPEC(lDocumentoXmlOutBean.getEmailInviataFlgPEC());
		lProtocollazioneBean.setEmailInviataFlgPEO(lDocumentoXmlOutBean.getEmailInviataFlgPEO());
		lProtocollazioneBean.setAbilStampaEtichetta(lDocumentoXmlOutBean.getAbilStampaEtichetta());
		return lProtocollazioneBean;
	}

	/**
	 * Reestituisce una lista di ProtocollazioneBean, dove tutti i file allegati sono delle copie salvate nella cartella temporanea
	 *
	 * @param bean
	 * @return
	 * @throws Exception
	 */
	public OperazioneMassivaProtocollazioneBean getWithCopiedFiles(OperazioneMassivaProtocollazioneBean bean) throws Exception {
		// Ciclo sui bean
		List<ProtocollazioneBean> copiedFileBeanList = new ArrayList<ProtocollazioneBean>();
		String elencoSegnatureInError = "";
		for (ProtocollazioneBean protocollazioneBean : bean.getListaRecord()) {
			// Richiamo il datasource per l'estrazione del ProtocollazioneBean
			ProtocollazioneBean copiedFileBean = get(protocollazioneBean);
			try {
				// Per ogni file ed allegato creo la copia
				// Copio il file primario
				String uriFilePrimario = copiedFileBean.getUriFilePrimario();
				if (StringUtils.isNotBlank(uriFilePrimario)) {
					// Estraggo l'InputStream
					InputStream filePrimarioInputStream = StorageImplementation.getStorage().extract(uriFilePrimario);
					// Creo la copia del file primario
					String uriPrimarioCopiato = StorageImplementation.getStorage().storeStream(filePrimarioInputStream);
					// Setto l'uri del file primario con l'uri della copia
					copiedFileBean.setUriFilePrimario(uriPrimarioCopiato);
				}
				// Copio gli allegati
				if (copiedFileBean.getListaAllegati() != null) {
					for (AllegatoProtocolloBean allegatoProtocolloBean : copiedFileBean.getListaAllegati()) {
						String uriFileAllegato = allegatoProtocolloBean.getUriFileAllegato();
						if (StringUtils.isNotBlank(uriFileAllegato)) {
							// Estraggo l'InputStream
							InputStream fileAllegatoInputStream = StorageImplementation.getStorage().extract(uriFileAllegato);
							// Creo la copia del file allegato
							String uriAllegatoCopiato = StorageImplementation.getStorage().storeStream(fileAllegatoInputStream);
							// Setto l'uri del file allegato con l'uri della
							// copia
							allegatoProtocolloBean.setUriFileAllegato(uriAllegatoCopiato);
						}
					}
				}
				copiedFileBeanList.add(copiedFileBean);
			} catch (Exception e) {
				Log.error("Errore nell'importazione dei file. IdUd =  " + protocollazioneBean.getIdUd(), e);
				elencoSegnatureInError += (elencoSegnatureInError.length() == 0) ? (copiedFileBean.getSegnatura()) : (", " + copiedFileBean.getSegnatura());
			}
		}
		OperazioneMassivaProtocollazioneBean result = new OperazioneMassivaProtocollazioneBean();
		HashMap errorMap = new HashMap();
		errorMap.put("segnatureInError", elencoSegnatureInError);
		result.setErrorMessages(errorMap);
		result.getErrorMessages().put("segnatureInError", elencoSegnatureInError);
		result.setListaRecord(copiedFileBeanList);
		return result;
	}

	@Override
	public ProtocollazioneBean add(ProtocollazioneBean bean) throws Exception {

		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());

		boolean isRepertorio = getExtraparams().get("isRepertorio") != null && "true".equals(getExtraparams().get("isRepertorio"));
		boolean isRegistrazioneFattura = getExtraparams().get("isRegistrazioneFattura") != null
				&& "true".equals(getExtraparams().get("isRegistrazioneFattura"));
		boolean isBozza = getExtraparams().get("isBozza") != null && "true".equals(getExtraparams().get("isBozza"));
		boolean isIstanza = getExtraparams().get("isIstanza") != null && "true".equals(getExtraparams().get("isIstanza"));
		boolean isRichiestaAccessoAtti = getExtraparams().get("isRichiestaAccessoAtti") != null && "true".equals(getExtraparams().get("isRichiestaAccessoAtti"));

		FormatiAmmessiUtil lFormatiAmmessiUtil = new FormatiAmmessiUtil();

		ArrayList<String> idUdDaCollegareList = new ArrayList<String>();

		boolean formatiNonAmmessi = false;
		boolean primarioNonAmmesso = false;
		List<String> fileConFormatiNonAmmessi = new ArrayList<String>();

		if (StringUtils.isNotBlank(bean.getUriFilePrimario()) && StringUtils.isNotBlank(bean.getNomeFilePrimario())) {
			if (bean.getInfoFile() != null && !lFormatiAmmessiUtil.isFormatiAmmessi(getSession(), bean.getInfoFile())) {
				primarioNonAmmesso = true;
			}		
		}
		if ((bean.getFlgDatiSensibili() != null && bean.getFlgDatiSensibili()) && bean.getFilePrimarioOmissis() != null && StringUtils.isNotBlank(bean.getFilePrimarioOmissis().getUriFile()) && StringUtils.isNotBlank(bean.getFilePrimarioOmissis().getNomeFile())) {
			if (bean.getFilePrimarioOmissis().getInfoFile() != null && !lFormatiAmmessiUtil.isFormatiAmmessi(getSession(), bean.getFilePrimarioOmissis().getInfoFile())) {
				primarioNonAmmesso = true;
			}
		}
		if (bean.getListaAllegati() != null) {
			for (AllegatoProtocolloBean allegato : bean.getListaAllegati()) {
				if (StringUtils.isNotBlank(allegato.getUriFileAllegato()) && StringUtils.isNotBlank(allegato.getNomeFileAllegato())) {
					if (allegato.getInfoFile() != null && !lFormatiAmmessiUtil.isFormatiAmmessi(getSession(), allegato.getInfoFile())) {
						formatiNonAmmessi = true;
						fileConFormatiNonAmmessi.add(allegato.getNomeFileAllegato());
					}
				}
				if ((allegato.getFlgDatiSensibili() != null && allegato.getFlgDatiSensibili()) &&  StringUtils.isNotBlank(allegato.getUriFileOmissis()) && StringUtils.isNotBlank(allegato.getNomeFileOmissis())) {
					if (allegato.getInfoFileOmissis() != null && !lFormatiAmmessiUtil.isFormatiAmmessi(getSession(), allegato.getInfoFileOmissis())) {
						formatiNonAmmessi = true;
						fileConFormatiNonAmmessi.add(allegato.getNomeFileOmissis());
					}
				}
			}
		}
		if (primarioNonAmmesso || formatiNonAmmessi) {
			StringBuilder msg = new StringBuilder();
			if (primarioNonAmmesso && !formatiNonAmmessi) {
				msg.append("Attenzione! Il file primario risulta in un formato non ammesso: Impossibile protocollare.");
			} else if (primarioNonAmmesso && formatiNonAmmessi) {
				msg.append("Attenzione! Il file primario ");
				if (fileConFormatiNonAmmessi.size() == 1)
					msg.append("e l'allegato " + fileConFormatiNonAmmessi.get(0));
				else {
					msg.append("e gli allegati ");
					boolean first = true;
					for (String lString : fileConFormatiNonAmmessi) {
						if (first)
							first = !first;
						else
							msg.append(", ");
						msg.append(lString);
					}
				}
				msg.append(" risultano in un formato non ammesso: Impossibile protocollare.");
			} else if (!primarioNonAmmesso && formatiNonAmmessi) {
				if (fileConFormatiNonAmmessi.size() == 1)
					msg.append("Attenzione! L'allegato " + fileConFormatiNonAmmessi.get(0) + " risulta in un formato non ammesso: Impossibile protocollare.");
				else {
					msg.append("Attenzione! Gli allegati ");
					boolean first = true;
					for (String lString : fileConFormatiNonAmmessi) {
						if (first)
							first = !first;
						else
							msg.append(" - ");
						msg.append(lString);
					}
					msg.append(" risultano in un formato non ammesso: Impossibile protocollare.");
				}
			}
			throw new StoreException(msg.toString());
		}

		DocumentConfiguration lDocumentConfiguration = (DocumentConfiguration) SpringAppContext.getContext().getBean("DocumentConfiguration");

		CreaModDocumentoInBean lCreaDocumentoInBean = new CreaModDocumentoInBean();
		// salvo il tipo di registrazione (#FlgTipoProv) : entrata (E), in
		// uscita (U) o interna/tra uffici (I)
		if (bean.getFlgTipoProv() != null/* && !isBozza*/) {
			TipoProvenienza lTipoProvenienza = null;
			if (bean.getFlgTipoProv().equalsIgnoreCase("E")) {
				lTipoProvenienza = TipoProvenienza.ENTRATA;
			} else if (bean.getFlgTipoProv().equalsIgnoreCase("U")) {
				lTipoProvenienza = TipoProvenienza.USCITA;
			} else if (bean.getFlgTipoProv().equalsIgnoreCase("I")) {
				lTipoProvenienza = TipoProvenienza.INTERNA;
			}
			lCreaDocumentoInBean.setFlgTipoProv(lTipoProvenienza);
		}

		// Salvo la TIPOLOGIA di NUMERAZIONE (SIGLA e CATEGORIA)
		TipoNumerazioneBean lTipoNumerazioneBean = new TipoNumerazioneBean();
		TipoNumerazioneBean lTipoProtocolloGenerale = null;
		TipoNumerazioneBean lTipoAltraNumerazioneBean = null;
		
		boolean skipNumerazioniDaDare = !isPropostaAtto() && !isRepertorio && !isRegistrazioneFattura && !isIstanza && isBozza; // se è una bozza

		// Se e' una RICHIESTA ACCESSO ATTI allora devo saltare le numerazioni da dare solamente se il richiedente è esterno
		if (isRichiestaAccessoAtti) {
			skipNumerazioniDaDare = !isRichiestaAccessoAttiRichiedenteInterno(bean);
		}
				
		if (!skipNumerazioniDaDare) {			
		
			// Proposta atto
			if (isPropostaAtto()) {
				lTipoNumerazioneBean.setSigla(bean.getSiglaProtocollo());
				lTipoNumerazioneBean.setCategoria(null);
			}
			// Repertorio
			else if (isRepertorio || (bean.getFlgAncheRepertorio() != null && bean.getFlgAncheRepertorio())) {
				bean.setIsRepertorio(true);
				lTipoNumerazioneBean.setSigla(bean.getRepertorio());
				int annoCorrente = Integer.parseInt(new SimpleDateFormat("yyyy").format(new Date()));
				int annoPassato = annoCorrente - 1;
				lTipoNumerazioneBean.setAnno(bean.getAnnoPassato() != null && bean.getAnnoPassato() ? String.valueOf(annoPassato) : String.valueOf(annoCorrente));
				lTipoNumerazioneBean.setCategoria("R");
				lTipoProtocolloGenerale = creaTipoProtocolloGenerale(bean);				
			}
			// Registrazione fattura
			else if (isRegistrazioneFattura) {
				bean.setIsRegistroFatture(true);
				lTipoNumerazioneBean.setSigla("FATTURE");
				lTipoNumerazioneBean.setCategoria("I");
				lTipoProtocolloGenerale = creaTipoProtocolloGenerale(bean);				
			}
			// Registrazione ENTRATA o USCITA
			else if (bean.getFlgTipoProv() != null && (bean.getFlgTipoProv().equalsIgnoreCase("E") || bean.getFlgTipoProv().equalsIgnoreCase("U"))) {
//				if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_INT_PGWEB")) {
//					lTipoNumerazioneBean.setSigla("PGWEB");
//					lTipoNumerazioneBean.setCategoria("I");
//				} else {
					lTipoNumerazioneBean.setSigla(null);
					lTipoNumerazioneBean.setCategoria("PG");
//				}
				lTipoAltraNumerazioneBean = creaTipoAltraNumerazione(bean);					
			}
			// Registrazione INTERNA/TRA UFFICI
			else if (bean.getFlgTipoProv() != null && bean.getFlgTipoProv().equalsIgnoreCase("I")) {
				if(ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_REGISTRO_PG_X_PROT_INTERNA")) {
					lTipoNumerazioneBean.setSigla(null);
					lTipoNumerazioneBean.setCategoria("PG");
				} else {
					lTipoNumerazioneBean.setSigla("P.I.");
					lTipoNumerazioneBean.setCategoria("I");
				}
				lTipoAltraNumerazioneBean = creaTipoAltraNumerazione(bean);									
			}
			// Registrazione ISTANZA CED/AUTOTUTELA
			else if (isIstanza) {
				lTipoNumerazioneBean.setSigla("ISTANZA");
				lTipoNumerazioneBean.setCategoria(null);
			}
			// Richiesta accesso atti con richiedente interno
			else if (isRichiestaAccessoAtti) {
				lTipoNumerazioneBean.setSigla("RAAI");
				lTipoNumerazioneBean.setCategoria("R");
			}
			
			lTipoNumerazioneBean.setIdUo(StringUtils.isNotBlank(bean.getUoProtocollante()) ? bean.getUoProtocollante().substring(2) : null);
			
			List<TipoNumerazioneBean> listaTipiNumerazioni = new ArrayList<TipoNumerazioneBean>();
			listaTipiNumerazioni.add(lTipoNumerazioneBean);
			if (lTipoProtocolloGenerale != null) {
				listaTipiNumerazioni.add(lTipoProtocolloGenerale);			
			}
			if(lTipoAltraNumerazioneBean != null) {
				listaTipiNumerazioni.add(lTipoAltraNumerazioneBean);			
			}			
			lCreaDocumentoInBean.setTipoNumerazioni(listaTipiNumerazioni);			
		} 
		else if (StringUtils.isNotBlank(bean.getUoProtocollante())) {
			
			//Se è una BOZZA passo comunque l'UO protocollante
			lTipoNumerazioneBean.setIdUo(bean.getUoProtocollante().substring(2));
			
			List<TipoNumerazioneBean> listaTipiNumerazioni = new ArrayList<TipoNumerazioneBean>();
			listaTipiNumerazioni.add(lTipoNumerazioneBean);
			lCreaDocumentoInBean.setTipoNumerazioni(listaTipiNumerazioni);	
		}

		// Salvo l'OGGETTO
		lCreaDocumentoInBean.setOggetto(bean.getOggetto());
		// Verifico se sono in una richiesta accesso atti con richiedente interno
		if (!isRichiestaAccessoAttiRichiedenteInterno(bean)){
			// Salvo i MITTENTI
			salvaMittenti(bean, lCreaDocumentoInBean);
		}else {
			// Salvo i RICHIEDENTI INTERNI
			salvaRichiedentiInterni(bean, lCreaDocumentoInBean);
		}
		// Salvo i destinatari
		salvaDestinatari(bean, lCreaDocumentoInBean);
		// Salvo gli assegnatari dal tab assegnazione
		salvaAssegnatari(bean, lCreaDocumentoInBean);
		// Salvo la lista degli invii per conoscenza
		salvaInvioDestCC(bean, lCreaDocumentoInBean);
		// Salvo la lista delle altre U.O. coinvolte
		salvaAltreUoCoinvolte(bean, lCreaDocumentoInBean);
		
		// Salvo la lista dei documenti collegati
		salvaDocumentiCollegati(bean, lCreaDocumentoInBean);
		// Salvo la lista degli altri riferimenti
		salvaAltriRiferimenti(bean, lCreaDocumentoInBean);
		
		// Salvo COD STATO DETT
		lCreaDocumentoInBean.setCodStatoDett(bean.getCodStatoDett());
		
		// Salvo la CLASSIFICA e FASCICOLAZIONE
		List<ClassificheFascicoliDocumentoBean> lListClassificheFascicoli = new ArrayList<ClassificheFascicoliDocumentoBean>();
		if (bean.getListaClassFasc() != null) {
			for (ClassificazioneFascicoloBean lClassificazioneFascicoloBean : bean.getListaClassFasc()) {
				ClassificheFascicoliDocumentoBean lClassificheFascicoliDocumentoBean = new ClassificheFascicoliDocumentoBean();
				lClassificheFascicoliDocumentoBean.setIdClassifica(lClassificazioneFascicoloBean.getIdClassifica());
				lClassificheFascicoliDocumentoBean.setIdFolderFascicolo(lClassificazioneFascicoloBean.getIdFolderFascicolo());
				lClassificheFascicoliDocumentoBean.setAnnoFascicolo(lClassificazioneFascicoloBean.getAnnoFascicolo());
				lClassificheFascicoliDocumentoBean.setNroFascicolo(lClassificazioneFascicoloBean.getNroFascicolo());
				lClassificheFascicoliDocumentoBean.setNroSottofascicolo(lClassificazioneFascicoloBean.getNroSottofascicolo());
				lClassificheFascicoliDocumentoBean.setNroInserto(lClassificazioneFascicoloBean.getNroInserto());
				
//				if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_INT_PGWEB")) {
//					lClassificheFascicoliDocumentoBean.setProvCIClassif(lClassificazioneFascicoloBean.getProvCIClassif());
//					if (StringUtils.isBlank(lClassificheFascicoliDocumentoBean.getProvCIClassif())) {
//						throw new Exception("Manca l'identificativo della classifica su PG@WEB");
//					}
//				}
				if (lClassificazioneFascicoloBean.getFlgCapofila() != null && lClassificazioneFascicoloBean.getFlgCapofila()) {
					lClassificheFascicoliDocumentoBean.setTipoRelazione("CPF");
				}
				lListClassificheFascicoli.add(lClassificheFascicoliDocumentoBean);
			}
		}
		lCreaDocumentoInBean.setClassifichefascicoli(lListClassificheFascicoli);

		if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_FOLDER_CUSTOM") && !isPropostaAttoMilano()) {
			// Salvo i FOLDER CUSTOM
			List<FolderCustom> lListFolderCustom = new ArrayList<FolderCustom>();
			if (bean.getListaFolderCustom() != null) {
				for (FolderCustomBean lFolderCustomBean : bean.getListaFolderCustom()) {
					FolderCustom lFolderCustom = new FolderCustom();
					lFolderCustom.setId(lFolderCustomBean.getId());
					// lFolderCustom.setPath(lFolderCustomBean.getPath());
					if (lFolderCustomBean.getFlgCapofila() != null && lFolderCustomBean.getFlgCapofila()) {
						lFolderCustom.setTipoRelazione("CPF");
					}
					lListFolderCustom.add(lFolderCustom);
				}
			}
			lCreaDocumentoInBean.setFolderCustom(lListFolderCustom);
		}

		// Grado di risercatezza
		lCreaDocumentoInBean.setLivelloRiservatezza(bean.getLivelloRiservatezza() != null ? bean.getLivelloRiservatezza().intValue() + "" : null);
		// Data termine riservatezza
		if (bean.getLivelloRiservatezza() != null)
			lCreaDocumentoInBean.setTermineRiservatezza(bean.getDataRiservatezza());
		// Priorità
		lCreaDocumentoInBean.setPriorita(bean.getPrioritaRiservatezza());

		// Documento riferimento
		DocumentoCollegato lDocumentoCollegato = new DocumentoCollegato();
		lDocumentoCollegato.setAnno(StringUtils.isNotBlank(bean.getAnnoDocRiferimento()) ? Integer.valueOf(bean.getAnnoDocRiferimento()) : null);
		lDocumentoCollegato.setNumero(bean.getNroDocRiferimento() != null ? bean.getNroDocRiferimento().intValue() : null);

		for (TipoProtocollo lTipoProtocollo : TipoProtocollo.values()) {
			if (lTipoProtocollo.toString().equals(bean.getSiglaDocRiferimento())) {
				lDocumentoCollegato.setTipo(lTipoProtocollo);
				if (lTipoProtocollo == TipoProtocollo.PROTOCOLLO_INTERNO) {
					lDocumentoCollegato.setSiglaRegistro("P.I.");
				}
			}
		}
		if (!(lDocumentoCollegato.getAnno() == null && lDocumentoCollegato.getNumero() == null && lDocumentoCollegato.getSiglaRegistro() == null))
			addDocumentoCollegato(lCreaDocumentoInBean, Arrays.asList(new DocumentoCollegato[] { lDocumentoCollegato }));

		// Collocazione fisica
		if (StringUtils.isNotBlank(bean.getNomeCollocazioneFisica())) {
			lCreaDocumentoInBean.setDescrizioneCollocazione(bean.getNomeCollocazioneFisica());
		}
		if (StringUtils.isNotBlank(bean.getIdToponimo())) {
			lCreaDocumentoInBean.setIdTopografico(bean.getIdToponimo());
		}

		lCreaDocumentoInBean.setFlgNoPubblPrimario(bean.getFlgNoPubblPrimario() != null && bean.getFlgNoPubblPrimario() ? "1" : null);
		lCreaDocumentoInBean.setFlgDatiSensibiliPrimario(bean.getFlgDatiSensibili() != null && bean.getFlgDatiSensibili() ? "1" : null);

		// Registrazioni da dare
		List<RegistroEmergenza> lListRegistrazioniDaDare = new ArrayList<RegistroEmergenza>();
		if (bean.getDataRegEmergenza() != null && bean.getNroRegEmergenza() != null && StringUtils.isNotBlank(bean.getRifRegEmergenza())) {
			// Registro emergenza
			RegistroEmergenza lRegistroEmergenza = new RegistroEmergenza();
			lRegistroEmergenza.setDataRegistrazione(bean.getDataRegEmergenza());
			lRegistroEmergenza.setNro(bean.getNroRegEmergenza().intValue() + "");
			lRegistroEmergenza.setRegistro(bean.getRifRegEmergenza());
			lRegistroEmergenza.setIdUserReg(bean.getIdUserRegEmergenza());
			lRegistroEmergenza.setIdUoReg(bean.getIdUoRegEmergenza());
			lListRegistrazioniDaDare.add(lRegistroEmergenza);
		}		
		if (!isRichiestaAccessoAttiRichiedenteInterno(bean) && StringUtils.isNotBlank(bean.getNroProtocolloPregresso()) && (StringUtils.isNotBlank(bean.getAnnoProtocolloPregresso()) || (bean.getDataProtocolloPregresso() != null))) {
			//Registrazione protocollo PG@Web
			RegistroEmergenza lRegistroEmergenza = new RegistroEmergenza();
			// Inserisco l'id dell'utente loggato o del delegato
			AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());
			if (loginBean != null){
				lRegistroEmergenza.setIdUserReg(StringUtils.isNotBlank(loginBean.getIdUserLavoro()) ? loginBean.getIdUserLavoro() : loginBean.getIdUser() + "");
			}
			lRegistroEmergenza.setDataRegistrazione(bean.getDataProtocolloPregresso());
			lRegistroEmergenza.setFisso("PG");
			lRegistroEmergenza.setRegistro(null);
			lRegistroEmergenza.setAnno(bean.getAnnoProtocolloPregresso());
			lRegistroEmergenza.setNro(bean.getNroProtocolloPregresso());
			lListRegistrazioniDaDare.add(lRegistroEmergenza);			
		}
		if (StringUtils.isNotBlank(bean.getNumeroPraticaSuSistUfficioRichiedente()) && StringUtils.isNotBlank(bean.getAnnoPraticaSuSistUfficioRichiedente())) {
			// Salvo dati pratica su ufficio richiedente
			RegistroEmergenza lRegistroEmergenza = new RegistroEmergenza();
			lRegistroEmergenza.setFisso("A");
			lRegistroEmergenza.setRegistro(bean.getSiglaPraticaSuSistUfficioRichiedente());
			lRegistroEmergenza.setAnno(bean.getAnnoPraticaSuSistUfficioRichiedente());
			lRegistroEmergenza.setNro(bean.getNumeroPraticaSuSistUfficioRichiedente());
			lListRegistrazioniDaDare.add(lRegistroEmergenza);
		}	
		
		lCreaDocumentoInBean.setRegistroEmergenza(lListRegistrazioniDaDare);

		// Altri dati
		lCreaDocumentoInBean.setNote(bean.getNote());
		lCreaDocumentoInBean.setDataStesura(bean.getDataDocumento());
		lCreaDocumentoInBean.setTipoDocumento(bean.getTipoDocumento());

		// Solo prot entrata - prot ricevuto
		if (bean.getFlgTipoProv() != null && bean.getFlgTipoProv().equalsIgnoreCase("E")) {
			ProtocolloRicevuto lProtocolloRicevuto = new ProtocolloRicevuto();
			if (StringUtils.isNotBlank(bean.getNroProtRicevuto()) && (StringUtils.isNotBlank(bean.getAnnoProtRicevuto()) || bean.getDataProtRicevuto() != null)) {
				lProtocolloRicevuto.setOrigine(bean.getRifOrigineProtRicevuto());
				lProtocolloRicevuto.setNumero(bean.getNroProtRicevuto());
				lProtocolloRicevuto.setAnno(bean.getAnnoProtRicevuto());
				lProtocolloRicevuto.setData(bean.getDataProtRicevuto());
			}
			lCreaDocumentoInBean.setProtocolloRicevuto(lProtocolloRicevuto);
			lCreaDocumentoInBean.setDataArrivo(bean.getDataEOraArrivo());
			// Mezzo trasmissione
			lCreaDocumentoInBean.setMessoTrasmissione(bean.getMezzoTrasmissione());
			if(bean.getMezzoTrasmissione() != null && "R".equals(bean.getMezzoTrasmissione())) {
				if (bean.getNroRaccomandata() != null) {
					lCreaDocumentoInBean.setNroRaccomandata(bean.getNroRaccomandata());
				}
				if (bean.getDataRaccomandata() != null) {
					lCreaDocumentoInBean.setDtRaccomandata(bean.getDataRaccomandata());
				}
				if (StringUtils.isNotBlank(bean.getNroListaRaccomandata())) {
					lCreaDocumentoInBean.setNroListaRaccomandata(bean.getNroListaRaccomandata());
				}
			}
		} else if (bean.getDataEOraRicezione() != null) {
			// Salvo al data e ora ricezione delle istanze CED/AUTOTUTELA
			lCreaDocumentoInBean.setDataArrivo(bean.getDataEOraRicezione());
		}
		
		if (isAttivoProtocolloWizard(bean)) {
			lCreaDocumentoInBean.setFlgSkipControlliCartaceo(bean.getFlgSkipControlliCartaceo() != null && bean.getFlgSkipControlliCartaceo() ? "1" : null);
			if (StringUtils.isNotBlank(bean.getSupportoOriginale())) {
				lCreaDocumentoInBean.setSupportoOriginale(bean.getSupportoOriginale());	
			}
		}

		// Salvo i file ALLEGATI
		AttachAndPosizioneCollectionBean lAttachAndPosizioneCollectionBean = new AttachAndPosizioneCollectionBean();
		List<AttachAndPosizioneBean> list = new ArrayList<AttachAndPosizioneBean>();

		AllegatiBean lAllegatiBean = null;
		if (bean.getListaAllegati() != null) {			
			List<String> descrizione = new ArrayList<String>();
			List<Integer> docType = new ArrayList<Integer>();
			List<File> fileAllegati = new ArrayList<File>();
			List<Boolean> isNull = new ArrayList<Boolean>();
			List<String> displayFilename = new ArrayList<String>();
			List<FileInfoBean> info = new ArrayList<FileInfoBean>();
			List<Boolean> flgParteDispositivo = new ArrayList<Boolean>();
			List<String> idTask = new ArrayList<String>();
			List<Boolean> flgNoPubbl = new ArrayList<Boolean>();
			List<Boolean> flgDatiSensibili = new ArrayList<Boolean>();
			List<String> idUdFrom = new ArrayList<String>();			
			// Vers. con omissis
			List<File> fileAllegatiOmissis = new ArrayList<File>();
			List<Boolean> isNullOmissis = new ArrayList<Boolean>();
			List<String> displayFilenameOmissis = new ArrayList<String>();
			List<FileInfoBean> infoOmissis = new ArrayList<FileInfoBean>();			
			int i = 1;			
			for (AllegatoProtocolloBean allegato : bean.getListaAllegati()) {
				descrizione.add(allegato.getDescrizioneFileAllegato());
				docType.add(StringUtils.isNotBlank(allegato.getListaTipiFileAllegato()) ? Integer.valueOf(allegato.getListaTipiFileAllegato()) : null);
				displayFilename.add(allegato.getNomeFileAllegato());
				flgParteDispositivo.add(allegato.getFlgParteDispositivo());
				idTask.add(getExtraparams().get("idTaskCorrente"));
				flgNoPubbl.add(allegato.getFlgNoPubblAllegato());				
				flgDatiSensibili.add(allegato.getFlgDatiSensibili());
				idUdFrom.add(allegato.getIdUdAppartenenza());
				if (StringUtils.isNotBlank(allegato.getUriFileAllegato())) {
					isNull.add(false);
					File lFile = null;
					if (allegato.getRemoteUri()) {
						// Il file è esterno
						RecuperoFile lRecuperoFile = new RecuperoFile();
						FileExtractedIn lFileExtractedIn = new FileExtractedIn();
						lFileExtractedIn.setUri(allegato.getUriFileAllegato());
						FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
						lFile = out.getExtracted();
					} else {
						// File locale
						lFile = StorageImplementation.getStorage().extractFile(allegato.getUriFileAllegato());
					}
					fileAllegati.add(lFile);
					MimeTypeFirmaBean lMimeTypeFirmaBean = allegato.getInfoFile();
					if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
						lMimeTypeFirmaBean = new InfoFileUtility().getInfoFromFile(lFile.toURI().toString(), allegato.getNomeFileAllegato(), false, null);
						if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
							throw new Exception("Si è verificato un errore durante il controllo del file allegato " + allegato.getNomeFileAllegato());
						}
					}
					FileInfoBean lFileInfoBean = new FileInfoBean();
					lFileInfoBean.setTipo(TipoFile.ALLEGATO);
					GenericFile lGenericFile = new GenericFile();
					if (lMimeTypeFirmaBean.getFirmatari() != null) {
						List<Firmatario> lList = new ArrayList<Firmatario>();
						for (String lString : lMimeTypeFirmaBean.getFirmatari()) {
							Firmatario lFirmatario = new Firmatario();
							lFirmatario.setCommonName(lString);
							lList.add(lFirmatario);
						}
						lGenericFile.setFirmatari(lList);
						lGenericFile.setFirmato(Flag.SETTED);
					}
					lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
					lGenericFile.setDisplayFilename(allegato.getNomeFileAllegato());
					lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
					lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
					lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
					if (lMimeTypeFirmaBean.isDaScansione()) {
						lGenericFile.setDaScansione(Flag.SETTED);
						lGenericFile.setDataScansione(new Date());
						lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
					}
					lFileInfoBean.setPosizione(i);
					lFileInfoBean.setAllegatoRiferimento(lGenericFile);
					info.add(lFileInfoBean);
				} else {
					info.add(new FileInfoBean());
					isNull.add(true);
				}
				//TODO Vers. con omissis
				if ((allegato.getFlgDatiSensibili() != null && allegato.getFlgDatiSensibili()) && StringUtils.isNotBlank(allegato.getUriFileOmissis())) {
					isNullOmissis.add(false);
					File lFileAllegatoOmissis = null;
					if (allegato.getRemoteUriOmissis()) {
						// Il file è esterno
						RecuperoFile lRecuperoFile = new RecuperoFile();
						FileExtractedIn lFileExtractedIn = new FileExtractedIn();
						lFileExtractedIn.setUri(allegato.getUriFileOmissis());
						FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
						lFileAllegatoOmissis = out.getExtracted();
					} else {
						// File locale
						lFileAllegatoOmissis = StorageImplementation.getStorage().extractFile(allegato.getUriFileOmissis());
					}
					fileAllegatiOmissis.add(lFileAllegatoOmissis);
					MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = allegato.getInfoFileOmissis();
					if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
						lMimeTypeFirmaBeanOmissis = new InfoFileUtility().getInfoFromFile(lFileAllegatoOmissis.toURI().toString(), allegato.getNomeFileOmissis(), false, null);
						if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
							throw new Exception("Si è verificato un errore durante il controllo del file allegato " + allegato.getNomeFileOmissis() + " (vers. con omissis)");
						}
					}
					FileInfoBean lFileInfoBeanOmissis = new FileInfoBean();
					lFileInfoBeanOmissis.setTipo(TipoFile.ALLEGATO);
					GenericFile lGenericFileOmissis = new GenericFile();
					if (lMimeTypeFirmaBeanOmissis.getFirmatari() != null) {
						List<Firmatario> lList = new ArrayList<Firmatario>();
						for (String lString : lMimeTypeFirmaBeanOmissis.getFirmatari()) {
							Firmatario lFirmatario = new Firmatario();
							lFirmatario.setCommonName(lString);
							lList.add(lFirmatario);
						}
						lGenericFileOmissis.setFirmatari(lList);
						lGenericFileOmissis.setFirmato(Flag.SETTED);
					}
					lGenericFileOmissis.setMimetype(lMimeTypeFirmaBeanOmissis.getMimetype());
					lGenericFileOmissis.setDisplayFilename(allegato.getNomeFileOmissis());
					lGenericFileOmissis.setImpronta(lMimeTypeFirmaBeanOmissis.getImpronta());
					lGenericFileOmissis.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
					lGenericFileOmissis.setEncoding(lDocumentConfiguration.getEncoding().value());
					if (lMimeTypeFirmaBeanOmissis.isDaScansione()) {
						lGenericFileOmissis.setDaScansione(Flag.SETTED);
						lGenericFileOmissis.setDataScansione(new Date());
						lGenericFileOmissis.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
					}
					lFileInfoBeanOmissis.setPosizione(i);
					lFileInfoBeanOmissis.setAllegatoRiferimento(lGenericFileOmissis);
					infoOmissis.add(lFileInfoBeanOmissis);
				} else {
					infoOmissis.add(new FileInfoBean());
					isNullOmissis.add(true);
				}
				if (StringUtils.isNotBlank(allegato.getIdAttachEmail())) {
					AttachAndPosizioneBean lAttachAndPosizioneBean = new AttachAndPosizioneBean();
					lAttachAndPosizioneBean.setIdAttachment(allegato.getIdAttachEmail());
					lAttachAndPosizioneBean.setPosizione(i);
					list.add(lAttachAndPosizioneBean);
				}
				// Federico Cacco 22.06.2016
				// Integro la lista dei documenti da importare
				if ((allegato.getCollegaDocumentoImportato() != null) && (allegato.getCollegaDocumentoImportato())
						&& (StringUtils.isNotBlank(allegato.getIdUdAppartenenza()))) {
					if (!idUdDaCollegareList.contains(allegato.getIdUdAppartenenza())) {
						idUdDaCollegareList.add(allegato.getIdUdAppartenenza());
					}
				}
				i++;
			}
			// Federico Cacco 22.06.2016
			// Inserisco tutti i documenti da importare
			List<DocumentoCollegato> listaDocumentiCollegati = new ArrayList<DocumentoCollegato>();
			for (String idUdDaCollegare : idUdDaCollegareList) {
				DocumentoCollegato documentoCollegato = new DocumentoCollegato();
				documentoCollegato.setIdUd(idUdDaCollegare);
				documentoCollegato.setcValue("C");
				documentoCollegato.setPrcValue("PRC");
				listaDocumentiCollegati.add(documentoCollegato);
			}
			if (listaDocumentiCollegati.size() > 0) {
				addDocumentoCollegato(lCreaDocumentoInBean, listaDocumentiCollegati);
			}
			lAllegatiBean = new AllegatiBean();
			lAllegatiBean.setDescrizione(descrizione);
			lAllegatiBean.setDisplayFilename(displayFilename);
			lAllegatiBean.setDocType(docType);
			lAllegatiBean.setIsNull(isNull);
			lAllegatiBean.setFileAllegati(fileAllegati);
			lAllegatiBean.setInfo(info);
			lAllegatiBean.setFlgParteDispositivo(flgParteDispositivo);
			lAllegatiBean.setIdTask(idTask);
			lAllegatiBean.setFlgNoPubbl(flgNoPubbl);			
			lAllegatiBean.setFlgDatiSensibili(flgDatiSensibili);
			lAllegatiBean.setIdUdFrom(idUdFrom);			
			lAllegatiBean.setDisplayFilenameOmissis(displayFilenameOmissis);
			lAllegatiBean.setIsNullOmissis(isNullOmissis);
			lAllegatiBean.setFileAllegatiOmissis(fileAllegatiOmissis);
			lAllegatiBean.setInfoOmissis(infoOmissis);
		}

		// Salvo il file PRIMARIO
		FilePrimarioBean lFilePrimarioBean = retrieveFilePrimario(bean, lAurigaLoginBean);
		if (lFilePrimarioBean != null) {			
			if(lFilePrimarioBean.getFile() != null) {
				MimeTypeFirmaBean lMimeTypeFirmaBean = bean.getInfoFile();
				if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
					File lFile = StorageImplementation.getStorage().extractFile(bean.getUriFilePrimario());
					lMimeTypeFirmaBean = new InfoFileUtility().getInfoFromFile(lFile.toURI().toString(), bean.getNomeFilePrimario(), false, null);
					if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
						throw new Exception("Si è verificato un errore durante il controllo del file primario " + bean.getNomeFilePrimario());
					}
				}	
				FileInfoBean lFileInfoBean = new FileInfoBean();
				lFileInfoBean.setTipo(TipoFile.PRIMARIO);
				GenericFile lGenericFile = new GenericFile();
				if (lMimeTypeFirmaBean.getFirmatari() != null) {
					List<Firmatario> lList = new ArrayList<Firmatario>();
					for (String lString : lMimeTypeFirmaBean.getFirmatari()) {
						Firmatario lFirmatario = new Firmatario();
						lFirmatario.setCommonName(lString);
						lList.add(lFirmatario);
					}
					lGenericFile.setFirmatari(lList);
					lGenericFile.setFirmato(Flag.SETTED);
				}
				lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
				lGenericFile.setDisplayFilename(bean.getNomeFilePrimario());
				lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
				lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
				lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
				if (lMimeTypeFirmaBean.isDaScansione()) {
					lGenericFile.setDaScansione(Flag.SETTED);
					lGenericFile.setDataScansione(new Date());
					lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
				}
				lFileInfoBean.setAllegatoRiferimento(lGenericFile);
				lFilePrimarioBean.setInfo(lFileInfoBean);
				if (StringUtils.isNotBlank(bean.getIdAttachEmailPrimario())) {
					AttachAndPosizioneBean lAttachAndPosizioneBean = new AttachAndPosizioneBean();
					lAttachAndPosizioneBean.setIdAttachment(bean.getIdAttachEmailPrimario());
					lAttachAndPosizioneBean.setPosizione(0);
					list.add(lAttachAndPosizioneBean);
				}
			}
			// Vers. con omissis
			if(lFilePrimarioBean.getFileOmissis() != null && bean.getFilePrimarioOmissis() != null) {
				MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = bean.getFilePrimarioOmissis().getInfoFile();
				if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
					File lFileOmissis = StorageImplementation.getStorage().extractFile(bean.getFilePrimarioOmissis().getUriFile());
					lMimeTypeFirmaBeanOmissis = new InfoFileUtility().getInfoFromFile(lFileOmissis.toURI().toString(), bean.getFilePrimarioOmissis().getNomeFile(), false, null);
					if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
						throw new Exception("Si è verificato un errore durante il controllo del file primario " + bean.getFilePrimarioOmissis().getNomeFile() + " (vers. con omissis)");
					}
				}
				FileInfoBean lFileInfoBeanOmissis = new FileInfoBean();
				lFileInfoBeanOmissis.setTipo(TipoFile.PRIMARIO);
				GenericFile lGenericFileOmissis = new GenericFile();
				if (lMimeTypeFirmaBeanOmissis.getFirmatari() != null) {
					List<Firmatario> lList = new ArrayList<Firmatario>();
					for (String lString : lMimeTypeFirmaBeanOmissis.getFirmatari()) {
						Firmatario lFirmatario = new Firmatario();
						lFirmatario.setCommonName(lString);
						lList.add(lFirmatario);
					}
					lGenericFileOmissis.setFirmatari(lList);
					lGenericFileOmissis.setFirmato(Flag.SETTED);
				}
				lGenericFileOmissis.setMimetype(lMimeTypeFirmaBeanOmissis.getMimetype());
				lGenericFileOmissis.setDisplayFilename(bean.getFilePrimarioOmissis().getNomeFile());
				lGenericFileOmissis.setImpronta(lMimeTypeFirmaBeanOmissis.getImpronta());
				lGenericFileOmissis.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
				lGenericFileOmissis.setEncoding(lDocumentConfiguration.getEncoding().value());
				if (lMimeTypeFirmaBeanOmissis.isDaScansione()) {
					lGenericFileOmissis.setDaScansione(Flag.SETTED);
					lGenericFileOmissis.setDataScansione(new Date());
					lGenericFileOmissis.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
				}
				lFileInfoBeanOmissis.setAllegatoRiferimento(lGenericFileOmissis);
				lFilePrimarioBean.setInfoOmissis(lFileInfoBeanOmissis);
			}
		}
		
		salvaAltriSoggettiEsterni(bean, lCreaDocumentoInBean);
		
		// Federico Cacco 13.06.2017
		// Salvo i dati di richiesta accesso atti
		salvaListaAttiRichiestaAccessoAtti(bean, lCreaDocumentoInBean);

		Map<String, Object> valori = bean.getValori() != null ? bean.getValori() : new HashMap<String, Object>();
		Map<String, String> tipiValori = bean.getTipiValori() != null ? bean.getTipiValori() : new HashMap<String, String>();
		SezioneCache sezioneCacheAttributiDinamici = SezioneCacheAttributiDinamici.createSezioneCacheAttributiDinamici(null, valori, tipiValori, getSession());
		salvaAttributiCustom(bean, sezioneCacheAttributiDinamici);
		lCreaDocumentoInBean.setSezioneCacheAttributiDinamici(sezioneCacheAttributiDinamici);

		CreaModDocumentoOutBean lCreaDocumentoOutBean = null;
		// Se vengo da una mail
		if (StringUtils.isNotBlank(bean.getIdEmailArrivo())) {
			EmailProvBean lEmailProvBean = new EmailProvBean();
			if (bean.getFlgCasellaIstituzionale() != null && bean.getFlgCasellaIstituzionale())
				lEmailProvBean.setFlgCasellaIstituzionale(Flag.SETTED);
			if (bean.getFlgDichIPA() != null && bean.getFlgDichIPA())
				lEmailProvBean.setFlgDichIPA(Flag.SETTED);
			if (bean.getFlgPEC() != null && bean.getFlgPEC())
				lEmailProvBean.setFlgPEC(Flag.SETTED);
			if (StringUtils.isNotBlank(bean.getGestorePEC()))
				lEmailProvBean.setGestorePEC(bean.getGestorePEC());
			if (StringUtils.isNotBlank(bean.getIndirizzo()))
				lEmailProvBean.setIndirizzo(bean.getIndirizzo());
			lCreaDocumentoInBean.setEmailProv(lEmailProvBean);

			GestioneEmail lGestioneEmail = new GestioneEmail();
			MailDocumentoIn lMailDocumentoIn = new MailDocumentoIn();
			ConvertUtils.register(new DateConverter(), Date.class);
			BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lMailDocumentoIn, lCreaDocumentoInBean);
			// Map<String, Object> lMap =
			// BeanUtilsBean2.getInstance().getPropertyUtils().describe(lCreaDocumentoInBean);
			// for (String lString : lMap.keySet()){
			// if (lMap.get(lString)!=null){
			// BeanUtilsBean2.getInstance().setProperty(lMailDocumentoIn,
			// lString, lMap.get(lString));
			// }
			// }
			// BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lMailDocumentoIn,
			// lCreaDocumentoInBean);
			lMailDocumentoIn.setIdEmail(bean.getIdEmailArrivo());
			lAttachAndPosizioneCollectionBean.setLista(list);
			TFilterFetch<TRelEmailFolderBean> lTFetch = new TFilterFetch<TRelEmailFolderBean>();
			TRelEmailFolderBean lTRelEmailFolderBeanSearch = new TRelEmailFolderBean();
			lTRelEmailFolderBeanSearch.setIdEmail(bean.getIdEmailArrivo());
			lTFetch.setFilter(lTRelEmailFolderBeanSearch);
			TPagingList<TRelEmailFolderBean> results = AurigaMailService.getDaoTRelEmailFolder().search(getLocale(), lTFetch);
			String idFolderCasella = results.getData().get(0).getIdFolderCasella();
			String classificazione = AurigaMailService.getDaoTFolderCaselle().get(getLocale(), idFolderCasella).getClassificazione();
			lMailDocumentoIn.setClassificazione(classificazione);

			lCreaDocumentoOutBean = lGestioneEmail.creadocumento(getLocale(), lAurigaLoginBean, lMailDocumentoIn, lFilePrimarioBean, lAllegatiBean,
					lAttachAndPosizioneCollectionBean);

			bean.setIdUd(lCreaDocumentoOutBean.getIdUd());

			if (lCreaDocumentoOutBean.getDefaultMessage() != null) {
				throw new StoreException(lCreaDocumentoOutBean.getDefaultMessage());
			}

			invioNotificheAssegnazioneInvioCC(bean,lMailDocumentoIn,false);
			
			CheckService lCheckService = new CheckService();
			String lStrIdUtente = StringUtils.isNotBlank(lAurigaLoginBean.getSpecializzazioneBean().getIdUtenteModPec()) ? lAurigaLoginBean.getSpecializzazioneBean().getIdUtenteModPec() : "";
			LockBean lLockBean = new LockBean();
			lLockBean.setMailId(bean.getIdEmailArrivo());
			lLockBean.setUserId(lStrIdUtente);
			TEmailMgoBean lTEmailMgoBean = lCheckService.unlock(getLocale(), lLockBean);
			// boolean archiviaInAutomatico =
			// retrieveArchiviaInAutomatico(lMailDocumentoIn);
		}
		// Normale protocollazione
		else {

			GestioneDocumenti lGestioneDocumenti = new GestioneDocumenti();

			if (isPropostaAttoMilano()) {

				CreaModAttoInBean lCreaAttoMilanoInBean = new CreaModAttoInBean();
				ConvertUtils.register(new DateConverter(), Date.class);
				BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lCreaAttoMilanoInBean, lCreaDocumentoInBean);

				lCreaAttoMilanoInBean.setSceltaIter(bean.getSceltaIter());
				lCreaAttoMilanoInBean.setFlgRichParereRevisori(bean.getFlgRichParereRevisori() != null && bean.getFlgRichParereRevisori() ? Flag.SETTED
						: Flag.NOT_SETTED);
				lCreaAttoMilanoInBean.setSiglaAttoRifSubImpegno(bean.getSiglaAttoRifSubImpegno());
				lCreaAttoMilanoInBean.setNumeroAttoRifSubImpegno(bean.getNumeroAttoRifSubImpegno());
				lCreaAttoMilanoInBean.setAnnoAttoRifSubImpegno(bean.getAnnoAttoRifSubImpegno());
				lCreaAttoMilanoInBean.setDataAttoRifSubImpegno(bean.getDataAttoRifSubImpegno());

				lCreaDocumentoOutBean = lGestioneDocumenti
						.creadocumento(getLocale(), lAurigaLoginBean, lCreaAttoMilanoInBean, lFilePrimarioBean, lAllegatiBean);

			} else {

				lCreaDocumentoOutBean = lGestioneDocumenti.creadocumento(getLocale(), lAurigaLoginBean, lCreaDocumentoInBean, lFilePrimarioBean, lAllegatiBean);

			}

			bean.setIdUd(lCreaDocumentoOutBean.getIdUd());
			bean.setRowidDoc(lCreaDocumentoOutBean.getRowidDoc());
			bean.setIdDocPrimario(lCreaDocumentoOutBean.getIdDoc());

			if (lCreaDocumentoOutBean.getDefaultMessage() != null) {
				throw new StoreException(lCreaDocumentoOutBean.getDefaultMessage());
			}

			invioNotificheAssegnazioneInvioCC(bean, lCreaDocumentoInBean, false);
		}

		String result = "";
		String[] attributes = new String[2];
		attributes[0] = lCreaDocumentoOutBean.getNumero().toString();
		attributes[1] = lCreaDocumentoOutBean.getAnno().toString();

		String userLanguage = getLocale().getLanguage();
		if(isRichiestaAccessoAtti) {
			result = "Richiesta accesso atti inserita con successo";
		} else if (lCreaDocumentoInBean.getFlgTipoProv() == null) {
			result = "Documento inserito con successo";
		} else if (lCreaDocumentoInBean.getFlgTipoProv() == TipoProvenienza.ENTRATA || lCreaDocumentoInBean.getFlgTipoProv() == TipoProvenienza.USCITA) {
			result = MessageUtil.getValue(userLanguage, getSession(), "protocollazione_message_registrazione_generale_esito_OK_value", attributes);
		} else if (lCreaDocumentoInBean.getFlgTipoProv() == TipoProvenienza.INTERNA) {
			if(ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_REGISTRO_PG_X_PROT_INTERNA")) {
				result = MessageUtil.getValue(userLanguage, getSession(), "protocollazione_message_registrazione_generale_esito_OK_value", attributes);
			} else {
				result = MessageUtil.getValue(userLanguage, getSession(), "protocollazione_message_registrazione_interna_esito_OK_value", attributes);
			}
		}

		bean.setDataProtocollo(lCreaDocumentoOutBean.getData());
		bean.setNroProtocollo(new BigDecimal(lCreaDocumentoOutBean.getNumero() + ""));

		StringBuffer lStringBuffer = new StringBuffer();
		if (lCreaDocumentoOutBean.getFileInErrors() != null && lCreaDocumentoOutBean.getFileInErrors().size() > 0) {
			lStringBuffer.append(result);
			for (String lStrFileInError : lCreaDocumentoOutBean.getFileInErrors().values()) {
				lStringBuffer.append("; " + lStrFileInError);
			}
			addMessage(lStringBuffer.toString(), "", MessageType.WARNING);
		} else if (!isPropostaAtto()) {
			addMessage(result, "", MessageType.INFO);
		}
		if (lCreaDocumentoOutBean.getArchiviazioneError() != null && lCreaDocumentoOutBean.getArchiviazioneError()) {
			addMessage("Non è stato possibile eseguire l'archiviazione automatica dell'e-mail", "", MessageType.WARNING);
		}
		if (lCreaDocumentoOutBean.getInvioConfermaAutomaticaError() != null && lCreaDocumentoOutBean.getInvioConfermaAutomaticaError()) {
			addMessage("Non è stato possibile eseguire l'invio conferma automatica dell'e-mail", "", MessageType.WARNING);
		}
		if (lCreaDocumentoOutBean.getSalvataggioMetadatiError() != null && lCreaDocumentoOutBean.getSalvataggioMetadatiError()) {
			addMessage("Si è verificato un errore durante il salvataggio dei metadati su SharePoint", "", MessageType.WARNING);
		}

		/*
		 * Metodo invio mail automatica - viene inviata se e solo se: 1) Il controllo sulla profilatura è attivo 2) Ho un destinatario valido 3) La mail non è
		 * interoperabile 4) La mail sia in entrata 5) Id mail è valorizzato
		 */

		String controlloProfilatura = ParametriDBUtil.getParametroDB(getSession(), "INVIO_NOTIFICA_ACCETTAZIONE");
		if (controlloProfilatura != null && controlloProfilatura.equalsIgnoreCase("true")) {
			if (bean.getCasellaEmailDestinatario() != null && StringUtils.isNotBlank(bean.getCasellaEmailDestinatario())
					&& (bean.getEmailArrivoInteroperabile() == null || !bean.getEmailArrivoInteroperabile())
					&& (bean.getFlgTipoProv() != null && bean.getFlgTipoProv().equalsIgnoreCase("E"))
					&& (bean.getIdEmailArrivo() != null && StringUtils.isNotBlank(bean.getIdEmailArrivo()))) {
				invioNotificaPostRegistrazione(bean, lAurigaLoginBean);
			}
		}
		
		if(ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_TIMBRATURA_FILE_POST_REG") && !isPropostaAtto()) {
			apposizioneTimbroPostReg(bean);
		}
		
		return bean;
	}

	// Archivia la mail 
	private void archiviaEmail(String idEmailUDIn, String operazioneRichiestaIn) throws Exception {
		
		// Popolo input
		List<PostaElettronicaBean> listaArchiviazioneEmail = new ArrayList<PostaElettronicaBean>();
		PostaElettronicaBean lPostaElettronicaBean = new PostaElettronicaBean();
		
		lPostaElettronicaBean.setIdEmail(idEmailUDIn);	
		listaArchiviazioneEmail.add(lPostaElettronicaBean);
			
		// Lancio l'archiviazione
		ArchiviazioneEmailBean       inputDataSourceBean  = new ArchiviazioneEmailBean();
		inputDataSourceBean.setListaRecord(listaArchiviazioneEmail);
		inputDataSourceBean.setOperazioneRichiesta(operazioneRichiestaIn);
		inputDataSourceBean.setMotivazione(null);
		
		
		ArchiviazioneEmailBean       outputDataSourceBean = new ArchiviazioneEmailBean();
		ArchiviazioneEmailDataSource dataSource = new ArchiviazioneEmailDataSource();
		
		try {			
			dataSource.setSession(getSession());
			outputDataSourceBean = dataSource.add(inputDataSourceBean);   
	
			
			if (outputDataSourceBean.getErrorMessages()!=null){
				HashMap<String, String> errorMessages = null;
				errorMessages = new HashMap<String, String>();
				errorMessages.putAll(outputDataSourceBean.getErrorMessages());
				String key = errorMessages.keySet().toArray(new String[1])[0];
				String value = errorMessages.get(key);
				throw new StoreException("Fallita chiusura automatica della mail. Errore = " + value);							
			}
			
		}
		catch (Exception e) {
			throw new StoreException(e.getMessage());		
		}	
		
	}
	
	// Associa una mail inviata alla UD
	/*
	private void associaEmailUD(String idEmailIn, String idUIn, String codCategoriaReg, String siglaReg, String annoReg, String numeroReg, Date dataReg) throws Exception {
		
		
		// ---------------------------------------------------------------------------------------------------------------------------------------------------------
		// Cerco il dettaglio della mail per leggere gli estremi della registrazione : idUd , categoriaRegUD, numRegUD , siglaRegUD , annoRegUD , tsRegUD
		// ---------------------------------------------------------------------------------------------------------------------------------------------------------

		// ---------------------------------------------------------------------------------------------------------------------------------------------------------
		// Associo la mail all'UD ( nella T_REG_PROT_VS_EMAIL )
		// ---------------------------------------------------------------------------------------------------------------------------------------------------------
		if (idUIn != null && !idUIn.equalsIgnoreCase("")) {
			// Inizializzo l'INPUT
			TRegProtVsEmailBean lTRegProtVsEmailSaveIn = new TRegProtVsEmailBean();
			lTRegProtVsEmailSaveIn.setAnnoReg(annoReg != null && !"".equals(annoReg) ? new Short(annoReg) : null);
			lTRegProtVsEmailSaveIn.setCategoriaReg(codCategoriaReg);
			lTRegProtVsEmailSaveIn.setIdEmail(idEmailIn);
			lTRegProtVsEmailSaveIn.setIdProvReg(idUIn);
			lTRegProtVsEmailSaveIn.setNumReg(numeroReg != null && !"".equals(numeroReg) ? new BigDecimal(numeroReg) : null);
			lTRegProtVsEmailSaveIn.setSiglaRegistro(siglaReg);
			lTRegProtVsEmailSaveIn.setTsReg(dataReg != null  ? (dataReg) : null);
			lTRegProtVsEmailSaveIn.setIdRegProtEmail(KeyGenerator.gen());

			// Eseguo il servizio
			try {
				AurigaMailService.getDaoTRegProtVsEmail().save(getLocale(), lTRegProtVsEmailSaveIn);
			} catch (Exception e) {
				String msgError = "Fallita associazione e-mail al documento.";
				throw new StoreException(msgError);
			}
		}

	}
	*/
	
	/**
	 * Recupera il file primario dallo storage e lo restituisce sotto forma di FilePrimarioBean
	 * 
	 * @param bean
	 * @param lAurigaLoginBean
	 * @return
	 * @throws StorageException
	 */
	private FilePrimarioBean retrieveFilePrimario(ProtocollazioneBean bean, AurigaLoginBean lAurigaLoginBean) throws StorageException {

		FilePrimarioBean filePrimarioBean = new FilePrimarioBean();
		if (StringUtils.isNotBlank(bean.getUriFilePrimario()) && StringUtils.isNotBlank(bean.getNomeFilePrimario())) {
			if (bean.getRemoteUriFilePrimario()) {
				// Il file è esterno
				RecuperoFile lRecuperoFile = new RecuperoFile();
				FileExtractedIn lFileExtractedIn = new FileExtractedIn();
				lFileExtractedIn.setUri(bean.getUriFilePrimario());
				FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
				filePrimarioBean.setFile(out.getExtracted());
			} else {
				// File locale
				filePrimarioBean.setFile(StorageImplementation.getStorage().extractFile(bean.getUriFilePrimario()));
			}
		}
		// Vers. con omissis
		if ((bean.getFlgDatiSensibili() != null && bean.getFlgDatiSensibili()) && bean.getFilePrimarioOmissis() != null && StringUtils.isNotBlank(bean.getFilePrimarioOmissis().getUriFile()) && StringUtils.isNotBlank(bean.getFilePrimarioOmissis().getNomeFile())) {
			if (bean.getFilePrimarioOmissis().getRemoteUri()) {
				// Il file è esterno
				RecuperoFile lRecuperoFile = new RecuperoFile();
				FileExtractedIn lFileExtractedIn = new FileExtractedIn();
				lFileExtractedIn.setUri(bean.getFilePrimarioOmissis().getUriFile());
				FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
				filePrimarioBean.setFileOmissis(out.getExtracted());
			} else {
				// File locale
				filePrimarioBean.setFileOmissis(StorageImplementation.getStorage().extractFile(bean.getFilePrimarioOmissis().getUriFile()));
			}
		}
		if(filePrimarioBean.getFile() != null || filePrimarioBean.getFileOmissis() != null) {
			return filePrimarioBean;
		}
		return null;
	}

	private void invioNotificaPostRegistrazione(ProtocollazioneBean bean, AurigaLoginBean lAurigaLoginBean) throws Exception {
		SenderBean sender = new SenderBean();

		sender.setIdUtenteModPec(lAurigaLoginBean.getSpecializzazioneBean().getIdUtenteModPec());
		sender.setSubject("Notifica Automatica d'accettazione");
		sender.setBody("La richiesta inviata via email in data: "
				+ (bean.getDataEOraArrivo() != null ? new SimpleDateFormat(FMT_STD_TIMESTAMP).format(bean.getDataEOraArrivo()) : null)
				+ " è stata accettata e protocollata in data "
				+ (bean.getDataProtocollo() != null ? new SimpleDateFormat(FMT_STD_TIMESTAMP).format(bean.getDataProtocollo()) : null));
		sender.setAccount(bean.getCasellaEmailDestinatario());// Set Account-
																// DaoTMailBoxAccount
		sender.setAddressFrom(bean.getCasellaEmailDestinatario());// Set
																	// Mittente
		List<String> indirizzoDest = new ArrayList<String>();
		indirizzoDest.add(bean.getIndirizzo());
		sender.setAddressTo(indirizzoDest);// il Mittente che ha spedito la mail
											// diventa il nuovo Destinatario
		sender.setIsHtml(false);
		sender.setIsPec(false);
		try {
			ResultBean<EmailSentReferenceBean> output = AurigaMailService.getMailSenderService().sendandsave(getLocale(), sender);
			if (StringUtils.isNotBlank(output.getDefaultMessage())) {
				if (output.isInError()) {
					throw new StoreException(output.getDefaultMessage());
				} else {
					logProtDS.error("Fallito invio notifica e-mail" + output.getDefaultMessage());
				}
			}
		} catch (Exception e) {
			logProtDS.error("Fallito invio notifica e-mail dell'assegnazione: " + e.getMessage());
		}
	}

	public ProtocollazioneBean aggiornaFilePrimario(ProtocollazioneBean bean) throws Exception {

		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());

		DocumentConfiguration lDocumentConfiguration = (DocumentConfiguration) SpringAppContext.getContext().getBean("DocumentConfiguration");

		RebuildedFile lRebuildedFile = new RebuildedFile();
		lRebuildedFile.setIdDocumento(bean.getIdDocPrimario());
		lRebuildedFile.setFile(StorageImplementation.getStorage().extractFile(bean.getUriFilePrimario()));

		MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
		InfoFileUtility lFileUtility = new InfoFileUtility();
		lMimeTypeFirmaBean = lFileUtility.getInfoFromFile(lRebuildedFile.getFile().toURI().toString(), lRebuildedFile.getFile().getName(), false, null);

		FileInfoBean lFileInfoBean = new FileInfoBean();
		lFileInfoBean.setTipo(TipoFile.PRIMARIO);
		GenericFile lGenericFile = new GenericFile();
		lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
		lGenericFile.setDisplayFilename(bean.getNomeFilePrimario());
		lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
		lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
		lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
		if (lMimeTypeFirmaBean.isDaScansione()) {
			lGenericFile.setDaScansione(Flag.SETTED);
			lGenericFile.setDataScansione(new Date());
			lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
		}
		lFileInfoBean.setAllegatoRiferimento(lGenericFile);

		lRebuildedFile.setInfo(lFileInfoBean);

		VersionaDocumentoInBean lVersionaDocumentoInBean = new VersionaDocumentoInBean();
		BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBean, lRebuildedFile);

		GestioneDocumenti lGestioneDocumenti = new GestioneDocumenti();
		VersionaDocumentoOutBean lVersionaDocumentoOutput = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBean);

		if (lVersionaDocumentoOutput.getDefaultMessage() != null) {
			String message = "VersionaDocumento: " + lVersionaDocumentoOutput.getDefaultMessage();
			throw new Exception(message);
		}

		return bean;
	}
	
	public ProtocollazioneBean aggiornaFilePrimarioOmissis(ProtocollazioneBean bean) throws Exception {

		if(bean.getFilePrimarioOmissis() != null) {

			AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());
	
			DocumentConfiguration lDocumentConfiguration = (DocumentConfiguration) SpringAppContext.getContext().getBean("DocumentConfiguration");
	
			RebuildedFile lRebuildedFile = new RebuildedFile();
			lRebuildedFile.setIdDocumento(StringUtils.isNotBlank(bean.getFilePrimarioOmissis().getIdDoc()) ? new BigDecimal(bean.getFilePrimarioOmissis().getIdDoc()) : null);
			lRebuildedFile.setFile(StorageImplementation.getStorage().extractFile(bean.getFilePrimarioOmissis().getUriFile()));
	
			MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
			InfoFileUtility lFileUtility = new InfoFileUtility();
			lMimeTypeFirmaBean = lFileUtility.getInfoFromFile(lRebuildedFile.getFile().toURI().toString(), lRebuildedFile.getFile().getName(), false, null);
	
			FileInfoBean lFileInfoBean = new FileInfoBean();
			lFileInfoBean.setTipo(TipoFile.PRIMARIO);
			GenericFile lGenericFile = new GenericFile();
			lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
			lGenericFile.setDisplayFilename(bean.getFilePrimarioOmissis().getNomeFile());
			lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
			lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
			lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
			if (lMimeTypeFirmaBean.isDaScansione()) {
				lGenericFile.setDaScansione(Flag.SETTED);
				lGenericFile.setDataScansione(new Date());
				lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
			}
			lFileInfoBean.setAllegatoRiferimento(lGenericFile);
	
			lRebuildedFile.setInfo(lFileInfoBean);
	
			VersionaDocumentoInBean lVersionaDocumentoInBean = new VersionaDocumentoInBean();
			BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBean, lRebuildedFile);
	
			GestioneDocumenti lGestioneDocumenti = new GestioneDocumenti();
			VersionaDocumentoOutBean lVersionaDocumentoOutput = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBean);
	
			if (lVersionaDocumentoOutput.getDefaultMessage() != null) {
				String message = "VersionaDocumento: " + lVersionaDocumentoOutput.getDefaultMessage();
				throw new Exception(message);
			}
		
		}

		return bean;
	}
	
	public AllegatoProtocolloBean aggiornaFileAllegato(AllegatoProtocolloBean allegato) throws Exception {

		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());

		DocumentConfiguration lDocumentConfiguration = (DocumentConfiguration) SpringAppContext.getContext().getBean("DocumentConfiguration");

		RebuildedFile lRebuildedFile = new RebuildedFile();
		lRebuildedFile.setIdDocumento(allegato.getIdDocAllegato());
		lRebuildedFile.setFile(StorageImplementation.getStorage().extractFile(allegato.getUriFileAllegato()));

		MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
		InfoFileUtility lFileUtility = new InfoFileUtility();
		lMimeTypeFirmaBean = lFileUtility.getInfoFromFile(lRebuildedFile.getFile().toURI().toString(), lRebuildedFile.getFile().getName(), false, null);

		FileInfoBean lFileInfoBean = new FileInfoBean();
		lFileInfoBean.setTipo(TipoFile.ALLEGATO);
		GenericFile lGenericFile = new GenericFile();
		lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
		lGenericFile.setDisplayFilename(allegato.getNomeFileAllegato());
		lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
		lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
		lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
		if (lMimeTypeFirmaBean.isDaScansione()) {
			lGenericFile.setDaScansione(Flag.SETTED);
			lGenericFile.setDataScansione(new Date());
			lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
		}
		lFileInfoBean.setAllegatoRiferimento(lGenericFile);
		lRebuildedFile.setInfo(lFileInfoBean);

		VersionaDocumentoInBean lVersionaDocumentoInBean = new VersionaDocumentoInBean();
		BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBean, lRebuildedFile);

		GestioneDocumenti lGestioneDocumenti = new GestioneDocumenti();
		VersionaDocumentoOutBean lVersionaDocumentoOutput = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBean);

		if (lVersionaDocumentoOutput.getDefaultMessage() != null) {
			String message = "VersionaDocumento: " + lVersionaDocumentoOutput.getDefaultMessage();
			throw new Exception(message);
		}

		return allegato;
	}
	
	public AllegatoProtocolloBean aggiornaFileAllegatoOmissis(AllegatoProtocolloBean allegato) throws Exception {

		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());

		DocumentConfiguration lDocumentConfiguration = (DocumentConfiguration) SpringAppContext.getContext().getBean("DocumentConfiguration");

		RebuildedFile lRebuildedFile = new RebuildedFile();
		lRebuildedFile.setIdDocumento(allegato.getIdDocOmissis());
		lRebuildedFile.setFile(StorageImplementation.getStorage().extractFile(allegato.getUriFileOmissis()));

		MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
		InfoFileUtility lFileUtility = new InfoFileUtility();
		lMimeTypeFirmaBean = lFileUtility.getInfoFromFile(lRebuildedFile.getFile().toURI().toString(), lRebuildedFile.getFile().getName(), false, null);

		FileInfoBean lFileInfoBean = new FileInfoBean();
		lFileInfoBean.setTipo(TipoFile.ALLEGATO);
		GenericFile lGenericFile = new GenericFile();
		lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
		lGenericFile.setDisplayFilename(allegato.getNomeFileOmissis());
		lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
		lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
		lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
		if (lMimeTypeFirmaBean.isDaScansione()) {
			lGenericFile.setDaScansione(Flag.SETTED);
			lGenericFile.setDataScansione(new Date());
			lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
		}
		lFileInfoBean.setAllegatoRiferimento(lGenericFile);
		lRebuildedFile.setInfo(lFileInfoBean);

		VersionaDocumentoInBean lVersionaDocumentoInBean = new VersionaDocumentoInBean();
		BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBean, lRebuildedFile);

		GestioneDocumenti lGestioneDocumenti = new GestioneDocumenti();
		VersionaDocumentoOutBean lVersionaDocumentoOutput = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBean);

		if (lVersionaDocumentoOutput.getDefaultMessage() != null) {
			String message = "VersionaDocumento: " + lVersionaDocumentoOutput.getDefaultMessage();
			throw new Exception(message);
		}

		return allegato;
	}

	@Override
	public ProtocollazioneBean update(ProtocollazioneBean bean, ProtocollazioneBean oldvalue) throws Exception {

		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());

		boolean isRepertorio = getExtraparams().get("isRepertorio") != null && "true".equals(getExtraparams().get("isRepertorio"));
		boolean isRegistrazioneFattura = getExtraparams().get("isRegistrazioneFattura") != null
				&& "true".equals(getExtraparams().get("isRegistrazioneFattura"));
		boolean isBozza = getExtraparams().get("isBozza") != null && "true".equals(getExtraparams().get("isBozza"));
		boolean isIstanza = getExtraparams().get("isIstanza") != null && "true".equals(getExtraparams().get("isIstanza"));
		boolean isRichiestaAccessoAtti = getExtraparams().get("isRichiestaAccessoAtti") != null && "true".equals(getExtraparams().get("isRichiestaAccessoAtti"));

		ArrayList<String> idUdDaCollegareList = new ArrayList<String>();

		// File lFilePrimario = StorageImplementation.getStorage().extractFile(bean.getUriFilePrimario());
		DocumentConfiguration lDocumentConfiguration = (DocumentConfiguration) SpringAppContext.getContext().getBean("DocumentConfiguration");

		CreaModDocumentoInBean lModificaDocumentoInBean = new CreaModDocumentoInBean();
		// salvo il tipo di registrazione (#FlgTipoProv) : entrata (E), in
		// uscita (U) o interna/tra uffici (I)
		if (bean.getFlgTipoProv() != null/* && !isBozza*/) {
			TipoProvenienza lTipoProvenienza = null;
			if (bean.getFlgTipoProv().equalsIgnoreCase("E")) {
				lTipoProvenienza = TipoProvenienza.ENTRATA;
			} else if (bean.getFlgTipoProv().equalsIgnoreCase("U")) {
				lTipoProvenienza = TipoProvenienza.USCITA;
			} else if (bean.getFlgTipoProv().equalsIgnoreCase("I")) {
				lTipoProvenienza = TipoProvenienza.INTERNA;
			}
			lModificaDocumentoInBean.setFlgTipoProv(lTipoProvenienza);
		}

		// usato se provengo da modifica fattura o repertorio
		boolean isRegistraAProtocolloGenerale = false;

		if ((isRegistrazioneFattura && (bean.getProtocolloGenerale() != null && bean.getProtocolloGenerale()))
				|| (isRepertorio && (bean.getProtocolloGenerale() != null && bean.getProtocolloGenerale())))
			isRegistraAProtocolloGenerale = true;

		if(bean.getTipoNumerazioneDaDare() != null) {
			lModificaDocumentoInBean.setTipoNumerazioni(Arrays.asList(new TipoNumerazioneBean[] { bean.getTipoNumerazioneDaDare() }));
		} else {
			
			// Salvo la TIPOLOGIA di NUMERAZIONE (SIGLA e CATEGORIA)
			TipoNumerazioneBean lTipoNumerazioneBean = new TipoNumerazioneBean();
			TipoNumerazioneBean lTipoProtocolloGenerale = null;

			// skip se è una proposta atto OR tipoProv null OR (tipoProv in (E,I)
			// AND nroProt valorizzato) OR (tipoProv = U and categoria = PG)
			boolean skipNumerazioniDaDare = isPropostaAtto() || bean.getFlgTipoProv() == null || (isBozza && "NI".equals(bean.getTipoProtocollo())) || 
					(((bean.getFlgTipoProv().equals("E") || bean.getFlgTipoProv().equals("I")) && bean.getNroProtocollo() != null && !"NI".equals(bean.getTipoProtocollo())) || 
					(bean.getFlgTipoProv().equals("U") && bean.getTipoProtocollo() != null && "PG".equals(bean.getTipoProtocollo())));

			// Se e' una RICHIESTA ACCESSO ATTI allora devo saltare sempre le numerazioni da dare
			if (isRichiestaAccessoAtti) {
				skipNumerazioniDaDare = true;
			}
			
			if(bean.getFlgAncheRepertorio() != null && bean.getFlgAncheRepertorio()) {
				skipNumerazioniDaDare = false;
			}
			
			if(isRegistraAProtocolloGenerale) {
				skipNumerazioniDaDare = false;
			}
			
			if (!skipNumerazioniDaDare) {					
				if (isRegistrazioneFattura) {
					bean.setIsRegistroFatture(true);
					// lTipoNumerazioneBean.setSigla("FATTURE");
					// lTipoNumerazioneBean.setCategoria("I");
					lTipoProtocolloGenerale = creaTipoProtocolloGenerale(bean);
				}
				else if (isRepertorio) {
					bean.setIsRepertorio(true);
					lTipoProtocolloGenerale = creaTipoProtocolloGenerale(bean);
				} 
				else if (bean.getFlgAncheRepertorio() != null && bean.getFlgAncheRepertorio()) {
					bean.setIsRepertorio(true);
					lTipoNumerazioneBean.setSigla(bean.getRepertorio());
					int annoCorrente = Integer.parseInt(new SimpleDateFormat("yyyy").format(new Date()));
					int annoPassato = annoCorrente - 1;
					lTipoNumerazioneBean.setAnno(bean.getAnnoPassato() != null && bean.getAnnoPassato() ? String.valueOf(annoPassato) : String.valueOf(annoCorrente));
					lTipoNumerazioneBean.setCategoria("R");		
				}
				// Registrazione ENTRATA o USCITA
				else if (bean.getFlgTipoProv() != null && (bean.getFlgTipoProv().equalsIgnoreCase("E") || bean.getFlgTipoProv().equalsIgnoreCase("U"))) {
					lTipoNumerazioneBean.setSigla(null);
					lTipoNumerazioneBean.setCategoria("PG");
				}
				// Registrazione INTERNA/TRA UFFICI
				else if (bean.getFlgTipoProv() != null && bean.getFlgTipoProv().equalsIgnoreCase("I")) {
					if(ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_REGISTRO_PG_X_PROT_INTERNA")) {
						lTipoNumerazioneBean.setSigla(null);
						lTipoNumerazioneBean.setCategoria("PG");
					} else {
						lTipoNumerazioneBean.setSigla("P.I.");
						lTipoNumerazioneBean.setCategoria("I");
					}								
				}
				// Registrazione ISTANZA CED/AUTOTUTELA
				else if (isIstanza) {
					lTipoNumerazioneBean.setSigla("ISTANZA");
					lTipoNumerazioneBean.setCategoria(null);
				}
				
				lTipoNumerazioneBean.setIdUo(StringUtils.isNotBlank(bean.getUoProtocollante()) ? bean.getUoProtocollante().substring(2) : null);
				
				if (lTipoProtocolloGenerale != null) {
					lModificaDocumentoInBean.setTipoNumerazioni(Arrays.asList(new TipoNumerazioneBean[] { lTipoProtocolloGenerale }));
				} else {
					lModificaDocumentoInBean.setTipoNumerazioni(Arrays.asList(new TipoNumerazioneBean[] { lTipoNumerazioneBean }));
				}
			}
		}

		// Salvo l'OGGETTO
		lModificaDocumentoInBean.setOggetto(bean.getOggetto());
		if (!isRichiestaAccessoAttiRichiedenteInterno(bean)){
			// Salvo i MITTENTI
			salvaMittenti(bean, lModificaDocumentoInBean);
		}else {
			// Salvo i RICHIEDENTI INTERNI
			salvaRichiedentiInterni(bean, lModificaDocumentoInBean);
		}
		// Salvo i destinatari
		salvaDestinatari(bean, lModificaDocumentoInBean);
		// Salvo gli assegnatari dal tab assegnazione
		salvaAssegnatari(bean, lModificaDocumentoInBean);
		// Salvo la lista degli invii per conoscenza
		salvaInvioDestCC(bean, lModificaDocumentoInBean);
		// Salvo la lista delle altre U.O. coinvolte
		salvaAltreUoCoinvolte(bean, lModificaDocumentoInBean);

		// Salvo la lista dei documenti collegati
		salvaDocumentiCollegati(bean, lModificaDocumentoInBean);
		// Salvo la lista degli altri riferimenti
		salvaAltriRiferimenti(bean, lModificaDocumentoInBean);
				
		// Salvo COD STATO DETT
		lModificaDocumentoInBean.setCodStatoDett(bean.getCodStatoDett());
		
		// Salvo la CLASSIFICA e FASCICOLAZIONE
		List<ClassificheFascicoliDocumentoBean> lListClassificheFascicoli = new ArrayList<ClassificheFascicoliDocumentoBean>();
		if (bean.getListaClassFasc() != null) {
			for (ClassificazioneFascicoloBean lClassificazioneFascicoloBean : bean.getListaClassFasc()) {
				ClassificheFascicoliDocumentoBean lClassificheFascicoliDocumentoBean = new ClassificheFascicoliDocumentoBean();
				lClassificheFascicoliDocumentoBean.setIdClassifica(lClassificazioneFascicoloBean.getIdClassifica());
				lClassificheFascicoliDocumentoBean.setIdFolderFascicolo(lClassificazioneFascicoloBean.getIdFolderFascicolo());
				lClassificheFascicoliDocumentoBean.setAnnoFascicolo(lClassificazioneFascicoloBean.getAnnoFascicolo());
				lClassificheFascicoliDocumentoBean.setNroFascicolo(lClassificazioneFascicoloBean.getNroFascicolo());
				lClassificheFascicoliDocumentoBean.setNroSottofascicolo(lClassificazioneFascicoloBean.getNroSottofascicolo());
				lClassificheFascicoliDocumentoBean.setNroInserto(lClassificazioneFascicoloBean.getNroInserto());
				if (lClassificazioneFascicoloBean.getFlgCapofila() != null && lClassificazioneFascicoloBean.getFlgCapofila()) {
					lClassificheFascicoliDocumentoBean.setTipoRelazione("CPF");
				}
				lListClassificheFascicoli.add(lClassificheFascicoliDocumentoBean);
			}
		}
		lModificaDocumentoInBean.setClassifichefascicoli(lListClassificheFascicoli);

		if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_FOLDER_CUSTOM") && !isPropostaAttoMilano()) {
			// Salvo i FOLDER CUSTOM
			List<FolderCustom> lListFolderCustom = new ArrayList<FolderCustom>();
			if (bean.getListaFolderCustom() != null) {
				for (FolderCustomBean lFolderCustomBean : bean.getListaFolderCustom()) {
					FolderCustom lFolderCustom = new FolderCustom();
					lFolderCustom.setId(lFolderCustomBean.getId());
					lFolderCustom.setPath(lFolderCustomBean.getPath());
					if (lFolderCustomBean.getFlgCapofila() != null && lFolderCustomBean.getFlgCapofila()) {
						lFolderCustom.setTipoRelazione("CPF");
					}
					lListFolderCustom.add(lFolderCustom);
				}
			}
			lModificaDocumentoInBean.setFolderCustom(lListFolderCustom);
		}

		// Grado di risercatezza
		lModificaDocumentoInBean.setLivelloRiservatezza(bean.getLivelloRiservatezza() != null ? bean.getLivelloRiservatezza().intValue() + "" : null);
		// Data termine riservatezza
		if (bean.getLivelloRiservatezza() != null)
			lModificaDocumentoInBean.setTermineRiservatezza(bean.getDataRiservatezza());
		// Priorità
		lModificaDocumentoInBean.setPriorita(bean.getPrioritaRiservatezza());

		// Documento riferimento
		DocumentoCollegato lDocumentoCollegato = new DocumentoCollegato();
		lDocumentoCollegato.setAnno(StringUtils.isNotBlank(bean.getAnnoDocRiferimento()) ? Integer.valueOf(bean.getAnnoDocRiferimento()) : null);
		lDocumentoCollegato.setNumero(bean.getNroDocRiferimento() != null ? bean.getNroDocRiferimento().intValue() : null);

		for (TipoProtocollo lTipoProtocollo : TipoProtocollo.values()) {
			if (lTipoProtocollo.toString().equals(bean.getSiglaDocRiferimento())) {
				lDocumentoCollegato.setTipo(lTipoProtocollo);
				if (lTipoProtocollo == TipoProtocollo.PROTOCOLLO_INTERNO) {
					lDocumentoCollegato.setSiglaRegistro("P.I.");
				}
			}
		}
		if (!(lDocumentoCollegato.getAnno() == null && lDocumentoCollegato.getNumero() == null && lDocumentoCollegato.getSiglaRegistro() == null))
			addDocumentoCollegato(lModificaDocumentoInBean, Arrays.asList(new DocumentoCollegato[] { lDocumentoCollegato }));
		// Collocazione fisica
		if (StringUtils.isNotBlank(bean.getNomeCollocazioneFisica())) {
			lModificaDocumentoInBean.setDescrizioneCollocazione(bean.getNomeCollocazioneFisica());
		}
		if (StringUtils.isNotBlank(bean.getIdToponimo())) {
			lModificaDocumentoInBean.setIdTopografico(bean.getIdToponimo());
		}

		lModificaDocumentoInBean.setFlgNoPubblPrimario(bean.getFlgNoPubblPrimario() != null && bean.getFlgNoPubblPrimario() ? "1" : null);
		lModificaDocumentoInBean.setFlgDatiSensibiliPrimario(bean.getFlgDatiSensibili() != null && bean.getFlgDatiSensibili() ? "1" : null);
		
		// Registrazioni da dare
		List<RegistroEmergenza> lListRegistrazioniDaDare = new ArrayList<RegistroEmergenza>();
		if (bean.getDataRegEmergenza() != null && bean.getNroRegEmergenza() != null && StringUtils.isNotBlank(bean.getRifRegEmergenza())) {
			// Registro emergenza
			RegistroEmergenza lRegistroEmergenza = new RegistroEmergenza();
			lRegistroEmergenza.setDataRegistrazione(bean.getDataRegEmergenza());
			lRegistroEmergenza.setNro(bean.getNroRegEmergenza().intValue() + "");
			lRegistroEmergenza.setRegistro(bean.getRifRegEmergenza());
			lRegistroEmergenza.setIdUserReg(bean.getIdUserRegEmergenza());
			lRegistroEmergenza.setIdUoReg(bean.getIdUoRegEmergenza());
			lListRegistrazioniDaDare.add(lRegistroEmergenza);
		}
		//TODO MODIFICHE RICH. ACCESSO ATTI (MATTIA ZANIN)		
		/*
		if (!isRichiestaAccessoAttiRichiedenteInterno(bean) && StringUtils.isNotBlank(bean.getNroProtocolloPregresso()) && (StringUtils.isNotBlank(bean.getAnnoProtocolloPregresso()) || (bean.getDataProtocolloPregresso() != null))) {
			//Registrazione protocollo PG@Web
			RegistroEmergenza lRegistroEmergenza = new RegistroEmergenza();
			lRegistroEmergenza.setDataRegistrazione(bean.getDataProtocolloPregresso());
			lRegistroEmergenza.setFisso("PG");
			lRegistroEmergenza.setRegistro(null);
			lRegistroEmergenza.setAnno(bean.getAnnoProtocolloPregresso());
			lRegistroEmergenza.setNro(bean.getNroProtocolloPregresso());
			lListRegistrazioniDaDare.add(lRegistroEmergenza);			
		}
		*/
		if(isRichiestaAccessoAtti()) {
			if (StringUtils.isNotBlank(bean.getNumeroPraticaSuSistUfficioRichiedente()) && StringUtils.isNotBlank(bean.getAnnoPraticaSuSistUfficioRichiedente())) {
				// Salvo dati pratica su ufficio richiedente
				RegistroEmergenza lRegistroEmergenza = new RegistroEmergenza();
				lRegistroEmergenza.setFisso("A");
				lRegistroEmergenza.setRegistro(bean.getSiglaPraticaSuSistUfficioRichiedente());
				lRegistroEmergenza.setAnno(bean.getAnnoPraticaSuSistUfficioRichiedente());
				lRegistroEmergenza.setNro(bean.getNumeroPraticaSuSistUfficioRichiedente());
				lListRegistrazioniDaDare.add(lRegistroEmergenza);
			}	
		}
				
		// se la lista è vuota in modifica non passo nulla altrimenti annullo le registrazioni precedenti
		if(lListRegistrazioniDaDare.size() > 0) {
			lModificaDocumentoInBean.setRegistroEmergenza(lListRegistrazioniDaDare);
		}
		
		// Altri dati
		lModificaDocumentoInBean.setNote(bean.getNote());
		lModificaDocumentoInBean.setDataStesura(bean.getDataDocumento());
		lModificaDocumentoInBean.setTipoDocumento(bean.getTipoDocumento());
		// Solo prot entrata - prot ricevuto
		if (bean.getFlgTipoProv() != null && bean.getFlgTipoProv().equalsIgnoreCase("E")) {
			ProtocolloRicevuto lProtocolloRicevuto = new ProtocolloRicevuto();
			if (StringUtils.isNotBlank(bean.getNroProtRicevuto()) && (StringUtils.isNotBlank(bean.getAnnoProtRicevuto()) || bean.getDataProtRicevuto() != null)) {
				lProtocolloRicevuto.setOrigine(bean.getRifOrigineProtRicevuto());
				lProtocolloRicevuto.setNumero(bean.getNroProtRicevuto());
				lProtocolloRicevuto.setAnno(bean.getAnnoProtRicevuto());
				lProtocolloRicevuto.setData(bean.getDataProtRicevuto());
			}
			lModificaDocumentoInBean.setProtocolloRicevuto(lProtocolloRicevuto);
			lModificaDocumentoInBean.setDataArrivo(bean.getDataEOraArrivo());
			// Mezzo trasmissione
			lModificaDocumentoInBean.setMessoTrasmissione(bean.getMezzoTrasmissione());			
			if(bean.getMezzoTrasmissione() != null && "R".equals(bean.getMezzoTrasmissione())) {
				if (bean.getNroRaccomandata() != null) {
					lModificaDocumentoInBean.setNroRaccomandata(bean.getNroRaccomandata());
				}
				if (bean.getDataRaccomandata() != null) {
					lModificaDocumentoInBean.setDtRaccomandata(bean.getDataRaccomandata());
				}
				if (StringUtils.isNotBlank(bean.getNroListaRaccomandata())) {
					lModificaDocumentoInBean.setNroListaRaccomandata(bean.getNroListaRaccomandata());
				}
			}			
		} else if (bean.getDataEOraRicezione() != null) {
			// Salvo al data e ora ricezione delle istanze CED/AUTOTUTELA
			lModificaDocumentoInBean.setDataArrivo(bean.getDataEOraRicezione());
		}
		
		if (isAttivoProtocolloWizard(bean)) {
			lModificaDocumentoInBean.setFlgSkipControlliCartaceo(bean.getFlgSkipControlliCartaceo() != null && bean.getFlgSkipControlliCartaceo() ? "1" : null);
			if (StringUtils.isNotBlank(bean.getSupportoOriginale())) {
				lModificaDocumentoInBean.setSupportoOriginale(bean.getSupportoOriginale());	
			}
		}

		if (StringUtils.isNotBlank(bean.getMotivoVarDatiReg())) {
			lModificaDocumentoInBean.setMotiviModificaDatiReg(bean.getMotivoVarDatiReg());
		}

		// Salvo i file ALLEGATI
		AttachAndPosizioneCollectionBean lAttachAndPosizioneCollectionBean = new AttachAndPosizioneCollectionBean();
		List<AttachAndPosizioneBean> list = new ArrayList<AttachAndPosizioneBean>();

		List<AllegatoProtocolloBean> listaAllegati = bean.getListaAllegati();
		if (bean.getFlgNoPubblPrimario() != null && bean.getFlgNoPubblPrimario()) {
			AllegatoProtocolloBean filePrimarioVerPubbl = bean.getListaFilePrimarioVerPubbl() != null && bean.getListaFilePrimarioVerPubbl().size() > 0 ? bean
					.getListaFilePrimarioVerPubbl().get(0) : null;
			if (filePrimarioVerPubbl != null) {
				String idTipoDocAllVerPubbl = ParametriDBUtil.getParametroDB(getSession(), "ID_TIPO_DOC_ALL_VER_PUBBL");
				if (idTipoDocAllVerPubbl != null && !"".equals(idTipoDocAllVerPubbl)) {
					filePrimarioVerPubbl.setIdTipoFileAllegato(idTipoDocAllVerPubbl);
					filePrimarioVerPubbl.setListaTipiFileAllegato(idTipoDocAllVerPubbl);
				}
				String nomeDocAllVerPubbl = ParametriDBUtil.getParametroDB(getSession(), "NOME_DOC_ALL_VER_PUBBL");
				if (nomeDocAllVerPubbl != null && !"".equals(nomeDocAllVerPubbl)) {
					filePrimarioVerPubbl.setDescrizioneFileAllegato(nomeDocAllVerPubbl);
				}
				filePrimarioVerPubbl.setFlgParteDispositivo(true);
				filePrimarioVerPubbl.setFlgNoPubblAllegato(false);
				if (listaAllegati == null) {
					listaAllegati = new ArrayList<AllegatoProtocolloBean>();
				}
				listaAllegati.add(0, filePrimarioVerPubbl);
			}
		}
		
		if (isAppendRelazioniVsUD(bean)) {
			lModificaDocumentoInBean.setAppendRelazioniVsUD("1");
		}

		AllegatiBean lAllegatiBean = null;
		if (listaAllegati != null) {			
			List<BigDecimal> idDocumento = new ArrayList<BigDecimal>();
			List<String> descrizione = new ArrayList<String>();
			List<Integer> docType = new ArrayList<Integer>();
			List<File> fileAllegati = new ArrayList<File>();
			List<Boolean> isNull = new ArrayList<Boolean>();
			List<Boolean> isNewOrChanged = new ArrayList<Boolean>();
			List<String> displayFilename = new ArrayList<String>();
			List<FileInfoBean> info = new ArrayList<FileInfoBean>();
			List<Boolean> flgParteDispositivo = new ArrayList<Boolean>();
			List<String> idTask = new ArrayList<String>();
			List<Boolean> flgNoPubbl = new ArrayList<Boolean>();			
			List<Boolean> flgDatiSensibili = new ArrayList<Boolean>();
			List<Boolean> flgSostituisciVerPrec = new ArrayList<Boolean>();
			List<Boolean> flgOriginaleCartaceo = new ArrayList<Boolean>();
			List<Boolean> flgCopiaSostitutiva = new ArrayList<Boolean>();
			List<String> idUdFrom = new ArrayList<String>();
			// Vers. con omissis
			List<BigDecimal> idDocumentoOmissis = new ArrayList<BigDecimal>();
			List<File> fileAllegatiOmissis = new ArrayList<File>();
			List<Boolean> isNullOmissis = new ArrayList<Boolean>();
			List<Boolean> isNewOrChangedOmissis = new ArrayList<Boolean>();
			List<String> displayFilenameOmissis = new ArrayList<String>();
			List<FileInfoBean> infoOmissis = new ArrayList<FileInfoBean>();			
			List<Boolean> flgSostituisciVerPrecOmissis = new ArrayList<Boolean>();
			int i = 1;
			for (AllegatoProtocolloBean allegato : listaAllegati) {
				idDocumento.add(allegato.getIdDocAllegato());
				descrizione.add(allegato.getDescrizioneFileAllegato());
				docType.add(StringUtils.isNotBlank(allegato.getListaTipiFileAllegato()) ? Integer.valueOf(allegato.getListaTipiFileAllegato()) : null);
				displayFilename.add(allegato.getNomeFileAllegato());
				flgParteDispositivo.add(allegato.getFlgParteDispositivo());
				// solo se è un allegato inserito in quella attività e se
				// l'attività è readonly salvo l'idTask
				if (allegato.getIdDocAllegato() == null) {
					idTask.add(getExtraparams().get("idTaskCorrente"));
				} else {
					idTask.add(allegato.getIdTask());
				}
				flgNoPubbl.add(allegato.getFlgNoPubblAllegato());				
				flgDatiSensibili.add(allegato.getFlgDatiSensibili());
				flgSostituisciVerPrec.add(allegato.getFlgSostituisciVerPrec());
				flgOriginaleCartaceo.add(allegato.getFlgOriginaleCartaceo());
				flgCopiaSostitutiva.add(allegato.getFlgCopiaSostitutiva());
				idUdFrom.add(allegato.getIdUdAppartenenza());
				if (StringUtils.isNotBlank(allegato.getUriFileAllegato()) && StringUtils.isNotBlank(allegato.getNomeFileAllegato())) {
					isNull.add(false);
					isNewOrChanged.add(allegato.getIdDocAllegato() == null || (allegato.getIsChanged() != null && allegato.getIsChanged()));					
					File lFile = null;
					if (allegato.getIdDocAllegato() == null || (allegato.getIsChanged() != null && allegato.getIsChanged())){
						if (allegato.getRemoteUri()) {
							// Il file è esterno
							RecuperoFile lRecuperoFile = new RecuperoFile();
							FileExtractedIn lFileExtractedIn = new FileExtractedIn();
							lFileExtractedIn.setUri(allegato.getUriFileAllegato());
							FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
							lFile = out.getExtracted();
						} else {
							// File locale
							lFile = StorageImplementation.getStorage().extractFile(allegato.getUriFileAllegato());
						}
						fileAllegati.add(lFile);
					}
					MimeTypeFirmaBean lMimeTypeFirmaBean = allegato.getInfoFile();
					if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
						if (lFile == null){
							if (allegato.getRemoteUri()) {
								// Il file è esterno
								RecuperoFile lRecuperoFile = new RecuperoFile();
								FileExtractedIn lFileExtractedIn = new FileExtractedIn();
								lFileExtractedIn.setUri(allegato.getUriFileAllegato());
								FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
								lFile = out.getExtracted();
							} else {
								// File locale
								lFile = StorageImplementation.getStorage().extractFile(allegato.getUriFileAllegato());
							}
						}
						lMimeTypeFirmaBean = new InfoFileUtility().getInfoFromFile(lFile.toURI().toString(), allegato.getNomeFileAllegato(), false, null);
						if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
							throw new Exception("Si è verificato un errore durante il controllo del file allegato " + allegato.getNomeFileAllegato());
						}
					}
					FileInfoBean lFileInfoBean = new FileInfoBean();
					lFileInfoBean.setTipo(TipoFile.ALLEGATO);
					GenericFile lGenericFile = new GenericFile();
					if (lMimeTypeFirmaBean.getFirmatari() != null) {
						List<Firmatario> lList = new ArrayList<Firmatario>();
						for (String lString : lMimeTypeFirmaBean.getFirmatari()) {
							Firmatario lFirmatario = new Firmatario();
							lFirmatario.setCommonName(lString);
							lList.add(lFirmatario);
						}
						lGenericFile.setFirmatari(lList);
						lGenericFile.setFirmato(Flag.SETTED);
					}
					lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
					lGenericFile.setDisplayFilename(allegato.getNomeFileAllegato());
					lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
					lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
					lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
					if (lMimeTypeFirmaBean.isDaScansione()) {
						lGenericFile.setDaScansione(Flag.SETTED);
						lGenericFile.setDataScansione(new Date());
						lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
					}
					lFileInfoBean.setPosizione(i);
					lFileInfoBean.setAllegatoRiferimento(lGenericFile);
					info.add(lFileInfoBean);
				} else {
					isNull.add(true);
					isNewOrChanged.add(null);
					info.add(new FileInfoBean());
				}				
				//TODO Vers. con omissis
				idDocumentoOmissis.add(allegato.getIdDocOmissis());
				displayFilenameOmissis.add(allegato.getNomeFileOmissis());					
				flgSostituisciVerPrecOmissis.add(allegato.getFlgSostituisciVerPrecOmissis());
				if ((allegato.getFlgDatiSensibili() != null && allegato.getFlgDatiSensibili()) && StringUtils.isNotBlank(allegato.getUriFileOmissis()) && StringUtils.isNotBlank(allegato.getNomeFileOmissis())) {
					isNullOmissis.add(false);
					isNewOrChangedOmissis.add(allegato.getIdDocOmissis() == null || (allegato.getIsChangedOmissis() != null && allegato.getIsChangedOmissis()));					
					File lFileAllegatoOmissis = null;
					if (allegato.getIdDocOmissis() == null || (allegato.getIsChangedOmissis() != null && allegato.getIsChangedOmissis())){
						if (allegato.getRemoteUriOmissis()) {
							// Il file è esterno
							RecuperoFile lRecuperoFile = new RecuperoFile();
							FileExtractedIn lFileExtractedIn = new FileExtractedIn();
							lFileExtractedIn.setUri(allegato.getUriFileOmissis());
							FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
							lFileAllegatoOmissis = out.getExtracted();
						} else {
							// File locale
							lFileAllegatoOmissis = StorageImplementation.getStorage().extractFile(allegato.getUriFileOmissis());
						}
						fileAllegatiOmissis.add(lFileAllegatoOmissis);
					}
					MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = allegato.getInfoFileOmissis();
					if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
						if (lFileAllegatoOmissis == null){
							if (allegato.getRemoteUriOmissis()) {
								// Il file è esterno
								RecuperoFile lRecuperoFile = new RecuperoFile();
								FileExtractedIn lFileExtractedIn = new FileExtractedIn();
								lFileExtractedIn.setUri(allegato.getUriFileOmissis());
								FileExtractedOut out = lRecuperoFile.extractfile(UserUtil.getLocale(), lAurigaLoginBean, lFileExtractedIn);
								lFileAllegatoOmissis = out.getExtracted();
							} else {
								// File locale
								lFileAllegatoOmissis = StorageImplementation.getStorage().extractFile(allegato.getUriFileOmissis());
							}
						}
						lMimeTypeFirmaBeanOmissis = new InfoFileUtility().getInfoFromFile(lFileAllegatoOmissis.toURI().toString(), allegato.getNomeFileOmissis(), false, null);
						if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
							throw new Exception("Si è verificato un errore durante il controllo del file allegato " + allegato.getNomeFileOmissis() + " (vers. con omissis)");
						}
					}
					FileInfoBean lFileInfoBeanOmissis = new FileInfoBean();
					lFileInfoBeanOmissis.setTipo(TipoFile.ALLEGATO);
					GenericFile lGenericFileOmissis = new GenericFile();
					if (lMimeTypeFirmaBeanOmissis.getFirmatari() != null) {
						List<Firmatario> lList = new ArrayList<Firmatario>();
						for (String lString : lMimeTypeFirmaBeanOmissis.getFirmatari()) {
							Firmatario lFirmatario = new Firmatario();
							lFirmatario.setCommonName(lString);
							lList.add(lFirmatario);
						}
						lGenericFileOmissis.setFirmatari(lList);
						lGenericFileOmissis.setFirmato(Flag.SETTED);
					}
					lGenericFileOmissis.setMimetype(lMimeTypeFirmaBeanOmissis.getMimetype());
					lGenericFileOmissis.setDisplayFilename(allegato.getNomeFileOmissis());
					lGenericFileOmissis.setImpronta(lMimeTypeFirmaBeanOmissis.getImpronta());
					lGenericFileOmissis.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
					lGenericFileOmissis.setEncoding(lDocumentConfiguration.getEncoding().value());
					if (lMimeTypeFirmaBeanOmissis.isDaScansione()) {
						lGenericFileOmissis.setDaScansione(Flag.SETTED);
						lGenericFileOmissis.setDataScansione(new Date());
						lGenericFileOmissis.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
					}
					lFileInfoBeanOmissis.setPosizione(i);
					lFileInfoBeanOmissis.setAllegatoRiferimento(lGenericFileOmissis);
					infoOmissis.add(lFileInfoBeanOmissis);
				} else {
					isNullOmissis.add(true);
					isNewOrChangedOmissis.add(null);
					infoOmissis.add(new FileInfoBean());
				}					
				if (StringUtils.isNotBlank(allegato.getIdAttachEmail())) {
					AttachAndPosizioneBean lAttachAndPosizioneBean = new AttachAndPosizioneBean();
					lAttachAndPosizioneBean.setIdAttachment(allegato.getIdAttachEmail());
					lAttachAndPosizioneBean.setPosizione(i);
					list.add(lAttachAndPosizioneBean);
				}
				// Federico Cacco 22.06.2016
				// Integro la lista dei documenti da importare
				if ((allegato.getCollegaDocumentoImportato() != null) && (allegato.getCollegaDocumentoImportato())
						&& (StringUtils.isNotBlank(allegato.getIdUdAppartenenza()))) {
					if (!idUdDaCollegareList.contains(allegato.getIdUdAppartenenza())) {
						idUdDaCollegareList.add(allegato.getIdUdAppartenenza());
					}
				}
				i++;
			}
			// Federico Cacco 22.06.2016
			// Inserisco tutti i documenti da importare
			List<DocumentoCollegato> listaDocumentiCollegati = new ArrayList<DocumentoCollegato>();
			for (String idUdDaCollegare : idUdDaCollegareList) {
				DocumentoCollegato documentoCollegato = new DocumentoCollegato();
				documentoCollegato.setIdUd(idUdDaCollegare);
				documentoCollegato.setcValue("C");
				documentoCollegato.setPrcValue("PRC");
				listaDocumentiCollegati.add(documentoCollegato);
			}
			if (listaDocumentiCollegati.size() > 0) {
				addDocumentoCollegato(lModificaDocumentoInBean, listaDocumentiCollegati);
			}
			lAllegatiBean = new AllegatiBean();
			lAllegatiBean.setIdDocumento(idDocumento);
			lAllegatiBean.setDescrizione(descrizione);
			lAllegatiBean.setDisplayFilename(displayFilename);
			lAllegatiBean.setDocType(docType);
			lAllegatiBean.setIsNull(isNull);
			lAllegatiBean.setIsNewOrChanged(isNewOrChanged);
			lAllegatiBean.setFileAllegati(fileAllegati);
			lAllegatiBean.setInfo(info);
			lAllegatiBean.setFlgParteDispositivo(flgParteDispositivo);
			lAllegatiBean.setIdTask(idTask);
			lAllegatiBean.setFlgNoPubbl(flgNoPubbl);			
			lAllegatiBean.setFlgDatiSensibili(flgDatiSensibili);
			lAllegatiBean.setFlgSostituisciVerPrec(flgSostituisciVerPrec);
			lAllegatiBean.setFlgOriginaleCartaceo(flgOriginaleCartaceo);
			lAllegatiBean.setFlgCopiaSostitutiva(flgCopiaSostitutiva);
			lAllegatiBean.setIdUdFrom(idUdFrom);			
			lAllegatiBean.setIdDocumentoOmissis(idDocumentoOmissis);
			lAllegatiBean.setDisplayFilenameOmissis(displayFilenameOmissis);
			lAllegatiBean.setIsNullOmissis(isNullOmissis);
			lAllegatiBean.setIsNewOrChangedOmissis(isNewOrChangedOmissis);
			lAllegatiBean.setFileAllegatiOmissis(fileAllegatiOmissis);
			lAllegatiBean.setInfoOmissis(infoOmissis);			
			lAllegatiBean.setFlgSostituisciVerPrecOmissis(flgSostituisciVerPrecOmissis);
		}

		// Salvo il file PRIMARIO
		FilePrimarioBean lFilePrimarioBean = retrieveFilePrimario(bean, lAurigaLoginBean);
		if (lFilePrimarioBean != null) {
			if(lFilePrimarioBean.getFile() != null) {				
				lFilePrimarioBean.setFlgSostituisciVerPrec(bean.getFlgSostituisciVerPrec());
				MimeTypeFirmaBean lMimeTypeFirmaBean = bean.getInfoFile();
				if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
					File lFile = StorageImplementation.getStorage().extractFile(bean.getUriFilePrimario());
					lMimeTypeFirmaBean = new InfoFileUtility().getInfoFromFile(lFile.toURI().toString(), bean.getNomeFilePrimario(), false, null);
					if (lMimeTypeFirmaBean == null || StringUtils.isBlank(lMimeTypeFirmaBean.getImpronta())) {
						throw new Exception("Si è verificato un errore durante il controllo del file primario " + bean.getNomeFilePrimario());
					}
				}

				FileInfoBean lFileInfoBean = new FileInfoBean();
				lFileInfoBean.setTipo(TipoFile.PRIMARIO);
				GenericFile lGenericFile = new GenericFile();
				if (lMimeTypeFirmaBean.getFirmatari() != null) {
					List<Firmatario> lList = new ArrayList<Firmatario>();
					for (String lString : lMimeTypeFirmaBean.getFirmatari()) {
						Firmatario lFirmatario = new Firmatario();
						lFirmatario.setCommonName(lString);
						lList.add(lFirmatario);
					}
					lGenericFile.setFirmatari(lList);
					lGenericFile.setFirmato(Flag.SETTED);
				}
				lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
				lGenericFile.setDisplayFilename(bean.getNomeFilePrimario());
				lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
				lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
				lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
				if (lMimeTypeFirmaBean.isDaScansione()) {
					lGenericFile.setDaScansione(Flag.SETTED);
					lGenericFile.setDataScansione(new Date());
					lGenericFile.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
				}

				lFileInfoBean.setAllegatoRiferimento(lGenericFile);
				lFilePrimarioBean.setIdDocumento(bean.getIdDocPrimario());
				lFilePrimarioBean.setIsNewOrChanged(bean.getIdDocPrimario() == null || (bean.getIsDocPrimarioChanged() != null && bean.getIsDocPrimarioChanged()));
				lFilePrimarioBean.setInfo(lFileInfoBean);
				if (StringUtils.isNotBlank(bean.getIdAttachEmailPrimario())) {
					AttachAndPosizioneBean lAttachAndPosizioneBean = new AttachAndPosizioneBean();
					lAttachAndPosizioneBean.setIdAttachment(bean.getIdAttachEmailPrimario());
					lAttachAndPosizioneBean.setPosizione(0);
					list.add(lAttachAndPosizioneBean);
				}
			}
			if(lFilePrimarioBean.getFileOmissis() != null && bean.getFilePrimarioOmissis() != null) {	
				lFilePrimarioBean.setFlgSostituisciVerPrecOmissis(bean.getFilePrimarioOmissis().getFlgSostituisciVerPrec());
				MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = bean.getFilePrimarioOmissis().getInfoFile();
				if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
					File lFileOmissis = StorageImplementation.getStorage().extractFile(bean.getFilePrimarioOmissis().getUriFile());
					lMimeTypeFirmaBeanOmissis = new InfoFileUtility().getInfoFromFile(lFileOmissis.toURI().toString(), bean.getFilePrimarioOmissis().getNomeFile(), false, null);
					if (lMimeTypeFirmaBeanOmissis == null || StringUtils.isBlank(lMimeTypeFirmaBeanOmissis.getImpronta())) {
						throw new Exception("Si è verificato un errore durante il controllo del file primario " + bean.getFilePrimarioOmissis().getNomeFile() + " (vers. con omissis)");
					}
				}
				FileInfoBean lFileInfoBeanOmissis = new FileInfoBean();
				lFileInfoBeanOmissis.setTipo(TipoFile.PRIMARIO);
				GenericFile lGenericFileOmissis = new GenericFile();
				if (lMimeTypeFirmaBeanOmissis.getFirmatari() != null) {
					List<Firmatario> lList = new ArrayList<Firmatario>();
					for (String lString : lMimeTypeFirmaBeanOmissis.getFirmatari()) {
						Firmatario lFirmatario = new Firmatario();
						lFirmatario.setCommonName(lString);
						lList.add(lFirmatario);
					}
					lGenericFileOmissis.setFirmatari(lList);
					lGenericFileOmissis.setFirmato(Flag.SETTED);
				}
				lGenericFileOmissis.setMimetype(lMimeTypeFirmaBeanOmissis.getMimetype());
				lGenericFileOmissis.setDisplayFilename(bean.getFilePrimarioOmissis().getNomeFile());
				lGenericFileOmissis.setImpronta(lMimeTypeFirmaBeanOmissis.getImpronta());
				lGenericFileOmissis.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
				lGenericFileOmissis.setEncoding(lDocumentConfiguration.getEncoding().value());
				if (lMimeTypeFirmaBeanOmissis.isDaScansione()) {
					lGenericFileOmissis.setDaScansione(Flag.SETTED);
					lGenericFileOmissis.setDataScansione(new Date());
					lGenericFileOmissis.setIdUserScansione(lAurigaLoginBean.getIdUser() + "");
				}
				lFileInfoBeanOmissis.setAllegatoRiferimento(lGenericFileOmissis);
				lFilePrimarioBean.setIdDocumentoOmissis(bean.getFilePrimarioOmissis().getIdDoc() != null ? new BigDecimal(bean.getFilePrimarioOmissis().getIdDoc()) : null);
				lFilePrimarioBean.setIsNewOrChangedOmissis(StringUtils.isBlank(bean.getFilePrimarioOmissis().getIdDoc()) || (bean.getFilePrimarioOmissis().getIsChanged() != null && bean.getFilePrimarioOmissis().getIsChanged()));
				lFilePrimarioBean.setInfoOmissis(lFileInfoBeanOmissis);				
			}
		}

		GestioneDocumenti lGestioneDocumenti = new GestioneDocumenti();

		salvaAltriSoggettiEsterni(bean, lModificaDocumentoInBean);
		
		// Federico Cacco 13.06.2017
		// Salvo i dati di richiesta accesso atti
		salvaListaAttiRichiestaAccessoAtti(bean, lModificaDocumentoInBean);

		Map<String, Object> valori = bean.getValori() != null ? bean.getValori() : new HashMap<String, Object>();
		Map<String, String> tipiValori = bean.getTipiValori() != null ? bean.getTipiValori() : new HashMap<String, String>();
		SezioneCache sezioneCacheAttributiDinamici = SezioneCacheAttributiDinamici.createSezioneCacheAttributiDinamici(null, valori, tipiValori, getSession());
		salvaAttributiCustom(bean, sezioneCacheAttributiDinamici);
		lModificaDocumentoInBean.setSezioneCacheAttributiDinamici(sezioneCacheAttributiDinamici);

		CreaModDocumentoOutBean lModificaDocumentoOutBean = null;

		if (isPropostaAttoMilano()) {

			CreaModAttoInBean lModificaAttoMilanoInBean = new CreaModAttoInBean();
			ConvertUtils.register(new DateConverter(), Date.class);
			BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lModificaAttoMilanoInBean, lModificaDocumentoInBean);

			// lModificaAttoMilanoInBean.setModificatoDispositivoAtto(bean.getModificatoDispositivoAtto());
			lModificaAttoMilanoInBean.setSceltaIter(bean.getSceltaIter());
			lModificaAttoMilanoInBean.setFlgRichParereRevisori(bean.getFlgRichParereRevisori() != null && bean.getFlgRichParereRevisori() ? Flag.SETTED
					: Flag.NOT_SETTED);
			lModificaAttoMilanoInBean.setSiglaAttoRifSubImpegno(bean.getSiglaAttoRifSubImpegno());
			lModificaAttoMilanoInBean.setNumeroAttoRifSubImpegno(bean.getNumeroAttoRifSubImpegno());
			lModificaAttoMilanoInBean.setAnnoAttoRifSubImpegno(bean.getAnnoAttoRifSubImpegno());
			lModificaAttoMilanoInBean.setDataAttoRifSubImpegno(bean.getDataAttoRifSubImpegno());

			lModificaDocumentoOutBean = lGestioneDocumenti.modificadocumento(getLocale(), lAurigaLoginBean, bean.getIdUd(), bean.getIdDocPrimario(),
					lModificaAttoMilanoInBean, lFilePrimarioBean, lAllegatiBean);

		} else {

			lModificaDocumentoOutBean = lGestioneDocumenti.modificadocumento(getLocale(), lAurigaLoginBean, bean.getIdUd(), bean.getIdDocPrimario(),
					lModificaDocumentoInBean, lFilePrimarioBean, lAllegatiBean);

		}

		if (lModificaDocumentoOutBean.getDefaultMessage() != null) {
			throw new StoreException(lModificaDocumentoOutBean.getDefaultMessage());
		}

		invioNotificheAssegnazioneInvioCC(bean, lModificaDocumentoInBean, true);

		String result = "";
		String[] attributes = new String[2];
		attributes[0] = lModificaDocumentoOutBean.getNumero() != null ? lModificaDocumentoOutBean.getNumero().toString() : "";
		attributes[1] = lModificaDocumentoOutBean.getAnno() != null ? lModificaDocumentoOutBean.getAnno().toString() : "";
		if(isRichiestaAccessoAtti) {
			result = "Richiesta accesso atti modificata con successo";
		} else if (lModificaDocumentoInBean.getFlgTipoProv() == null) {
			result = "Documento modificato con successo";
		} else {
			String userLanguage = getLocale().getLanguage();
			result = MessageUtil.getValue(userLanguage, getSession(), "protocollazione_message_modifica_registrazione_esito_OK_value", attributes);
		}
		bean.setDataProtocollo(lModificaDocumentoOutBean.getData());
		bean.setNroProtocollo(new BigDecimal(lModificaDocumentoOutBean.getNumero() + ""));
		bean.setIdUd(new BigDecimal(lModificaDocumentoOutBean.getIdUd() + ""));
		StringBuffer lStringBuffer = new StringBuffer();
		if (lModificaDocumentoOutBean.getFileInErrors() != null && lModificaDocumentoOutBean.getFileInErrors().size() > 0) {
			lStringBuffer.append(result);
			for (String lStrFileInError : lModificaDocumentoOutBean.getFileInErrors().values()) {
				lStringBuffer.append("; " + lStrFileInError);
			}
			addMessage(lStringBuffer.toString(), "", MessageType.WARNING);
		} else if (!isPropostaAtto()) {
			addMessage(result, "", MessageType.INFO);
		}
		if (lModificaDocumentoOutBean.getSalvataggioMetadatiError() != null && lModificaDocumentoOutBean.getSalvataggioMetadatiError()) {
			addMessage("Si è verificato un errore durante il salvataggio dei metadati su SharePoint", "", MessageType.WARNING);
		}
		
		if(ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_TIMBRATURA_FILE_POST_REG")) {
			apposizioneTimbroPostReg(bean);
		}
		
		return bean;
	}

	private void salvaAssegnatari(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) {
		if (!isPropostaAttoMilano()) {
			List<AssegnatariBean> lListAssegnatari = new ArrayList<AssegnatariBean>();
			// Aggiungo quelli da destinatari e mittenti se ce ne sono
			if (lCreaModDocumentoInBean.getAssegnatari() != null && lCreaModDocumentoInBean.getAssegnatari().size() > 0) {
				lListAssegnatari.addAll(lCreaModDocumentoInBean.getAssegnatari());
			}
			if (bean.getListaAssegnazioni() != null && bean.getListaAssegnazioni().size() > 0) {
				for (AssegnazioneBean lAssegnazioneBean : bean.getListaAssegnazioni()) {
					AssegnatariBean lAssegnatariBean = new AssegnatariBean();
					lAssegnatariBean.setTipo(getTipoAssegnatario(lAssegnazioneBean));
					if (lAssegnatariBean.getTipo() != null && lAssegnatariBean.getTipo().equals(TipoAssegnatario.GRUPPO)) {
						lAssegnatariBean.setIdSettato(lAssegnazioneBean.getGruppo());
					} else {
						lAssegnatariBean.setIdSettato(lAssegnazioneBean.getIdUo());
					}
					lAssegnatariBean.setPermessiAccesso("FC");
					//TODO ASSEGNAZIONE SAVE OK
					if(lAssegnazioneBean.getOpzioniInvio() != null) {																
						lAssegnatariBean.setMotivoInvio(lAssegnazioneBean.getOpzioniInvio().getMotivoInvio());
						lAssegnatariBean.setLivelloPriorita(lAssegnazioneBean.getOpzioniInvio().getLivelloPriorita());
						lAssegnatariBean.setMessaggioInvio(lAssegnazioneBean.getOpzioniInvio().getMessaggioInvio());
						if (lAssegnazioneBean.getOpzioniInvio().getFlgPresaInCarico() != null && lAssegnazioneBean.getOpzioniInvio().getFlgPresaInCarico()) {
							lAssegnatariBean.setFeedback(Flag.SETTED);
						}
						if (lAssegnazioneBean.getOpzioniInvio().getFlgMancataPresaInCarico() != null && lAssegnazioneBean.getOpzioniInvio().getFlgMancataPresaInCarico()) {
							lAssegnatariBean.setNumeroGiorniFeedback(lAssegnazioneBean.getOpzioniInvio().getGiorniTrascorsi());
						}
						if (lAssegnazioneBean.getOpzioniInvio().getFlgInviaFascicolo() != null && lAssegnazioneBean.getOpzioniInvio().getFlgInviaFascicolo()) {
							lAssegnatariBean.setFlgInviaFascicolo(Flag.SETTED);
						}
						if (lAssegnazioneBean.getOpzioniInvio().getFlgInviaDocCollegati() != null && lAssegnazioneBean.getOpzioniInvio().getFlgInviaDocCollegati()) {
							lAssegnatariBean.setFlgInviaDocCollegati(Flag.SETTED);
						}
						if (lAssegnazioneBean.getOpzioniInvio().getFlgMantieniCopiaUd() != null && lAssegnazioneBean.getOpzioniInvio().getFlgMantieniCopiaUd()) {
							lAssegnatariBean.setFlgMantieniCopiaUd(Flag.SETTED);
						}
						if (lAssegnazioneBean.getOpzioniInvio().getFlgMandaNotificaMail() != null && lAssegnazioneBean.getOpzioniInvio().getFlgMandaNotificaMail()) {
							lAssegnatariBean.setFlgMandaNotificaMail(Flag.SETTED);
						}
					}
					addAssegnatarioToList(lListAssegnatari, lAssegnatariBean);
				}
			}
			if(StringUtils.isNotBlank(bean.getPuntoProtAssegnatario())) {
				if(lListAssegnatari.size() == 1) {
					lListAssegnatari.get(0).setPuntoProtocollo(bean.getPuntoProtAssegnatario());
				}
			}
			lCreaModDocumentoInBean.setAssegnatari(lListAssegnatari);
			lCreaModDocumentoInBean.setIdUserConfermaAssegnazione(bean.getIdUserConfermaAssegnazione() != null ? bean.getIdUserConfermaAssegnazione() : "");
		}
	}

	private void salvaInvioDestCC(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) {
		if (!isPropostaAttoMilano()) {
			List<AssegnatariBean> lListInvioDestCC = new ArrayList<AssegnatariBean>();
			if (bean.getListaDestInvioCC() != null && bean.getListaDestInvioCC().size() > 0) {
				for (DestInvioCCBean lDestInvioCCBean : bean.getListaDestInvioCC()) {
					AssegnatariBean lAssegnatariBean = new AssegnatariBean();
					lAssegnatariBean.setTipo(getTipoAssegnatario(lDestInvioCCBean));
					if (lAssegnatariBean.getTipo() != null && lAssegnatariBean.getTipo().equals(TipoAssegnatario.GRUPPO)) {
						lAssegnatariBean.setIdSettato(lDestInvioCCBean.getGruppo());
					} else {
						lAssegnatariBean.setIdSettato(lDestInvioCCBean.getIdUo());
					}
					lAssegnatariBean.setPermessiAccesso("V");
					//TODO CONDIVISIONE SAVE OK
					if(lDestInvioCCBean.getOpzioniInvio() != null) {																
						lAssegnatariBean.setMotivoInvio(lDestInvioCCBean.getOpzioniInvio().getMotivoInvio());
						lAssegnatariBean.setLivelloPriorita(lDestInvioCCBean.getOpzioniInvio().getLivelloPriorita());
						lAssegnatariBean.setMessaggioInvio(lDestInvioCCBean.getOpzioniInvio().getMessaggioInvio());
						if (lDestInvioCCBean.getOpzioniInvio().getFlgInviaFascicolo() != null && lDestInvioCCBean.getOpzioniInvio().getFlgInviaFascicolo()) {
							lAssegnatariBean.setFlgInviaFascicolo(Flag.SETTED);
						}
						if (lDestInvioCCBean.getOpzioniInvio().getFlgInviaDocCollegati() != null && lDestInvioCCBean.getOpzioniInvio().getFlgInviaDocCollegati()) {
							lAssegnatariBean.setFlgInviaDocCollegati(Flag.SETTED);
						}
						if (lDestInvioCCBean.getOpzioniInvio().getFlgMandaNotificaMail() != null && lDestInvioCCBean.getOpzioniInvio().getFlgMandaNotificaMail()) {
							lAssegnatariBean.setFlgMandaNotificaMail(Flag.SETTED);
						}
					}
					if(StringUtils.isNotBlank(lAssegnatariBean.getIdSettato())) {
						lListInvioDestCC.add(lAssegnatariBean);
					}
				}
			}
			lCreaModDocumentoInBean.setInvioDestCC(lListInvioDestCC);
		}
	}

	private void salvaAltreUoCoinvolte(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) {
		List<AltreUoCoinvolteBean> lListAltreUoCoinvolte = new ArrayList<AltreUoCoinvolteBean>();
		if (bean.getListaUoCoinvolte() != null) {
			for (DestInvioCCBean lDestInvioCCBean : bean.getListaUoCoinvolte()) {
				AltreUoCoinvolteBean lAltreUoCoinvolteBean = new AltreUoCoinvolteBean();
				lAltreUoCoinvolteBean.setIdUo(lDestInvioCCBean.getIdUo());
				lListAltreUoCoinvolte.add(lAltreUoCoinvolteBean);
			}
		}
		lCreaModDocumentoInBean.setAltreUoCoinvolte(lListAltreUoCoinvolte);
	}
	
	private void salvaDocumentiCollegati(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) {
		List<DocumentoCollegato> documentiCollegati = new ArrayList<DocumentoCollegato>();
		if(bean.getListaDocumentiDaCollegare() != null && bean.getListaDocumentiDaCollegare().size() > 0) {
			for(DocCollegatoBean docCollegato : bean.getListaDocumentiDaCollegare()) {
				documentiCollegati.add(buildDocumentoCollegatoFromDocCollegatoBean(docCollegato, bean.getAnnoDocRiferimento()));
			}
		} else if(bean.getListaDocumentiCollegati() != null && bean.getListaDocumentiCollegati().size() > 0) {
			for(DocCollegatoBean docCollegato : bean.getListaDocumentiCollegati()) {				
				documentiCollegati.add(buildDocumentoCollegatoFromDocCollegatoBean(docCollegato, bean.getAnnoDocRiferimento()));
			}
		}
		addDocumentoCollegato(lCreaModDocumentoInBean, documentiCollegati);		
	}
	
	public DocumentoCollegato buildDocumentoCollegatoFromDocCollegatoBean(DocCollegatoBean docCollegato, String annoDocRif) {
		DocumentoCollegato lDocumentoCollegato = new DocumentoCollegato();
		lDocumentoCollegato.setAnno(StringUtils.isNotBlank(annoDocRif) ? Integer.valueOf(annoDocRif) : null);
		lDocumentoCollegato.setIdUd(docCollegato.getIdUdCollegata());
		if(docCollegato.getTipo() != null) {
			if(docCollegato.getTipo().equals("PG")) {					
				lDocumentoCollegato.setTipo(TipoProtocollo.PROTOCOLLO_GENERALE);
				lDocumentoCollegato.setSiglaRegistro(null);					
			} else if(docCollegato.getTipo().equals("PI")) {
				lDocumentoCollegato.setTipo(TipoProtocollo.PROTOCOLLO_INTERNO);					
				lDocumentoCollegato.setSiglaRegistro("P.I.");					
			} else if(docCollegato.getTipo().equals("NI")) {
				lDocumentoCollegato.setTipo(TipoProtocollo.PROTOCOLLO_INTERNO);					
				lDocumentoCollegato.setSiglaRegistro("N.I.");					
			} else if(docCollegato.getTipo().equals("PP")) {
				lDocumentoCollegato.setTipo(TipoProtocollo.PROTOCOLLO_PARTICOLARE);					
				lDocumentoCollegato.setSiglaRegistro(docCollegato.getSiglaRegistro());					
			} else if(docCollegato.getTipo().equals("R")) {
				lDocumentoCollegato.setTipo(TipoProtocollo.REPERTORIO);			
				lDocumentoCollegato.setSiglaRegistro(docCollegato.getSiglaRegistro());	
			}
		}
		lDocumentoCollegato.setAnno(docCollegato.getAnno());
		lDocumentoCollegato.setNumero(StringUtils.isNotBlank(docCollegato.getNumero()) ? Integer.valueOf(docCollegato.getNumero()) : null);
		lDocumentoCollegato.setSubNumero(StringUtils.isNotBlank(docCollegato.getSub()) ? Integer.valueOf(docCollegato.getSub()) : null);		       		
   		lDocumentoCollegato.setMotiviCollegamento(docCollegato.getMotivi());
   		return lDocumentoCollegato;
	}
	
	private void salvaAltriRiferimenti(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) {
		List<AltriRiferimentiBean> altriRiferimenti = new ArrayList<AltriRiferimentiBean>();
		if (bean.getListaAltriRiferimenti() != null) {
			for (AltroRifBean altroRif : bean.getListaAltriRiferimenti()) {
				AltriRiferimentiBean altriRifBean = new AltriRiferimentiBean();
				altriRifBean.setRegistroTipoRif(altroRif.getRegistroTipoRif());
				altriRifBean.setNumero(altroRif.getNumero());
				altriRifBean.setAnno(altroRif.getAnno());
				altriRifBean.setData(altroRif.getData());
				altriRifBean.setNote(altroRif.getNote());
				altriRiferimenti.add(altriRifBean);
			}
		}
		lCreaModDocumentoInBean.setAltriRiferimenti(altriRiferimenti);
	}

	private TipoAssegnatario getTipoAssegnatario(DestInvioBean lDestInvioBean) {
		TipoAssegnatario[] lTipoAssegnatarios = TipoAssegnatario.values();
		for (TipoAssegnatario lTipoAssegnatario : lTipoAssegnatarios) {
			if (lTipoAssegnatario.toString().equals(lDestInvioBean.getTypeNodo()))
				return lTipoAssegnatario;
		}
		return null;
	}

	private String getIdSettatoFromMitt(MittenteProtBean lMittenteProtBean) {
		if (StringUtils.isNotBlank(lMittenteProtBean.getIdScrivaniaSoggetto())) {
			return lMittenteProtBean.getIdScrivaniaSoggetto();
		} else if (StringUtils.isNotBlank(lMittenteProtBean.getIdUserSoggetto())) {
			return lMittenteProtBean.getIdUserSoggetto();
		} else if (StringUtils.isNotBlank(lMittenteProtBean.getIdUoSoggetto())) {
			return lMittenteProtBean.getIdUoSoggetto();
		} else
			return null;
	}

	private String getIdSettatoFromDest(DestinatarioProtBean lDestinatarioProtBean) {
		if (StringUtils.isNotBlank(lDestinatarioProtBean.getIdScrivaniaSoggetto())) {
			return lDestinatarioProtBean.getIdScrivaniaSoggetto();
		} else if (StringUtils.isNotBlank(lDestinatarioProtBean.getIdUserSoggetto())) {
			return lDestinatarioProtBean.getIdUserSoggetto();
		} else if (StringUtils.isNotBlank(lDestinatarioProtBean.getIdUoSoggetto())) {
			return lDestinatarioProtBean.getIdUoSoggetto();
		} else
			return null;
	}

	private TipoAssegnatario getTipoAssegnatarioFromMitt(MittenteProtBean lMittenteProtBean) {
		if (StringUtils.isNotBlank(lMittenteProtBean.getIdScrivaniaSoggetto())) {
			return TipoAssegnatario.SCRIVANIA;
		} else if (StringUtils.isNotBlank(lMittenteProtBean.getIdUserSoggetto())) {
			return TipoAssegnatario.UTENTE;
		} else if (StringUtils.isNotBlank(lMittenteProtBean.getIdUoSoggetto())) {
			return TipoAssegnatario.UNITA_ORGANIZZATIVA;
		} else
			return null;
	}

	private TipoAssegnatario getTipoAssegnatarioFromDest(DestinatarioProtBean lDestinatarioProtBean) {
		if (StringUtils.isNotBlank(lDestinatarioProtBean.getIdScrivaniaSoggetto())) {
			return TipoAssegnatario.SCRIVANIA;
		} else if (StringUtils.isNotBlank(lDestinatarioProtBean.getIdUserSoggetto())) {
			return TipoAssegnatario.UTENTE;
		} else if (StringUtils.isNotBlank(lDestinatarioProtBean.getIdUoSoggetto())) {
			return TipoAssegnatario.UNITA_ORGANIZZATIVA;
		} else
			return null;
	}

	protected void salvaMittenti(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) throws Exception {
		List<MittentiDocumentoBean> lListMittenti = new ArrayList<MittentiDocumentoBean>();
		List<AssegnatariBean> lListAssegnatari = new ArrayList<AssegnatariBean>();
		if (lCreaModDocumentoInBean.getAssegnatari() != null && lCreaModDocumentoInBean.getAssegnatari().size() > 0) {
			lListAssegnatari.addAll(lCreaModDocumentoInBean.getAssegnatari());
		}
		if (bean.getListaMittenti() != null && bean.getListaMittenti().size() > 0) {
			for (MittenteProtBean lMittenteProtBean : bean.getListaMittenti()) {
				MittentiDocumentoBean lMittentiBean = new MittentiDocumentoBean();
				if(ParametriDBUtil.getParametroDBAsBoolean(getSession(), "MITT_SOLO_IN_ORGANIGRAMMA") && StringUtils.isNotBlank(lMittenteProtBean.getOrganigrammaMittente())) {
					String typeNode = lMittenteProtBean.getOrganigrammaMittente().substring(0, 2);
					String idUoSv = lMittenteProtBean.getOrganigrammaMittente().substring(2);
					lMittentiBean.setIdSoggetto(idUoSv);
					if(typeNode != null) {
						if(typeNode.equals("UO")) {
							lMittentiBean.setTipoSoggetto("UOI");					
							lMittentiBean.setDenominazioneCognome(lMittenteProtBean.getDenominazioneMittente());
							lMittentiBean.setTipo(TipoMittente.PERSONA_GIURIDICA);								
						} else if(typeNode.equals("SV")) {
							lMittentiBean.setTipoSoggetto("UP");					
							lMittentiBean.setDenominazioneCognome(lMittenteProtBean.getCognomeMittente());
							lMittentiBean.setNome(lMittenteProtBean.getNomeMittente());
							lMittentiBean.setTipo(TipoMittente.PERSONA_FISICA);							
						} 
					}
				} else if (StringUtils.isBlank(lMittenteProtBean.getTipoMittente()) || lMittenteProtBean.getTipoMittente().equals("G")
						|| lMittenteProtBean.getTipoMittente().equals("PG") || lMittenteProtBean.getTipoMittente().equals("PA")
						|| lMittenteProtBean.getTipoMittente().equals("UOI") || lMittenteProtBean.getTipoMittente().equals("AOOE")) {
					lMittentiBean.setDenominazioneCognome(lMittenteProtBean.getDenominazioneMittente());
					lMittentiBean.setTipo(TipoMittente.PERSONA_GIURIDICA);
				} else if (lMittenteProtBean.getTipoMittente().equals("F") || lMittenteProtBean.getTipoMittente().equals("PF")
						|| lMittenteProtBean.getTipoMittente().equals("UP")) {
					lMittentiBean.setDenominazioneCognome(lMittenteProtBean.getCognomeMittente());
					lMittentiBean.setNome(lMittenteProtBean.getNomeMittente());
					lMittentiBean.setTipo(TipoMittente.PERSONA_FISICA);
				}
				lMittentiBean.setCodiceFiscale(lMittenteProtBean.getCodfiscaleMittente());
				lMittentiBean.setEmail(lMittenteProtBean.getEmailMittente());
				lMittentiBean.setTelefono(lMittenteProtBean.getTelMittente());				
				if(StringUtils.isNotBlank(lMittenteProtBean.getIdSoggetto())) {
					lMittentiBean.setIdRubrica(lMittenteProtBean.getIdSoggetto());
				} else if(StringUtils.isNotBlank(lMittenteProtBean.getIdUoSoggetto())) {
					// Quando ho la preimpostazione della UO di lavoro nel mittente delle bozze e della prot. in uscita/interna 
					// mi manca l'idRubrica quindi passo l'idUo nel cod. di provenienza con prefisso [AUR.UO]
					lMittentiBean.setCodProvenienza("[AUR.UO]" + lMittenteProtBean.getIdUoSoggetto());
				}
//				if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_INT_PGWEB") && bean.getFlgTipoProv() != null
//						&& "U".equals(bean.getFlgTipoProv())) {
//
//					DmpkUtilityFindsoggettoinrubricaBean input = new DmpkUtilityFindsoggettoinrubricaBean();
//					input.setIddominioin(AurigaUserUtil.getLoginInfo(getSession()).getSpecializzazioneBean().getIdDominio());
//					input.setFlgsolovldin(1);
//					input.setTsrifin(null);
//					input.setFlgcompletadatidarubrin(1);
//					input.setFlginorganigrammain("UO");
//
//					// IdUserLavoro valorizzato = Utente delegante ( se si
//					// lavora in delega ).
//					// IdUser valorizzato = Utente loggato( se non si lavora in
//					// delega )
//					AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());
//					BigDecimal idUser = lAurigaLoginBean.getIdUser() != null && !"".equals(lAurigaLoginBean.getIdUser()) ? lAurigaLoginBean.getIdUser() : null;
//					input.setIduserlavoroin(StringUtils.isNotBlank(lAurigaLoginBean.getIdUserLavoro()) ? new BigDecimal(lAurigaLoginBean.getIdUserLavoro())
//							: idUser);
//
//					Riga lRiga = new Riga();
//					if (StringUtils.isNotBlank(lMittenteProtBean.getDenominazioneMittente())) {
//						Colonna lColonna = new Colonna();
//						lColonna.setContent(lMittenteProtBean.getDenominazioneMittente() + "%");
//						lColonna.setNro(new BigInteger("1"));
//						lRiga.getColonna().add(lColonna);
//					}
//					if (StringUtils.isNotBlank(lMittenteProtBean.getCodRapidoMittente())) {
//						Colonna lColonna = new Colonna();
//						lColonna.setContent(lMittenteProtBean.getCodRapidoMittente());
//						lColonna.setNro(new BigInteger("27"));
//						lRiga.getColonna().add(lColonna);
//					}
//					Colonna lColonna = new Colonna();
//					lColonna.setContent("UO;UOI");
//					lColonna.setNro(new BigInteger("34"));
//					lRiga.getColonna().add(lColonna);
//
//					StringWriter lStringWriter = new StringWriter();
//					SingletonJAXBContext.getInstance().createMarshaller().marshal(lRiga, lStringWriter);
//					String datiSoggXml = lStringWriter.toString();
//					input.setDatisoggxmlio(datiSoggXml);
//
//					SchemaBean lSchemaBean = new SchemaBean();
//					lSchemaBean.setSchema(lAurigaLoginBean.getSchema());
//					DmpkUtilityFindsoggettoinrubrica lDmpkUtilityFindsoggettoinrubrica = new DmpkUtilityFindsoggettoinrubrica();
//					StoreResultBean<DmpkUtilityFindsoggettoinrubricaBean> output = lDmpkUtilityFindsoggettoinrubrica.execute(getLocale(), lSchemaBean, input);
//					if (output.isInError()) {
//						String errorMessage = "Errore durante il recupero dell'U.O. mittente in organigramma";
//						if (StringUtils.isNotBlank(output.getDefaultMessage())) {
//							errorMessage += ": " + output.getDefaultMessage();
//						}
//						throw new StoreException(errorMessage);
//					}
//					if (StringUtils.isNotBlank(output.getResultBean().getDatisoggxmlio())) {
//						Riga lRigaOut = (Riga) SingletonJAXBContext.getInstance().createUnmarshaller()
//								.unmarshal(new StringReader(output.getResultBean().getDatisoggxmlio()));
//						if (lRigaOut != null) {
//							for (int i = 0; i < lRigaOut.getColonna().size(); i++) {
//								if (lRigaOut.getColonna().get(i).getNro().toString().equals("35")) {
//									lMittentiBean.setProvCIUo(lRigaOut.getColonna().get(i).getContent());
//								}
//							}
//						}
//					}
//					if (StringUtils.isBlank(lMittentiBean.getProvCIUo())) {
//						throw new Exception("U.O. mittente non presente in organigramma o non individuabile univocamente");
//					}
//				}
				if (isAttivoProtocolloWizard(bean)) {
					// dati indirizzo
					lMittentiBean.setStato(lMittenteProtBean.getStato());
					lMittentiBean.setNomeStato(lMittenteProtBean.getNomeStato());
					if (StringUtils.isBlank(lMittentiBean.getStato()) || _COD_ISTAT_ITALIA.equals(lMittentiBean.getStato())
							|| _NOME_STATO_ITALIA.equals(lMittentiBean.getStato())) {
						if (StringUtils.isNotBlank(lMittenteProtBean.getCodToponimo())) {
							lMittentiBean.setCodToponimo(lMittenteProtBean.getCodToponimo());
							lMittentiBean.setToponimoIndirizzo(lMittenteProtBean.getIndirizzo());
							lMittentiBean.setComune(getCodIstatComuneRif());
							lMittentiBean.setNomeComuneCitta(getNomeComuneRif());
						} else {
							lMittentiBean.setTipoToponimo(lMittenteProtBean.getTipoToponimo());
							lMittentiBean.setToponimoIndirizzo(lMittenteProtBean.getToponimo());
							lMittentiBean.setComune(lMittenteProtBean.getComune());
							lMittentiBean.setNomeComuneCitta(lMittenteProtBean.getNomeComune());
						}
						lMittentiBean.setFrazione(lMittenteProtBean.getFrazione());
						lMittentiBean.setCap(lMittenteProtBean.getCap());
					} else {
						lMittentiBean.setToponimoIndirizzo(lMittenteProtBean.getIndirizzo());
						lMittentiBean.setNomeComuneCitta(lMittenteProtBean.getCitta());
					}
					lMittentiBean.setCivico(lMittenteProtBean.getCivico());
					lMittentiBean.setInterno(lMittenteProtBean.getInterno());
					lMittentiBean.setZona(lMittenteProtBean.getZona());
					lMittentiBean.setComplementoIndirizzo(lMittenteProtBean.getComplementoIndirizzo());
					lMittentiBean.setAppendici(lMittenteProtBean.getAppendici());
				}
				lListMittenti.add(lMittentiBean);
				if (lMittenteProtBean.getFlgAssegnaAlMittente() != null && lMittenteProtBean.getFlgAssegnaAlMittente()) {
					AssegnatariBean lAssegnatariBean = new AssegnatariBean();
					lAssegnatariBean.setTipo(getTipoAssegnatarioFromMitt(lMittenteProtBean));
					lAssegnatariBean.setIdSettato(getIdSettatoFromMitt(lMittenteProtBean));
					lAssegnatariBean.setPermessiAccesso("FC");
					//TODO ASSEGNAZIONE SAVE OK
					if (lMittenteProtBean.getOpzioniInvio() != null) {
						lAssegnatariBean.setMotivoInvio(lMittenteProtBean.getOpzioniInvio().getMotivoInvio());
						lAssegnatariBean.setLivelloPriorita(lMittenteProtBean.getOpzioniInvio().getLivelloPriorita());
						lAssegnatariBean.setMessaggioInvio(lMittenteProtBean.getOpzioniInvio().getMessaggioInvio());
						if (lMittenteProtBean.getOpzioniInvio().getFlgPresaInCarico() != null && lMittenteProtBean.getOpzioniInvio().getFlgPresaInCarico()) {
							lAssegnatariBean.setFeedback(Flag.SETTED);
						}
						if (lMittenteProtBean.getOpzioniInvio().getFlgMancataPresaInCarico() != null && lMittenteProtBean.getOpzioniInvio().getFlgMancataPresaInCarico()) {
							lAssegnatariBean.setNumeroGiorniFeedback(lMittenteProtBean.getOpzioniInvio().getGiorniTrascorsi());
						}
						if (lMittenteProtBean.getOpzioniInvio().getFlgInviaFascicolo() != null && lMittenteProtBean.getOpzioniInvio().getFlgInviaFascicolo()) {
							lAssegnatariBean.setFlgInviaFascicolo(Flag.SETTED);
						}
						if (lMittenteProtBean.getOpzioniInvio().getFlgInviaDocCollegati() != null && lMittenteProtBean.getOpzioniInvio().getFlgInviaDocCollegati()) {
							lAssegnatariBean.setFlgInviaDocCollegati(Flag.SETTED);
						}
						if (lMittenteProtBean.getOpzioniInvio().getFlgMantieniCopiaUd() != null && lMittenteProtBean.getOpzioniInvio().getFlgMantieniCopiaUd()) {
							lAssegnatariBean.setFlgMantieniCopiaUd(Flag.SETTED);
						}
						if (lMittenteProtBean.getOpzioniInvio().getFlgMandaNotificaMail() != null && lMittenteProtBean.getOpzioniInvio().getFlgMandaNotificaMail()) {
							lAssegnatariBean.setFlgMandaNotificaMail(Flag.SETTED);
						}
					}
					addAssegnatarioToList(lListAssegnatari, lAssegnatariBean);
				}
			}
		}
		lCreaModDocumentoInBean.setMittenti(lListMittenti);
		lCreaModDocumentoInBean.setAssegnatari(lListAssegnatari);
	}
	
	protected void salvaRichiedentiInterni(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) throws Exception {
		List<MittentiDocumentoBean> lListMittenti = new ArrayList<MittentiDocumentoBean>();
		if (bean.getListaRichiedentiInterni() != null && bean.getListaRichiedentiInterni().size() > 0) {
			for (MittenteProtBean lRichInterno : bean.getListaRichiedentiInterni()) {
				MittentiDocumentoBean lMittentiBean = new MittentiDocumentoBean();
				if (StringUtils.isBlank(lRichInterno.getTipoMittente()) || lRichInterno.getTipoMittente().equals("G")
						|| lRichInterno.getTipoMittente().equals("PG") || lRichInterno.getTipoMittente().equals("PA")
						|| lRichInterno.getTipoMittente().equals("UOI") || lRichInterno.getTipoMittente().equals("AOOE")) {
					lMittentiBean.setDenominazioneCognome(lRichInterno.getDenominazioneMittente());
					lMittentiBean.setTipo(TipoMittente.PERSONA_GIURIDICA);
				} else if (lRichInterno.getTipoMittente().equals("F") || lRichInterno.getTipoMittente().equals("PF")
						|| lRichInterno.getTipoMittente().equals("UP")) {
					lMittentiBean.setDenominazioneCognome(lRichInterno.getCognomeMittente());
					lMittentiBean.setNome(lRichInterno.getNomeMittente());
					lMittentiBean.setTipo(TipoMittente.PERSONA_FISICA);
				}
				lMittentiBean.setCodiceFiscale(lRichInterno.getCodfiscaleMittente());
				lMittentiBean.setEmail(lRichInterno.getEmailMittente());
				lMittentiBean.setTelefono(lRichInterno.getTelMittente());
				if(StringUtils.isNotBlank(lRichInterno.getIdSoggetto())) {
					lMittentiBean.setIdRubrica(lRichInterno.getIdSoggetto());
				} else if(StringUtils.isNotBlank(lRichInterno.getIdUoSoggetto())) {
					// Quando ho la preimpostazione della UO di lavoro nel mittente delle bozze e della prot. in uscita/interna 
					// mi manca l'idRubrica quindi passo l'idUo nel cod. di provenienza con prefisso [AUR.UO]
					lMittentiBean.setCodProvenienza("[AUR.UO]" + lRichInterno.getIdUoSoggetto());
				}		
				lListMittenti.add(lMittentiBean);
			}
		}
		lCreaModDocumentoInBean.setMittenti(lListMittenti);
	}

	private void salvaDestinatari(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) {
		List<DestinatariBean> lListDestinatari = new ArrayList<DestinatariBean>();
		List<DistribuzioneBean> lListGruppi = new ArrayList<DistribuzioneBean>();
		List<AssegnatariBean> lListAssegnatari = new ArrayList<AssegnatariBean>();
		if (lCreaModDocumentoInBean.getAssegnatari() != null && lCreaModDocumentoInBean.getAssegnatari().size() > 0) {
			lListAssegnatari.addAll(lCreaModDocumentoInBean.getAssegnatari());
		}
		if (bean.getListaDestinatari() != null && bean.getListaDestinatari().size() > 0) {
			for (DestinatarioProtBean lDestinatarioProtBean : bean.getListaDestinatari()) {
				if (lDestinatarioProtBean.getTipoDestinatario() != null && lDestinatarioProtBean.getTipoDestinatario().equals("LD")) {
					DistribuzioneBean lDistribuzioneBean = new DistribuzioneBean();
					lDistribuzioneBean.setIdLista(lDestinatarioProtBean.getIdGruppoEsterno());
					if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "SHOW_CC_IN_DEST_REG")) {
						if (lDestinatarioProtBean.getFlgPC() != null && lDestinatarioProtBean.getFlgPC()) {
							lDistribuzioneBean.setPerConoscenza(Flag.SETTED);
						} else {
							lDistribuzioneBean.setPerConoscenza(Flag.NULL);
						}
					}
					lListGruppi.add(lDistribuzioneBean);
				} else if (lDestinatarioProtBean.getTipoDestinatario() != null && lDestinatarioProtBean.getTipoDestinatario().equals("PREF")) {
					DestinatariBean lDestinatariBean = new DestinatariBean();
					if(StringUtils.isNotBlank(lDestinatarioProtBean.getIdSoggetto())) {
						lDestinatariBean.setDenominazioneCognome(lDestinatarioProtBean.getDenominazioneDestinatario());		
						if(lDestinatarioProtBean.getIdSoggetto().startsWith("UO")) {
							lDestinatariBean.setIdRubrica(lDestinatarioProtBean.getIdSoggetto().substring(2));	
						} else if(lDestinatarioProtBean.getIdSoggetto().startsWith("SV")) {
							lDestinatariBean.setIdRubrica(lDestinatarioProtBean.getIdSoggetto().substring(2));	
							lDestinatariBean.setTipo(TipoDestinatario.UNITA_DI_PERSONALE);
						}
						if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "SHOW_CC_IN_DEST_REG")) {
							if (lDestinatarioProtBean.getFlgPC() != null && lDestinatarioProtBean.getFlgPC()) {
								lDestinatariBean.setPerConoscenza(Flag.SETTED);
							} else {
								lDestinatariBean.setPerConoscenza(Flag.NULL);
							}
						}
					}
				} else {
					DestinatariBean lDestinatariBean = new DestinatariBean();
					if (StringUtils.isBlank(lDestinatarioProtBean.getTipoDestinatario()) || lDestinatarioProtBean.getTipoDestinatario().equals("G")
							|| lDestinatarioProtBean.getTipoDestinatario().equals("PG") || lDestinatarioProtBean.getTipoDestinatario().equals("PA")
							|| lDestinatarioProtBean.getTipoDestinatario().equals("UOI") || lDestinatarioProtBean.getTipoDestinatario().equals("AOOE")) {
						lDestinatariBean.setDenominazioneCognome(lDestinatarioProtBean.getDenominazioneDestinatario());
					} else if (lDestinatarioProtBean.getTipoDestinatario().equals("F") || lDestinatarioProtBean.getTipoDestinatario().equals("PF")
							|| lDestinatarioProtBean.getTipoDestinatario().equals("UP")) {
						lDestinatariBean.setDenominazioneCognome(lDestinatarioProtBean.getCognomeDestinatario());
						lDestinatariBean.setNome(lDestinatarioProtBean.getNomeDestinatario());
						lDestinatariBean.setTipo(TipoDestinatario.UNITA_DI_PERSONALE);
					}
					lDestinatariBean.setCodiceFiscale(lDestinatarioProtBean.getCodfiscaleDestinatario());
					if(StringUtils.isNotBlank(lDestinatarioProtBean.getIdSoggetto())) {
						lDestinatariBean.setIdRubrica(lDestinatarioProtBean.getIdSoggetto());
					} else if(StringUtils.isNotBlank(lDestinatarioProtBean.getIdUoSoggetto())) {
						// Quando ho la preimpostazione della UO di lavoro nel destinatario della prot. in entrata 
						// mi manca l'idRubrica quindi passo l'idUo nel cod. di provenienza con prefisso [AUR.UO]
						lDestinatariBean.setCodProvenienza("[AUR.UO]" + lDestinatarioProtBean.getIdUoSoggetto());
					}					
					if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "SHOW_CC_IN_DEST_REG")) {
						if (lDestinatarioProtBean.getFlgPC() != null && lDestinatarioProtBean.getFlgPC()) {
							lDestinatariBean.setPerConoscenza(Flag.SETTED);
						} else {
							lDestinatariBean.setPerConoscenza(Flag.NULL);
						}
					}
					if (isAttivoProtocolloWizard(bean)) {
						// dati indirizzo
						lDestinatariBean.setStato(lDestinatarioProtBean.getStato());
						lDestinatariBean.setNomeStato(lDestinatarioProtBean.getNomeStato());
						if (StringUtils.isBlank(lDestinatariBean.getStato()) || _COD_ISTAT_ITALIA.equals(lDestinatariBean.getStato())
								|| _NOME_STATO_ITALIA.equals(lDestinatariBean.getStato())) {
							if (StringUtils.isNotBlank(lDestinatarioProtBean.getCodToponimo())) {
								lDestinatariBean.setCodToponimo(lDestinatarioProtBean.getCodToponimo());
								lDestinatariBean.setToponimoIndirizzo(lDestinatarioProtBean.getIndirizzo());
								lDestinatariBean.setComune(getCodIstatComuneRif());
								lDestinatariBean.setNomeComuneCitta(getNomeComuneRif());
							} else {
								lDestinatariBean.setTipoToponimo(lDestinatarioProtBean.getTipoToponimo());
								lDestinatariBean.setToponimoIndirizzo(lDestinatarioProtBean.getToponimo());
								lDestinatariBean.setComune(lDestinatarioProtBean.getComune());
								lDestinatariBean.setNomeComuneCitta(lDestinatarioProtBean.getNomeComune());
							}
							lDestinatariBean.setFrazione(lDestinatarioProtBean.getFrazione());
							lDestinatariBean.setCap(lDestinatarioProtBean.getCap());
						} else {
							lDestinatariBean.setToponimoIndirizzo(lDestinatarioProtBean.getIndirizzo());
							lDestinatariBean.setNomeComuneCitta(lDestinatarioProtBean.getCitta());
						}
						lDestinatariBean.setCivico(lDestinatarioProtBean.getCivico());
						lDestinatariBean.setInterno(lDestinatarioProtBean.getInterno());
						lDestinatariBean.setZona(lDestinatarioProtBean.getZona());
						lDestinatariBean.setComplementoIndirizzo(lDestinatarioProtBean.getComplementoIndirizzo());
						lDestinatariBean.setAppendici(lDestinatarioProtBean.getAppendici());
					} else if (lDestinatarioProtBean.getMezzoTrasmissioneDestinatario() != null) {
						// Salvo il mezzo di trasmissione
						MezzoTrasmissioneDestinatarioBean lMezzoTrasmissioneDestinatarioBean = new MezzoTrasmissioneDestinatarioBean();
						lMezzoTrasmissioneDestinatarioBean = lDestinatarioProtBean.getMezzoTrasmissioneDestinatario();
						lDestinatariBean.setMezzoTrasmissioneDestinatario(lMezzoTrasmissioneDestinatarioBean.getMezzoTrasmissioneDestinatario());
						lDestinatariBean.setDataRaccomandataDestinatario(lMezzoTrasmissioneDestinatarioBean.getDataRaccomandataDestinatario());
						lDestinatariBean.setDataNotificaDestinatario(lMezzoTrasmissioneDestinatarioBean.getDataNotificaDestinatario());
						lDestinatariBean.setNroNotificaDestinatario(lMezzoTrasmissioneDestinatarioBean.getNroNotificaDestinatario());
						lDestinatariBean.setNroRaccomandataDestinatario(lMezzoTrasmissioneDestinatarioBean.getNroRaccomandataDestinatario());
						lDestinatariBean.setToponimoIndirizzo(lMezzoTrasmissioneDestinatarioBean.getIndirizzo());
						lDestinatariBean.setFrazione(lMezzoTrasmissioneDestinatarioBean.getFrazione());
						lDestinatariBean.setCivico(lMezzoTrasmissioneDestinatarioBean.getCivico());
						lDestinatariBean.setInterno(lMezzoTrasmissioneDestinatarioBean.getInterno());
						lDestinatariBean.setScala(lMezzoTrasmissioneDestinatarioBean.getScala());
						lDestinatariBean.setPiano(lMezzoTrasmissioneDestinatarioBean.getPiano());
						lDestinatariBean.setCap(lMezzoTrasmissioneDestinatarioBean.getCap());
						lDestinatariBean.setComune(lMezzoTrasmissioneDestinatarioBean.getCodIstatComune());
						lDestinatariBean.setNomeComuneCitta(lMezzoTrasmissioneDestinatarioBean.getComune());
						lDestinatariBean.setStato(lMezzoTrasmissioneDestinatarioBean.getCodIstatStato());
						lDestinatariBean.setNomeStato(lMezzoTrasmissioneDestinatarioBean.getStato());
						lDestinatariBean.setZona(lMezzoTrasmissioneDestinatarioBean.getZona());
						lDestinatariBean.setComplementoIndirizzo(lMezzoTrasmissioneDestinatarioBean.getComplementoIndirizzo());
						lDestinatariBean.setAppendici(lMezzoTrasmissioneDestinatarioBean.getAppendici());
						lDestinatariBean.setTipoToponimo(lMezzoTrasmissioneDestinatarioBean.getTipoToponimo());
						lDestinatariBean.setCodToponimo(lMezzoTrasmissioneDestinatarioBean.getCiToponimo());
						lDestinatariBean.setToponimoIndirizzo(lMezzoTrasmissioneDestinatarioBean.getIndirizzo());
						lDestinatariBean.setIndirizzoDestinatario(lMezzoTrasmissioneDestinatarioBean.getIndirizzoDestinatario());
					}
					lListDestinatari.add(lDestinatariBean);
					if (lDestinatarioProtBean.getFlgAssegnaAlDestinatario() != null && lDestinatarioProtBean.getFlgAssegnaAlDestinatario()) {
						AssegnatariBean lAssegnatariBean = new AssegnatariBean();
						lAssegnatariBean.setTipo(getTipoAssegnatarioFromDest(lDestinatarioProtBean));
						lAssegnatariBean.setIdSettato(getIdSettatoFromDest(lDestinatarioProtBean));
						lAssegnatariBean.setPermessiAccesso("FC");
						//TODO ASSEGNAZIONE SAVE OK
						if (lDestinatarioProtBean.getOpzioniInvio() != null) {
							lAssegnatariBean.setMotivoInvio(lDestinatarioProtBean.getOpzioniInvio().getMotivoInvio());
							lAssegnatariBean.setLivelloPriorita(lDestinatarioProtBean.getOpzioniInvio().getLivelloPriorita());
							lAssegnatariBean.setMessaggioInvio(lDestinatarioProtBean.getOpzioniInvio().getMessaggioInvio());
							if (lDestinatarioProtBean.getOpzioniInvio().getFlgPresaInCarico() != null && lDestinatarioProtBean.getOpzioniInvio().getFlgPresaInCarico()) {
								lAssegnatariBean.setFeedback(Flag.SETTED);
							}
							if (lDestinatarioProtBean.getOpzioniInvio().getFlgMancataPresaInCarico() != null && lDestinatarioProtBean.getOpzioniInvio().getFlgMancataPresaInCarico()) {
								lAssegnatariBean.setNumeroGiorniFeedback(lDestinatarioProtBean.getOpzioniInvio().getGiorniTrascorsi());
							}
							if (lDestinatarioProtBean.getOpzioniInvio().getFlgInviaFascicolo() != null && lDestinatarioProtBean.getOpzioniInvio().getFlgInviaFascicolo()) {
								lAssegnatariBean.setFlgInviaFascicolo(Flag.SETTED);
							}
							if (lDestinatarioProtBean.getOpzioniInvio().getFlgInviaDocCollegati() != null && lDestinatarioProtBean.getOpzioniInvio().getFlgInviaDocCollegati()) {
								lAssegnatariBean.setFlgInviaDocCollegati(Flag.SETTED);
							}
							if (lDestinatarioProtBean.getOpzioniInvio().getFlgMantieniCopiaUd() != null && lDestinatarioProtBean.getOpzioniInvio().getFlgMantieniCopiaUd()) {
								lAssegnatariBean.setFlgMantieniCopiaUd(Flag.SETTED);
							}
							if (lDestinatarioProtBean.getOpzioniInvio().getFlgMandaNotificaMail() != null && lDestinatarioProtBean.getOpzioniInvio().getFlgMandaNotificaMail()) {
								lAssegnatariBean.setFlgMandaNotificaMail(Flag.SETTED);
							}
						}
						addAssegnatarioToList(lListAssegnatari, lAssegnatariBean);
					}
				}
			}
		}
		lCreaModDocumentoInBean.setDestinatari(lListDestinatari);
		lCreaModDocumentoInBean.setGruppi(lListGruppi);
		lCreaModDocumentoInBean.setAssegnatari(lListAssegnatari);
	}

	public void addAssegnatarioToList(List<AssegnatariBean> lListAssegnatari, AssegnatariBean lAssegnatariBean) {
		if (lAssegnatariBean != null && StringUtils.isNotBlank(lAssegnatariBean.getIdSettato())) {
			boolean trovato = false;
			if (lListAssegnatari == null) {
				lListAssegnatari = new ArrayList<AssegnatariBean>();
			} else if (lListAssegnatari.size() > 0) {
				for (int i = 0; i < lListAssegnatari.size(); i++) {
					if (lListAssegnatari.get(i).getIdSettato() != null && lListAssegnatari.get(i).getIdSettato().equals(lAssegnatariBean.getIdSettato())) {
						trovato = true;
						break;
					}
				}
			}
			if (!trovato) {
				lListAssegnatari.add(lAssegnatariBean);
			}
		}
	}

	protected void salvaAltriSoggettiEsterni(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) throws Exception {

		List<SoggettoEsternoBean> lListAltriSoggettiEsterni = null;
		if (isAttivoEsibente(bean) && bean.getListaEsibenti() != null) {
			if (lListAltriSoggettiEsterni == null) {
				lListAltriSoggettiEsterni = new ArrayList<SoggettoEsternoBean>();
			}
			for (SoggEsternoProtBean lEsibenteProtBean : bean.getListaEsibenti()) {
				SoggettoEsternoBean lSoggettoEsternoBean = new SoggettoEsternoBean();
				lSoggettoEsternoBean.setFlgPersFisica(Flag.SETTED);
				lSoggettoEsternoBean.setIdSoggetto(lEsibenteProtBean.getIdSoggetto());
				lSoggettoEsternoBean.setTipoSoggetto(lEsibenteProtBean.getTipoSoggetto());
				lSoggettoEsternoBean.setDenominazioneCognome(lEsibenteProtBean.getCognome());
				lSoggettoEsternoBean.setNome(lEsibenteProtBean.getNome());
				lSoggettoEsternoBean.setCodFiscale(lEsibenteProtBean.getCodFiscale());
				lSoggettoEsternoBean.setTipoDocRiconoscimento(lEsibenteProtBean.getTipoDocRiconoscimento());
				lSoggettoEsternoBean.setEstremiDocRiconoscimento(lEsibenteProtBean.getEstremiDocRiconoscimento());
				// dati indirizzo
				lSoggettoEsternoBean.setStato(lEsibenteProtBean.getStato());
				lSoggettoEsternoBean.setNomeStato(lEsibenteProtBean.getNomeStato());
				if (StringUtils.isBlank(lSoggettoEsternoBean.getStato()) || _COD_ISTAT_ITALIA.equals(lSoggettoEsternoBean.getStato())
						|| _NOME_STATO_ITALIA.equals(lSoggettoEsternoBean.getStato())) {
					if (StringUtils.isNotBlank(lEsibenteProtBean.getCodToponimo())) {
						lSoggettoEsternoBean.setCodToponimo(lEsibenteProtBean.getCodToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lEsibenteProtBean.getIndirizzo());
						lSoggettoEsternoBean.setComune(getCodIstatComuneRif());
						lSoggettoEsternoBean.setNomeComuneCitta(getNomeComuneRif());
					} else {
						lSoggettoEsternoBean.setTipoToponimo(lEsibenteProtBean.getTipoToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lEsibenteProtBean.getToponimo());
						lSoggettoEsternoBean.setComune(lEsibenteProtBean.getComune());
						lSoggettoEsternoBean.setNomeComuneCitta(lEsibenteProtBean.getNomeComune());
					}
					lSoggettoEsternoBean.setFrazione(lEsibenteProtBean.getFrazione());
					lSoggettoEsternoBean.setCap(lEsibenteProtBean.getCap());
				} else {
					lSoggettoEsternoBean.setToponimoIndirizzo(lEsibenteProtBean.getIndirizzo());
					lSoggettoEsternoBean.setNomeComuneCitta(lEsibenteProtBean.getCitta());
				}
				lSoggettoEsternoBean.setCivico(lEsibenteProtBean.getCivico());
				lSoggettoEsternoBean.setInterno(lEsibenteProtBean.getInterno());
				lSoggettoEsternoBean.setZona(lEsibenteProtBean.getZona());
				lSoggettoEsternoBean.setComplementoIndirizzo(lEsibenteProtBean.getComplementoIndirizzo());
				lSoggettoEsternoBean.setAppendici(lEsibenteProtBean.getAppendici());
				// natura relazione
				lSoggettoEsternoBean.setCodNaturaRel("E");
				if(lEsibenteProtBean.getFlgAncheMittente() != null && lEsibenteProtBean.getFlgAncheMittente()) {
					lSoggettoEsternoBean.setFlgAncheMittente(Flag.SETTED);
				}
				if (StringUtils.isNotBlank(lSoggettoEsternoBean.getDenominazioneCognome()) && StringUtils.isNotBlank(lSoggettoEsternoBean.getNome())) {
					lListAltriSoggettiEsterni.add(lSoggettoEsternoBean);
				}
			}
		}
		if (isAttivoInteressati(bean) && bean.getListaInteressati() != null) {
			if (lListAltriSoggettiEsterni == null) {
				lListAltriSoggettiEsterni = new ArrayList<SoggettoEsternoBean>();
			}
			for (SoggEsternoProtBean lInteressatoProtBean : bean.getListaInteressati()) {
				SoggettoEsternoBean lSoggettoEsternoBean = new SoggettoEsternoBean();
				lSoggettoEsternoBean.setIdSoggetto(lInteressatoProtBean.getIdSoggetto());
				lSoggettoEsternoBean.setTipoSoggetto(lInteressatoProtBean.getTipoSoggetto());
				if (StringUtils.isBlank(lInteressatoProtBean.getTipoSoggetto()) || lInteressatoProtBean.getTipoSoggetto().equals("G")
						|| lInteressatoProtBean.getTipoSoggetto().equals("PG") || lInteressatoProtBean.getTipoSoggetto().equals("PA")
						|| lInteressatoProtBean.getTipoSoggetto().equals("AOOE")) {
					lSoggettoEsternoBean.setFlgPersFisica(Flag.NOT_SETTED);
					lSoggettoEsternoBean.setDenominazioneCognome(lInteressatoProtBean.getDenominazione());
				} else if (lInteressatoProtBean.getTipoSoggetto().equals("F") || lInteressatoProtBean.getTipoSoggetto().equals("PF")) {
					lSoggettoEsternoBean.setFlgPersFisica(Flag.SETTED);
					lSoggettoEsternoBean.setDenominazioneCognome(lInteressatoProtBean.getCognome());
					lSoggettoEsternoBean.setNome(lInteressatoProtBean.getNome());
				}
				lSoggettoEsternoBean.setCodFiscale(lInteressatoProtBean.getCodFiscale());
				// dati indirizzo
				lSoggettoEsternoBean.setStato(lInteressatoProtBean.getStato());
				lSoggettoEsternoBean.setNomeStato(lInteressatoProtBean.getNomeStato());
				if (StringUtils.isBlank(lSoggettoEsternoBean.getStato()) || _COD_ISTAT_ITALIA.equals(lSoggettoEsternoBean.getStato())
						|| _NOME_STATO_ITALIA.equals(lSoggettoEsternoBean.getStato())) {
					if (StringUtils.isNotBlank(lInteressatoProtBean.getCodToponimo())) {
						lSoggettoEsternoBean.setCodToponimo(lInteressatoProtBean.getCodToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lInteressatoProtBean.getIndirizzo());
						lSoggettoEsternoBean.setComune(getCodIstatComuneRif());
						lSoggettoEsternoBean.setNomeComuneCitta(getNomeComuneRif());
					} else {
						lSoggettoEsternoBean.setTipoToponimo(lInteressatoProtBean.getTipoToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lInteressatoProtBean.getToponimo());
						lSoggettoEsternoBean.setComune(lInteressatoProtBean.getComune());
						lSoggettoEsternoBean.setNomeComuneCitta(lInteressatoProtBean.getNomeComune());
					}
					lSoggettoEsternoBean.setFrazione(lInteressatoProtBean.getFrazione());
					lSoggettoEsternoBean.setCap(lInteressatoProtBean.getCap());
				} else {
					lSoggettoEsternoBean.setToponimoIndirizzo(lInteressatoProtBean.getIndirizzo());
					lSoggettoEsternoBean.setNomeComuneCitta(lInteressatoProtBean.getCitta());
				}
				lSoggettoEsternoBean.setCivico(lInteressatoProtBean.getCivico());
				lSoggettoEsternoBean.setInterno(lInteressatoProtBean.getInterno());
				lSoggettoEsternoBean.setZona(lInteressatoProtBean.getZona());
				lSoggettoEsternoBean.setComplementoIndirizzo(lInteressatoProtBean.getComplementoIndirizzo());
				lSoggettoEsternoBean.setAppendici(lInteressatoProtBean.getAppendici());
				// natura relazione
				lSoggettoEsternoBean.setCodNaturaRel("I");
				if (StringUtils.isNotBlank(lSoggettoEsternoBean.getDenominazioneCognome())
						&& (lSoggettoEsternoBean.getFlgPersFisica() != Flag.SETTED || StringUtils.isNotBlank(lSoggettoEsternoBean.getNome()))) {
					lListAltriSoggettiEsterni.add(lSoggettoEsternoBean);
				}
			}
		}
		if (bean.getListaContribuenti() != null) {
			if (lListAltriSoggettiEsterni == null) {
				lListAltriSoggettiEsterni = new ArrayList<SoggettoEsternoBean>();
			}
			for (ContribuenteBean lContribuenteBean : bean.getListaContribuenti()) {
				SoggettoEsternoBean lSoggettoEsternoBean = new SoggettoEsternoBean();
				lSoggettoEsternoBean.setIdSoggetto(lContribuenteBean.getIdSoggetto());
				lSoggettoEsternoBean.setTipoSoggetto(lContribuenteBean.getTipoSoggetto());
				if (StringUtils.isBlank(lContribuenteBean.getTipoSoggetto()) || lContribuenteBean.getTipoSoggetto().equals("G")
						|| lContribuenteBean.getTipoSoggetto().equals("PG") || lContribuenteBean.getTipoSoggetto().equals("PA")
						|| lContribuenteBean.getTipoSoggetto().equals("AOOE")) {
					lSoggettoEsternoBean.setFlgPersFisica(Flag.NOT_SETTED);
					lSoggettoEsternoBean.setDenominazioneCognome(lContribuenteBean.getDenominazione());
				} else if (lContribuenteBean.getTipoSoggetto().equals("F") || lContribuenteBean.getTipoSoggetto().equals("PF")) {
					lSoggettoEsternoBean.setFlgPersFisica(Flag.SETTED);
					lSoggettoEsternoBean.setDenominazioneCognome(lContribuenteBean.getCognome());
					lSoggettoEsternoBean.setNome(lContribuenteBean.getNome());
				}
				lSoggettoEsternoBean.setCodFiscale(lContribuenteBean.getCodFiscale());
				lSoggettoEsternoBean.setTipoDocRiconoscimento(lContribuenteBean.getTipoDocRiconoscimento());
				lSoggettoEsternoBean.setEstremiDocRiconoscimento(lContribuenteBean.getEstremiDocRiconoscimento());
				// dati indirizzo
				lSoggettoEsternoBean.setStato(lContribuenteBean.getStato());
				lSoggettoEsternoBean.setNomeStato(lContribuenteBean.getNomeStato());
				if (StringUtils.isBlank(lSoggettoEsternoBean.getStato()) || _COD_ISTAT_ITALIA.equals(lSoggettoEsternoBean.getStato())
						|| _NOME_STATO_ITALIA.equals(lSoggettoEsternoBean.getStato())) {
					if (StringUtils.isNotBlank(lContribuenteBean.getCodToponimo())) {
						lSoggettoEsternoBean.setCodToponimo(lContribuenteBean.getCodToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lContribuenteBean.getIndirizzo());
						lSoggettoEsternoBean.setComune(getCodIstatComuneRif());
						lSoggettoEsternoBean.setNomeComuneCitta(getNomeComuneRif());
					} else {
						lSoggettoEsternoBean.setTipoToponimo(lContribuenteBean.getTipoToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lContribuenteBean.getToponimo());
						lSoggettoEsternoBean.setComune(lContribuenteBean.getComune());
						lSoggettoEsternoBean.setNomeComuneCitta(lContribuenteBean.getNomeComune());
					}
					lSoggettoEsternoBean.setFrazione(lContribuenteBean.getFrazione());
					lSoggettoEsternoBean.setCap(lContribuenteBean.getCap());
				} else {
					lSoggettoEsternoBean.setToponimoIndirizzo(lContribuenteBean.getIndirizzo());
					lSoggettoEsternoBean.setNomeComuneCitta(lContribuenteBean.getCitta());
				}
				lSoggettoEsternoBean.setCivico(lContribuenteBean.getCivico());
				lSoggettoEsternoBean.setInterno(lContribuenteBean.getInterno());
				lSoggettoEsternoBean.setZona(lContribuenteBean.getZona());
				lSoggettoEsternoBean.setComplementoIndirizzo(lContribuenteBean.getComplementoIndirizzo());
				lSoggettoEsternoBean.setAppendici(lContribuenteBean.getAppendici());
				lSoggettoEsternoBean.setProvCISogg(lContribuenteBean.getCodiceACS()); // codice
																						// ACS
				lSoggettoEsternoBean.setEmailContribuente(lContribuenteBean.getEmailContribuente()); // email
																										// contribuente
				lSoggettoEsternoBean.setCodNaturaRel("CL"); // natura relazione

				if (StringUtils.isNotBlank(lSoggettoEsternoBean.getDenominazioneCognome())
						&& (lSoggettoEsternoBean.getFlgPersFisica() != Flag.SETTED || StringUtils.isNotBlank(lSoggettoEsternoBean.getNome()))) {
					lListAltriSoggettiEsterni.add(lSoggettoEsternoBean);
				}
			}
		}
		// Cacco Federico 13.06.2017
		// Richiesta accesso atti - richiedenti delegati
		if (bean.getListaRichiedentiDelegati() != null) {
			if (lListAltriSoggettiEsterni == null) {
				lListAltriSoggettiEsterni = new ArrayList<SoggettoEsternoBean>();
			}
			for (SoggEsternoProtBean lInteressatoProtBean : bean.getListaRichiedentiDelegati()) {
				SoggettoEsternoBean lSoggettoEsternoBean = new SoggettoEsternoBean();
				lSoggettoEsternoBean.setIdSoggetto(lInteressatoProtBean.getIdSoggetto());
				lSoggettoEsternoBean.setTipoSoggetto(lInteressatoProtBean.getTipoSoggetto());
				if (StringUtils.isBlank(lInteressatoProtBean.getTipoSoggetto()) || lInteressatoProtBean.getTipoSoggetto().equals("G")
						|| lInteressatoProtBean.getTipoSoggetto().equals("PG") || lInteressatoProtBean.getTipoSoggetto().equals("PA")
						|| lInteressatoProtBean.getTipoSoggetto().equals("AOOE")) {
					lSoggettoEsternoBean.setFlgPersFisica(Flag.NOT_SETTED);
					lSoggettoEsternoBean.setDenominazioneCognome(lInteressatoProtBean.getDenominazione());
				} else if (lInteressatoProtBean.getTipoSoggetto().equals("F") || lInteressatoProtBean.getTipoSoggetto().equals("PF")) {
					lSoggettoEsternoBean.setFlgPersFisica(Flag.SETTED);
					lSoggettoEsternoBean.setDenominazioneCognome(lInteressatoProtBean.getCognome());
					lSoggettoEsternoBean.setNome(lInteressatoProtBean.getNome());
				}
				lSoggettoEsternoBean.setCodFiscale(lInteressatoProtBean.getCodFiscale());
				// dati indirizzo
				lSoggettoEsternoBean.setStato(lInteressatoProtBean.getStato());
				lSoggettoEsternoBean.setNomeStato(lInteressatoProtBean.getNomeStato());
				if (StringUtils.isBlank(lSoggettoEsternoBean.getStato()) || _COD_ISTAT_ITALIA.equals(lSoggettoEsternoBean.getStato())
						|| _NOME_STATO_ITALIA.equals(lSoggettoEsternoBean.getStato())) {
					if (StringUtils.isNotBlank(lInteressatoProtBean.getCodToponimo())) {
						lSoggettoEsternoBean.setCodToponimo(lInteressatoProtBean.getCodToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lInteressatoProtBean.getIndirizzo());
						lSoggettoEsternoBean.setComune(getCodIstatComuneRif());
						lSoggettoEsternoBean.setNomeComuneCitta(getNomeComuneRif());
					} else {
						lSoggettoEsternoBean.setTipoToponimo(lInteressatoProtBean.getTipoToponimo());
						lSoggettoEsternoBean.setToponimoIndirizzo(lInteressatoProtBean.getToponimo());
						lSoggettoEsternoBean.setComune(lInteressatoProtBean.getComune());
						lSoggettoEsternoBean.setNomeComuneCitta(lInteressatoProtBean.getNomeComune());
					}
					lSoggettoEsternoBean.setFrazione(lInteressatoProtBean.getFrazione());
					lSoggettoEsternoBean.setCap(lInteressatoProtBean.getCap());
				} else {
					lSoggettoEsternoBean.setToponimoIndirizzo(lInteressatoProtBean.getIndirizzo());
					lSoggettoEsternoBean.setNomeComuneCitta(lInteressatoProtBean.getCitta());
				}
				lSoggettoEsternoBean.setCivico(lInteressatoProtBean.getCivico());
				lSoggettoEsternoBean.setInterno(lInteressatoProtBean.getInterno());
				lSoggettoEsternoBean.setZona(lInteressatoProtBean.getZona());
				lSoggettoEsternoBean.setComplementoIndirizzo(lInteressatoProtBean.getComplementoIndirizzo());
				lSoggettoEsternoBean.setAppendici(lInteressatoProtBean.getAppendici());
				// natura relazione
				lSoggettoEsternoBean.setCodNaturaRel("DEL");
				// email e telefono
				lSoggettoEsternoBean.setTelefonoContribuente(lInteressatoProtBean.getTel());
				lSoggettoEsternoBean.setEmailContribuente(lInteressatoProtBean.getEmail());
				if (StringUtils.isNotBlank(lSoggettoEsternoBean.getDenominazioneCognome())
						&& (lSoggettoEsternoBean.getFlgPersFisica() != Flag.SETTED || StringUtils.isNotBlank(lSoggettoEsternoBean.getNome()))) {
					lListAltriSoggettiEsterni.add(lSoggettoEsternoBean);
				}
			}
		}	
		
		// Cacco Federico 19.06.2017
		// Richiesta accesso atti - ufficio richiedente
		if ((StringUtils.isNotBlank(bean.getCognomeIncaricatoPrelievoPerUffRichiedente())) && (StringUtils.isNotBlank(bean.getNomeIncaricatoPrelievoPerUffRichiedente()))){
			// Salvo la lista dell'incaricato del prelievo per l'ufficio richiedente
			if (lListAltriSoggettiEsterni == null) {
				lListAltriSoggettiEsterni = new ArrayList<SoggettoEsternoBean>();
			}
			SoggettoEsternoBean lSoggettoEsternoBean = new SoggettoEsternoBean();
			lSoggettoEsternoBean.setIdSoggetto(bean.getIdIncaricatoPrelievoPerUffRichiedente());
			// Sono sempre unità personale
			lSoggettoEsternoBean.setTipoSoggetto("UP");				
			lSoggettoEsternoBean.setFlgPersFisica(Flag.SETTED);
			// natura relazione
			lSoggettoEsternoBean.setCodNaturaRel("IRIT");
			// dati richiedente
			lSoggettoEsternoBean.setTipoRichiedente("U");	
			lSoggettoEsternoBean.setDenominazioneCognome(bean.getCognomeIncaricatoPrelievoPerUffRichiedente());
			lSoggettoEsternoBean.setNome(bean.getNomeIncaricatoPrelievoPerUffRichiedente());
			lSoggettoEsternoBean.setCodiceRapido(bean.getCodRapidoIncaricatoPrelievoPerUffRichiedente());
			lSoggettoEsternoBean.setTelefonoContribuente(bean.getTelefonoIncaricatoPrelievoPerUffRichiedente());
			lListAltriSoggettiEsterni.add(lSoggettoEsternoBean);
		}
		
		// Cacco Federico 19.06.2017
		// Richiesta accesso atti - richiedente esterno
		if ((StringUtils.isNotBlank(bean.getCognomeIncaricatoPrelievoPerRichEsterno())) && (StringUtils.isNotBlank(bean.getCognomeIncaricatoPrelievoPerRichEsterno()))) {
			// Salvo la lista dell'incaricato del prelievo per il richiedenre esterno
			if (lListAltriSoggettiEsterni == null) {
				lListAltriSoggettiEsterni = new ArrayList<SoggettoEsternoBean>();
			}
			SoggettoEsternoBean lSoggettoEsternoBean = new SoggettoEsternoBean();
			// Sono sempre persone fisiche
			lSoggettoEsternoBean.setTipoSoggetto("PF");				
			lSoggettoEsternoBean.setFlgPersFisica(Flag.SETTED);
			// natura relazione
			lSoggettoEsternoBean.setCodNaturaRel("IRIT");
			// dati richiedente
			lSoggettoEsternoBean.setTipoRichiedente("E");	
			lSoggettoEsternoBean.setDenominazioneCognome(bean.getCognomeIncaricatoPrelievoPerRichEsterno());
			lSoggettoEsternoBean.setNome(bean.getNomeIncaricatoPrelievoPerRichEsterno());				
			lSoggettoEsternoBean.setCodFiscale(bean.getCodiceFiscaleIncaricatoPrelievoPerRichEsterno());
			lSoggettoEsternoBean.setTelefonoContribuente(bean.getTelefonoIncaricatoPrelievoPerRichEsterno());
			lSoggettoEsternoBean.setEmailContribuente(bean.getEmailIncaricatoPrelievoPerRichEsterno());				
			lListAltriSoggettiEsterni.add(lSoggettoEsternoBean);
		}
		
		lCreaModDocumentoInBean.setAltriSoggettiEsterni(lListAltriSoggettiEsterni);
	}
	
	protected void salvaListaAttiRichiestaAccessoAtti(ProtocollazioneBean bean, CreaModDocumentoInBean lCreaModDocumentoInBean) throws Exception {	
		// Salvo gli atti richiesti. Se non ho atti devo comunque passare una lista vuota
		List<AttiRichiestiXMLBean> lAttiRichiestiXMLBeans = new ArrayList<AttiRichiestiXMLBean>();
		if (bean.getListaAttiRichiesti() != null){
			// Ho degli atti richiesti
			logProtDS.debug("Salvo gli atti richiesti");
			for (AttiRichiestiBean attoRichiestoBean : bean.getListaAttiRichiesti()) {
				
				boolean attoVuoto = true;
				
				AttiRichiestiXMLBean attoRichiestoXMLBean = new AttiRichiestiXMLBean();				
				attoRichiestoXMLBean.setTipoProtocollo(attoRichiestoBean.getTipoProtocollo());
				
				if(StringUtils.isBlank(attoRichiestoBean.getTipoProtocollo()) || "PG".equals(attoRichiestoBean.getTipoProtocollo())) {
					if (!hasProtocolloGeneraleEmpty(attoRichiestoBean)){
						attoVuoto = false;
						attoRichiestoXMLBean.setNumeroProtocollo(attoRichiestoBean.getNumProtocolloGenerale());
						attoRichiestoXMLBean.setAnnoProtocollo(attoRichiestoBean.getAnnoProtocolloGenerale());
					}
				} else {
					if (!hasProtocolloSettoreEmpty(attoRichiestoBean)){
						attoVuoto = false;	
						attoRichiestoXMLBean.setRegProtocolloDiSettore(attoRichiestoBean.getSiglaProtocolloSettore());
						attoRichiestoXMLBean.setNumeroProtocollo(attoRichiestoBean.getNumProtocolloSettore());
						attoRichiestoXMLBean.setSubProtocolloDiSettore(attoRichiestoBean.getSubProtocolloSettore());
						attoRichiestoXMLBean.setAnnoProtocollo(attoRichiestoBean.getAnnoProtocolloSettore());
					}
				}		
				if (!attoVuoto){
					attoRichiestoXMLBean.setClassifica(attoRichiestoBean.getClassifica());
					attoRichiestoXMLBean.setStatoScansione(attoRichiestoBean.getStatoScansione());
					attoRichiestoXMLBean.setIdFolder(attoRichiestoBean.getIdFolder());
					attoRichiestoXMLBean.setStato(attoRichiestoBean.getStato());
					if ((StringUtils.isNotBlank(attoRichiestoBean.getStato())) && (attoRichiestoBean.getStato().toLowerCase().indexOf("presente") > -1)){
						// Salvo udc
						attoRichiestoXMLBean.setUdc(attoRichiestoBean.getUdc());
					} else if ((StringUtils.isNotBlank(attoRichiestoBean.getStato())) && (attoRichiestoBean.getStato().toLowerCase().indexOf("prelevato") > -1)){
						// Salvo udc
						attoRichiestoXMLBean.setUdc(attoRichiestoBean.getUdc());
						// Salvo l'ufficio prelievo
						attoRichiestoXMLBean.setDenUffPrelievo(attoRichiestoBean.getDescrizioneUfficioPrelievo());
						attoRichiestoXMLBean.setCodUffPrelievo(attoRichiestoBean.getCodRapidoUfficioPrelievo());
						attoRichiestoXMLBean.setIdUoPrelievo(attoRichiestoBean.getIdUoUfficioPrelievo());
						// Salvo data prelievo
						attoRichiestoXMLBean.setDataPrelievo(attoRichiestoBean.getDataPrelievo());
						// Salvo responsabile prelievo
						attoRichiestoXMLBean.setIdUserRespPrelievo(attoRichiestoBean.getIdUserResponsabilePrelievo());
						attoRichiestoXMLBean.setCognomeRespPrelievo(attoRichiestoBean.getCognomeResponsabilePrelievo());
						attoRichiestoXMLBean.setNomeRespPrelievo(attoRichiestoBean.getNomeResponsabilePrelievo());
						attoRichiestoXMLBean.setUsernameRespPrelievo(attoRichiestoBean.getUsernameResponsabilePrelievo());
	//					attoRichiestoXMLBean.setCodRapidoUsernameRespPrelievo(attoRichiestoBean.getCodRapidoUfficioPrelievo());
					}
					attoRichiestoXMLBean.setNoteUffRichiedente(attoRichiestoBean.getNoteUffRichiedente());
					attoRichiestoXMLBean.setNoteCittadella(attoRichiestoBean.getNoteCittadella());
					
					attoRichiestoXMLBean.setCompetenzaDiUrbanistica(attoRichiestoBean.getCompetenzaDiUrbanistica());
					attoRichiestoXMLBean.setCartaceoReperibile(attoRichiestoBean.getCartaceoReperibile());
					attoRichiestoXMLBean.setInArchivio(attoRichiestoBean.getInArchivio());
					attoRichiestoXMLBean.setFlgRichiestaVisioneCartaceo(attoRichiestoBean.getFlgRichiestaVisioneCartaceo() != null && attoRichiestoBean.getFlgRichiestaVisioneCartaceo() ? "1" : "0");
					
					lAttiRichiestiXMLBeans.add(attoRichiestoXMLBean);
				}
			}
		}
		lCreaModDocumentoInBean.setAttiRichiesti(lAttiRichiestiXMLBeans);
	}
	
	protected boolean hasProtocolloGeneraleEmpty(AttiRichiestiBean attoRichiestoBean) {

		boolean hasNumProtocolloGeneraleEmpty = StringUtil.isBlank(attoRichiestoBean.getNumProtocolloGenerale());
		boolean hasAnnoProtocolloGeneraleEmpty = StringUtil.isBlank(attoRichiestoBean.getAnnoProtocolloGenerale());
		return hasNumProtocolloGeneraleEmpty && hasAnnoProtocolloGeneraleEmpty;
	}

	protected boolean hasProtocolloSettoreEmpty(AttiRichiestiBean attoRichiestoBean) {

		boolean hasSiglaProtocolloSettoreEmpty = StringUtil.isBlank(attoRichiestoBean.getSiglaProtocolloSettore());
		boolean hasNumProtocolloSettoreEmpty = StringUtil.isBlank(attoRichiestoBean.getNumProtocolloSettore());
		boolean hasAnnoProtocolloSettoreEmpty = StringUtil.isBlank(attoRichiestoBean.getAnnoProtocolloSettore());
		return hasSiglaProtocolloSettoreEmpty || hasNumProtocolloSettoreEmpty || hasAnnoProtocolloSettoreEmpty;
	}
	
	protected void salvaAttributiCustom(ProtocollazioneBean bean, SezioneCache sezioneCacheAttributiDinamici) throws Exception {		
		salvaAttributiCustomSemplici(bean, sezioneCacheAttributiDinamici);
		salvaAttributiCustomLista(bean, sezioneCacheAttributiDinamici);
	}
	
	protected void salvaAttributiCustomSemplici(ProtocollazioneBean bean, SezioneCache sezioneCacheAttributiDinamici) throws Exception {
		
		if (isAttivoProtocolloWizard(bean)) {
			sezioneCacheAttributiDinamici.getVariabile().add(
					SezioneCacheAttributiDinamici.createVariabileSemplice("FLG_ORIGINALE_CARTACEO_Doc",
							bean.getFlgOriginaleCartaceo() != null && bean.getFlgOriginaleCartaceo() ? "1" : "0"));
			sezioneCacheAttributiDinamici.getVariabile().add(
					SezioneCacheAttributiDinamici.createVariabileSemplice("FLG_COPIA_SOSTITUTIVA_Doc",
							bean.getFlgCopiaSostitutiva() != null && bean.getFlgCopiaSostitutiva() ? "1" : "0"));
		}
		
		if (isClienteComuneMilano()) {
			//Identificativo di workflow
//			if(StringUtils.isNotBlank(bean.getSiglaIdentificativoWF())) {
//				sezioneCacheAttributiDinamici.getVariabile().add(
//					SezioneCacheAttributiDinamici.createVariabileSemplice("SEZIONALE_ONLYONE_Doc", 
//						bean.getSiglaIdentificativoWF() != null  ? bean.getSiglaIdentificativoWF() : ""));
//			}
			if(StringUtils.isNotBlank(bean.getNroIdentificativoWF())) {
				sezioneCacheAttributiDinamici.getVariabile().add(
					SezioneCacheAttributiDinamici.createVariabileSemplice("NRO_ONLYONE_Doc", 
							bean.getNroIdentificativoWF() != null  ? bean.getNroIdentificativoWF() : ""));
			}
			if(StringUtils.isNotBlank(bean.getAnnoIdentificativoWF())) {
				sezioneCacheAttributiDinamici.getVariabile().add(
					SezioneCacheAttributiDinamici.createVariabileSemplice("ANNO_ONLYONE_Doc", 
							bean.getAnnoIdentificativoWF() != null  ? bean.getAnnoIdentificativoWF() : ""));
			}
			if(bean.getFlgCaricamentoPGPregressoDaGUI() != null && bean.getFlgCaricamentoPGPregressoDaGUI()) {
				sezioneCacheAttributiDinamici.getVariabile().add(
					SezioneCacheAttributiDinamici.createVariabileSemplice("FLG_CARICAMENTO_PG_PREGRESSO_DA_GUI_Ud", "1"));
			}
		}

		// Salvo il responsabile del procedimento
		if (ParametriDBUtil.getParametroDBAsBoolean(getSession(), "SHOW_RESP_PROC_IN_ATTI")) {
			sezioneCacheAttributiDinamici.getVariabile().add(
					SezioneCacheAttributiDinamici.createVariabileSemplice("ID_USER_RESP_PROC_Ud", bean.getIdUserRespProc()));
		}
		
		// Se sono in richiesta accesso atti e il richiedente è interno
		if (isRichiestaAccessoAttiRichiedenteInterno(bean)){
			sezioneCacheAttributiDinamici.getVariabile().add(SezioneCacheAttributiDinamici.createVariabileSemplice("RICH_ACCESSO_ATTI_CON_RICH_INTERNO_Doc", "1"));
		}
				
		// Salvo motivo e dettagli della richista accesso atti
		if (StringUtils.isNotBlank(bean.getMotivoRichiestaAccessoAtti())){
			sezioneCacheAttributiDinamici.getVariabile().add(SezioneCacheAttributiDinamici.createVariabileSemplice("MOTIVO_RICHIESTA_ACCESSO_ATTI_Doc", bean.getMotivoRichiestaAccessoAtti()));
		}
		
		if (StringUtils.isNotBlank(bean.getDettagliRichiestaAccessoAtti())){
			sezioneCacheAttributiDinamici.getVariabile().add(SezioneCacheAttributiDinamici.createVariabileSemplice("DETTAGLI_RICHIESTA_ACCESSO_ATTI_Doc", bean.getDettagliRichiestaAccessoAtti()));
		}
		
		if (StringUtils.isNotBlank(ParametriDBUtil.getParametroDB(getSession(), "DOC_PRESSO_CENTRO_POSTA"))) {
			sezioneCacheAttributiDinamici.getVariabile().add(SezioneCacheAttributiDinamici.createVariabileSemplice("PRESSO_CENTRO_POSTA_Ud", StringUtils.isNotBlank(bean.getDocPressoCentroPosta()) ? bean.getDocPressoCentroPosta() : ""));
		}
	}

	protected void salvaAttributiCustomLista(ProtocollazioneBean bean, SezioneCache sezioneCacheAttributiDinamici) throws Exception {
		if (isAttivoProtocolloWizard(bean) || isAttivoAltreVieSenzaWizard() || isRichiestaAccessoAtti()) {
			if (bean.getListaAltreVie() != null) {
				ArrayList<AltreUbicazioniBean> lListAltreUbicazioni = new ArrayList<AltreUbicazioniBean>();
				for (AltraViaProtBean lAltraViaProtBean : bean.getListaAltreVie()) {
					AltreUbicazioniBean lAltreUbicazioniBean = new AltreUbicazioniBean();
					lAltreUbicazioniBean.setStato(lAltraViaProtBean.getStato());
					lAltreUbicazioniBean.setNomeStato(lAltraViaProtBean.getNomeStato());
					if (StringUtils.isBlank(lAltreUbicazioniBean.getStato()) || _COD_ISTAT_ITALIA.equals(lAltreUbicazioniBean.getStato())
							|| _NOME_STATO_ITALIA.equals(lAltreUbicazioniBean.getStato())) {
						if (StringUtils.isNotBlank(lAltraViaProtBean.getCodToponimo())) {
							lAltreUbicazioniBean.setCodToponimo(lAltraViaProtBean.getCodToponimo());
							lAltreUbicazioniBean.setToponimoIndirizzo(lAltraViaProtBean.getIndirizzo());
							lAltreUbicazioniBean.setComune(getCodIstatComuneRif());
							lAltreUbicazioniBean.setNomeComuneCitta(getNomeComuneRif());
						} else {
							lAltreUbicazioniBean.setTipoToponimo(lAltraViaProtBean.getTipoToponimo());
							lAltreUbicazioniBean.setToponimoIndirizzo(lAltraViaProtBean.getToponimo());
							lAltreUbicazioniBean.setComune(lAltraViaProtBean.getComune());
							lAltreUbicazioniBean.setNomeComuneCitta(lAltraViaProtBean.getNomeComune());
						}
						lAltreUbicazioniBean.setFrazione(lAltraViaProtBean.getFrazione());
						lAltreUbicazioniBean.setCap(lAltraViaProtBean.getCap());
					} else {
						lAltreUbicazioniBean.setToponimoIndirizzo(lAltraViaProtBean.getIndirizzo());
						lAltreUbicazioniBean.setNomeComuneCitta(lAltraViaProtBean.getCitta());
					}
					lAltreUbicazioniBean.setCivico(lAltraViaProtBean.getCivico());
					lAltreUbicazioniBean.setAppendici(lAltraViaProtBean.getAppendici());
					lAltreUbicazioniBean.setZona(lAltraViaProtBean.getZona());
					lAltreUbicazioniBean.setComplementoIndirizzo(lAltraViaProtBean.getComplementoIndirizzo());

					lListAltreUbicazioni.add(lAltreUbicazioniBean);
				}
				sezioneCacheAttributiDinamici.getVariabile().add(
						SezioneCacheAttributiDinamici.createVariabileLista("ALTRE_UBICAZIONI_Doc",
								new XmlUtilitySerializer().createVariabileLista(lListAltreUbicazioni)));
			}
		}
	}

	public ProtocollazioneBean cancellazioneFisica(ProtocollazioneBean bean) throws Exception {
		AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());

		DmpkCoreDel_ud_doc_verBean delUdDocVerInput = new DmpkCoreDel_ud_doc_verBean();
		delUdDocVerInput.setFlgtipotargetin("U");
		delUdDocVerInput.setIduddocin(bean.getIdUd());
		delUdDocVerInput.setFlgcancfisicain(new Integer(1));

		DmpkCoreDel_ud_doc_ver delUdDocVer = new DmpkCoreDel_ud_doc_ver();
		StoreResultBean<DmpkCoreDel_ud_doc_verBean> output = delUdDocVer.execute(getLocale(), loginBean, delUdDocVerInput);

		if (StringUtils.isNotBlank(output.getDefaultMessage())) {
			if (output.isInError()) {
				throw new StoreException(output.getDefaultMessage());
			} else {
				addMessage(output.getDefaultMessage(), "", MessageType.WARNING);
			}
		}
		return bean;
	}

	@Override
	public ProtocollazioneBean remove(ProtocollazioneBean bean) throws Exception {
		return null;
	}

	@Override
	public PaginatorBean<ProtocollazioneBean> fetch(AdvancedCriteria criteria, Integer startRow, Integer endRow, List<OrderByBean> orderby) throws Exception {
		return null;
	}

	@Override
	public Map<String, ErrorBean> validate(ProtocollazioneBean bean) throws Exception {
		return null;
	}

	private TipoNumerazioneBean creaTipoProtocolloGenerale(ProtocollazioneBean bean) {

		if (bean.getProtocolloGenerale() != null && bean.getProtocolloGenerale()) {
			
			TipoNumerazioneBean lTipoProtocolloGenerale = new TipoNumerazioneBean();
			
			lTipoProtocolloGenerale.setCategoria("PG");
			lTipoProtocolloGenerale.setIdUo(StringUtils.isNotBlank(bean.getUoProtocollante()) ? bean.getUoProtocollante().substring(2) : null);
			
			return lTipoProtocolloGenerale;			
		}
		
		return null;
	}
	
	private TipoNumerazioneBean creaTipoAltraNumerazione(ProtocollazioneBean bean) {

		if(StringUtils.isNotBlank(bean.getCodCategoriaAltraNumerazione()) || StringUtils.isNotBlank(bean.getSiglaAltraNumerazione())) {
			
			TipoNumerazioneBean lTipoAltraNumerazioneBean = new TipoNumerazioneBean();
			
			lTipoAltraNumerazioneBean.setCategoria(bean.getCodCategoriaAltraNumerazione());
			lTipoAltraNumerazioneBean.setSigla(bean.getSiglaAltraNumerazione());
			lTipoAltraNumerazioneBean.setIdUo(StringUtils.isNotBlank(bean.getUoProtocollante()) ? bean.getUoProtocollante().substring(2) : null);
			
			return lTipoAltraNumerazioneBean;
		}
		
		return null;
	}

	public ExportBean stampaFileCertificazione(AttachmentBean attachment) throws Exception {

		boolean aggiungiFirma = Boolean.parseBoolean(getExtraparams().get("aggiungiFirma"));

		String processId = getExtraparams().get("processId");

		Date dataRiferimento = null;

		if(ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_DATA_RIF_VERIFICA_FIRMA")) {
			String dataRiferimentoString = getExtraparams().get("dataRiferimento");
			if (dataRiferimentoString != null && !"".equals(dataRiferimentoString)) {
				SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy");
				dataRiferimento = sdf.parse(dataRiferimentoString);
			}
		}		

		MimeTypeFirmaBean infoFile = attachment.getInfoFileAttach();

		File realFile = StorageImplementation.getStorage().getRealFile(attachment.getUriAttach());
		String fileUrl = realFile.toURI().toString();

		FirmaUtility lFirmaUtility = new FirmaUtility();
		File file = lFirmaUtility.creaFileCertificazione(fileUrl, infoFile.getCorrectFileName(), infoFile, aggiungiFirma, processId, dataRiferimento);

		ExportBean exportBean = new ExportBean();

		if (file != null) {

			exportBean.setTempFileOut(StorageImplementation.getStorage().store(file));

			MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
			lMimeTypeFirmaBean.setCorrectFileName("Certificazione.pdf");
			lMimeTypeFirmaBean.setFirmato(false);
			lMimeTypeFirmaBean.setFirmaValida(false);
			lMimeTypeFirmaBean.setConvertibile(true);
			lMimeTypeFirmaBean.setDaScansione(false);
			lMimeTypeFirmaBean.setMimetype("application/pdf");
			exportBean.setInfoFileOut(lMimeTypeFirmaBean);

		}
		return exportBean;
	}

	/**
	 * Genera un archivio contenente tutti i documenti contenuti nell'unità documentale e nelle relative sotto unità
	 * 
	 * @param unitaDoc
	 * @return
	 * @throws Exception
	 */
	public DownloadDocsZipBean generateDocsZip(ProtocollazioneBean downloadDocZipBean) throws Exception {

		String errorLimiteZip = getExtraparams().get("limiteMaxZipError");
		// nome dei file presenti nello zip, i quali devono essere univoci
		Map<String, Integer> zipFileNames = new HashMap<String, Integer>();

		InfoFileUtility lInfoFileUtility = new InfoFileUtility();

		String tempPath = System.getProperty("java.io.tmpdir") + System.getProperty("file.separator");

		String segnatura = escapeSegnatura(getExtraparams().get("segnatura"));

		// nome dello zip
		File zipFile = new File(tempPath + "File_doc_" + segnatura + ".zip");

		int codice = addDocumentToZip(downloadDocZipBean, zipFileNames, lInfoFileUtility, tempPath, zipFile, segnatura);

		try {

			DownloadDocsZipBean retValue = new DownloadDocsZipBean();

			if (codice == OK) {
				String zipUri = StorageImplementation.getStorage().store(zipFile);
				retValue.setStorageZipRemoteUri(zipUri);
				retValue.setZipName(zipFile.getName());
				MimeTypeFirmaBean infoFile = new MimeTypeFirmaBean();
				infoFile.setBytes(zipFile.length());
				retValue.setInfoFile(infoFile);
			} else if (codice == SUPERATO_LIMITE) {
				retValue.setMessage(errorLimiteZip);
			} else if (codice == NESSUN_FILE) {
				retValue.setMessage("Nessun documento con file è presente nella selezione");
			}

			return retValue;
		} finally {
			// una volta salvato in storage lo posso eliminare localmente
			deleteLocalCopy(zipFile);
		}
	}

	/**
	 * @param segnatura
	 * @return
	 */
	protected String escapeSegnatura(String segnatura) {
		if (segnatura != null) {
			segnatura = segnatura.replace(" ", "_");
			segnatura = segnatura.replace(".", "_");
			segnatura = segnatura.replace("\\", "_");
			segnatura = segnatura.replace("/", "_");
		} else {
			Calendar currentDate = Calendar.getInstance();

			segnatura = Integer.toString(currentDate.get(Calendar.DAY_OF_WEEK)) + "_" + Integer.toString(currentDate.get(Calendar.HOUR))
					+ Integer.toString(currentDate.get(Calendar.MINUTE)) + Integer.toString(currentDate.get(Calendar.SECOND))
					+ Integer.toString(currentDate.get(Calendar.MILLISECOND));
		}
		return segnatura;
	}

	/**
	 * Aggiunge l'unità documentaria specificata allo zip fornito
	 * 
	 * @param downloadDocZipBean
	 * @param zipFileNames
	 * @param lInfoFileUtility
	 * @param tempPath
	 * @param zipFile
	 * @throws Exception
	 */
	protected int addDocumentToZip(ProtocollazioneBean downloadDocZipBean, Map<String, Integer> zipFileNames, InfoFileUtility lInfoFileUtility,
			String tempPath, File zipFile, String segnatura) throws Exception {

		String filePrimarioUri = downloadDocZipBean.getUriFilePrimario();
		DocumentBean filePrimarioOmissis = downloadDocZipBean.getFilePrimarioOmissis();

		boolean vuoto = true;

		String maxSize = ParametriDBUtil.getParametroDB(getSession(), "MAX_SIZE_ZIP");

		int MAX_SIZE = (maxSize != null && maxSize.length() > 0 ? Integer.decode(maxSize) : 104857600);
		long lengthZip = 0;

		// rinomino il file scaricato da storage con il nome originale
		if (filePrimarioUri != null ) {
			if (filePrimarioOmissis.getUriFile() != null ) {
				// il file primario ha sia versione omissis che integrale

				if ( filePrimarioOmissis.getInfoFile() != null ) {
					lengthZip += filePrimarioOmissis.getInfoFile().getBytes();

					if (lengthZip > MAX_SIZE) {

						return SUPERATO_LIMITE;
					}

					String nomeFilePrimarioOmissis = segnatura + "- File primario – Ver. con omissis – "
							+ filePrimarioOmissis.getNomeFile();

					addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile, filePrimarioOmissis.getUriFile(),
							filePrimarioOmissis.getInfoFile().isFirmato(), nomeFilePrimarioOmissis);

					vuoto = false;
				}

				if ( downloadDocZipBean.getInfoFile() != null) {
					lengthZip += downloadDocZipBean.getInfoFile().getBytes();

					if (lengthZip > MAX_SIZE) {
						return SUPERATO_LIMITE;
					}

					String nomeFilePrimarioIntegrale = segnatura + "- File primario – Ver. integrale – "
							+ downloadDocZipBean.getNomeFilePrimario();

					addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile,
							downloadDocZipBean.getUriFilePrimario(), downloadDocZipBean.getInfoFile().isFirmato(),
							nomeFilePrimarioIntegrale);

					vuoto = false;
				}
			} else {
				// il file primario ha solo versione integrale
				if ( downloadDocZipBean.getInfoFile() != null) {

					lengthZip += downloadDocZipBean.getInfoFile().getBytes();

					if (lengthZip > MAX_SIZE) {

						return SUPERATO_LIMITE;
					}

					String nomeFilePrimarioIntegrale = segnatura + "- File primario – " + downloadDocZipBean.getNomeFilePrimario();
					addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile, downloadDocZipBean.getUriFilePrimario(), downloadDocZipBean.getInfoFile().isFirmato(), nomeFilePrimarioIntegrale);

					vuoto = false;
				}
			}
		} else if (filePrimarioOmissis.getUriFile() != null ) {
			// il file primario ha solo versione omissis
			if ( filePrimarioOmissis.getInfoFile() != null ) {

				lengthZip += filePrimarioOmissis.getInfoFile().getBytes();

				if (lengthZip > MAX_SIZE) {

					return SUPERATO_LIMITE;
				}

				String nomeFilePrimarioOmissis = segnatura + "- File primario – Ver. con omissis – " + filePrimarioOmissis.getNomeFile();
				addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile, filePrimarioOmissis.getUriFile(), filePrimarioOmissis.getInfoFile().isFirmato(), nomeFilePrimarioOmissis);

				vuoto = false;
			}
		}
		
		List<AllegatoProtocolloBean> allegati = downloadDocZipBean.getListaAllegati();

		if (allegati != null) {

			for (AllegatoProtocolloBean allegato : allegati) {
				if ((allegato.getNomeFileAllegato() == null || allegato.getNomeFileAllegato().isEmpty()) && 
						(allegato.getNomeFileOmissis() == null || allegato.getNomeFileOmissis().isEmpty()) ) {

					// non esiste un file associato all'allegato corrente, nè omissis nè integrale
					continue;
				}
				
				if (allegato.getNomeFileAllegato() != null && !allegato.getNomeFileAllegato().isEmpty()) {
					
					if(allegato.getNomeFileOmissis() == null || allegato.getNomeFileOmissis().isEmpty()) {
						// Se ho solo la versione integrale dell'allegato
						if (allegato.getInfoFile() != null) {
							lengthZip += allegato.getInfoFile().getBytes();

							if (lengthZip > MAX_SIZE) {
								return SUPERATO_LIMITE;
							}

							String attachmentFileName = segnatura + "- Allegato N° "+ allegato.getNumeroProgrAllegato() +" - " + allegato.getNomeFileAllegato();
							addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile, allegato.getUriFileAllegato(), allegato.getInfoFile().isFirmato(), attachmentFileName);
							vuoto = false;
						}
					} else {
						if (allegato.getInfoFile() != null) {
							// Se ho sia versione integrale che versione con omissis dell'allegato
							lengthZip += allegato.getInfoFile().getBytes();
							if (lengthZip > MAX_SIZE) {
								return SUPERATO_LIMITE;
							}
							String attachmentFileNameIntegrale = segnatura + "- Allegato N° " + allegato.getNumeroProgrAllegato() + " – Ver. integrale – "
									+ allegato.getNomeFileAllegato();
							addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile, allegato.getUriFileAllegato(), allegato.getInfoFile().isFirmato(),
									attachmentFileNameIntegrale);
							vuoto = false;
						}
						
						if(allegato.getInfoFileOmissis() != null) {
							lengthZip += allegato.getInfoFileOmissis().getBytes();

							if (lengthZip > MAX_SIZE) {
								return SUPERATO_LIMITE;
							}

							String attachmentFileNameOmissis = segnatura + "- Allegato N° "+ allegato.getNumeroProgrAllegato() +" – Ver. con omissis – " + allegato.getNomeFileOmissis();
							addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile, allegato.getUriFileOmissis(), allegato.getInfoFileOmissis().isFirmato(), attachmentFileNameOmissis);
							vuoto = false;
						}
					}
				} else {
					// Se ho solo la versione con omissis
					if(allegato.getInfoFileOmissis() != null) {
						lengthZip += allegato.getInfoFileOmissis().getBytes();

						if (lengthZip > MAX_SIZE) {
							return SUPERATO_LIMITE;
						}

						String attachmentFileNameOmissis = segnatura + "- Allegato N° "+ allegato.getNumeroProgrAllegato() +" – Ver. con omissis – " + allegato.getNomeFileOmissis();
						addFileToZip(zipFileNames, lInfoFileUtility, tempPath, zipFile, allegato.getUriFileOmissis(), allegato.getInfoFileOmissis().isFirmato(), attachmentFileNameOmissis);
						vuoto = false;
					}
				}
			}
		}

		return vuoto ? NESSUN_FILE : OK;
	}

	private void addFileToZip(Map<String, Integer> zipFileNames, InfoFileUtility lInfoFileUtility, String tempPath,
			File zipFile, String uriFileAllegato, Boolean isFirmato, String attachmentFileName) throws Exception, StorageException {
		
		boolean duplicated = zipFileNames.containsKey(attachmentFileName);
		attachmentFileName = checkAndRenameDuplicate(zipFileNames, attachmentFileName);

		File currentAttachment = new File(tempPath + attachmentFileName);
		FileUtil.writeStreamToFile(StorageImplementation.getStorage().extract(uriFileAllegato), currentAttachment);

		StorageUtil.addFileToZip(currentAttachment, zipFile.getAbsolutePath());
		
		String estensione = FilenameUtils.getExtension(currentAttachment.getName());

		if (isFirmato && estensione.equals("p7m")) {
			int index = -1;
			if (duplicated)
				index = zipFileNames.get(attachmentFileName);

			sbustaAddDocumentToZip(currentAttachment, zipFile, lInfoFileUtility, tempPath, duplicated, index);
		}
		// il documento è stato aggiunto allo zip, posso eliminare la
		// copia locale
		deleteLocalCopy(currentAttachment);
	}

	/**
	 * Sbusta il file e lo aggiunge allo zip specificato
	 * 
	 * @param signedFile
	 * @param zipFile
	 * @param lInfoFileUtility
	 * @param tempPath
	 * @param duplicated
	 * @param index
	 * @throws Exception
	 */
	private String sbustaAddDocumentToZip(File signedFile, File zipFile, InfoFileUtility lInfoFileUtility, String tempPath, boolean duplicated, Integer index)
			throws Exception {

		String signedFileName = signedFile.getName();
		String displayFilename = signedFileName.substring(0, signedFileName.length() - 4);
		String[] tokens = displayFilename.split("\\.");
		
		String tempFileName = "";
		for (int i = 0; i < tokens.length-1; i++) {
			tempFileName += tokens[i] + ".";
		}
		displayFilename = tempFileName + (duplicated ? "_" + index : "") + (tokens.length > 1 ? tokens[tokens.length-1] : "");

		InputStream sbustatoStream = lInfoFileUtility.sbusta(signedFile, displayFilename);

		File currentAttachmentSbustato = new File(tempPath + displayFilename);
		FileUtil.writeStreamToFile(sbustatoStream, currentAttachmentSbustato);

		// aggiungo il file sbustato allo zip
		StorageUtil.addFileToZip(currentAttachmentSbustato, zipFile.getAbsolutePath());

		// il documento è stato aggiunto allo zip, posso eliminare la copia
		// locale
		deleteLocalCopy(currentAttachmentSbustato);

		return displayFilename;

	}

	protected void deleteLocalCopy(File localCopy) {
		try {
			FileDeleteStrategy.FORCE.delete(localCopy);
		} catch (Exception e) {
			logProtDS.error(String.format("Non è stato possibile cancellare il file %1$s, si è verificata la seguente eccezione", localCopy.getAbsoluteFile()),
					e);
		}
	}

	private String checkAndRenameDuplicate(Map<String, Integer> zipFileNames, String attachmentFileName) {

		boolean duplicated = zipFileNames.containsKey(attachmentFileName);
		Integer index = 0;

		if (duplicated) {
			int x = zipFileNames.get(attachmentFileName);
			String attachmentFileNameoriginale = attachmentFileName;
			while (zipFileNames.containsKey(attachmentFileName)) {
				attachmentFileName = normalizeDuplicate(attachmentFileNameoriginale, x);
				x++;
			}
			zipFileNames.put(attachmentFileName, index);
		} else {
			zipFileNames.put(attachmentFileName, index);
		}

		return attachmentFileName;
	}

	private String normalizeDuplicate(String value, Integer index) {

		String[] tokens = value.split("\\.");
		String attachmentFileName = "";
		if (tokens.length >= 2) {
			for (int x = 0; x < tokens.length - 1; x++)
				attachmentFileName += "." + tokens[x];

			attachmentFileName += "_" + index + "." + tokens[tokens.length - 1];
			// tolgo il primo punto
			attachmentFileName = attachmentFileName.substring(1, attachmentFileName.length());
		} else
			attachmentFileName = tokens[0] + "_" + index + (tokens.length > 1 ? "." + tokens[1] : "");

		return attachmentFileName;
	}

	public DownloadDocsZipBean generateGlobalDocsZip(OperazioneMassivaArchivioBean beanMassivo) throws Exception {

		String errorMessage = getExtraparams().get("messageError");
		String errorLimiteZip = getExtraparams().get("limiteMaxZipError");
		int codice = OK;
		// nome dei file presenti nello zip, i quali devono essere univoci
		Map<String, Integer> zipFileNames = new HashMap<String, Integer>();
		InfoFileUtility lInfoFileUtility = new InfoFileUtility();

		String tempPath = System.getProperty("java.io.tmpdir") + System.getProperty("file.separator");
		
		// nome dello zip
		DateFormat df = new SimpleDateFormat("dd_MM_YYYY");
		Date today = Calendar.getInstance().getTime();
		String sDate = df.format(today);
		
		String nomeFileZip = "FileSelezioneDocumenti_del_" + sDate + "_id_" + Integer.toString(Math.abs(ThreadLocalRandom.current().nextInt())) + ".zip";
		
		File zipFile = new File(tempPath + nomeFileZip);

		List<ArchivioBean> documentsList = beanMassivo.getListaRecord();
		

		for (ArchivioBean archivioBean : documentsList) {

			ProtocollazioneBean protocollazioneBean = new ProtocollazioneBean();
			protocollazioneBean.setIdUd(new BigDecimal(archivioBean.getIdUdFolder()));

			ProtocollazioneBean currentDocument = null;
			try {
				currentDocument = get(protocollazioneBean);
			} catch (StoreException e) {
				DownloadDocsZipBean retValue = new DownloadDocsZipBean();
				retValue.setMessage(errorMessage);
			}

			// Viene verificata la presenza di file per il documento corrente.
			codice = addDocumentToZip(currentDocument, zipFileNames, lInfoFileUtility, tempPath, zipFile, escapeSegnatura(archivioBean.getSegnatura()));

			if (codice == SUPERATO_LIMITE)
				break;
			else if (codice != NESSUN_FILE)// se entra almeno una volta qui c'è
											// un file
				codice = OK;
		}

		try {
			DownloadDocsZipBean retValue = new DownloadDocsZipBean();

			if (codice == OK) {
				String zipUri = StorageImplementation.getStorage().store(zipFile);
				retValue.setStorageZipRemoteUri(zipUri);
				retValue.setZipName(zipFile.getName());

			} else if (codice == NESSUN_FILE) {
				retValue.setMessage("Nessun documento con file è presente nella selezione");
			} else if (codice == SUPERATO_LIMITE) {
				retValue.setMessage(errorLimiteZip);
			}

			return retValue;

		} finally {
				// una volta salvato in storage lo posso eliminare localmente
				deleteLocalCopy(zipFile);
			}
		}

	private static void addDocumentoCollegato(CreaModDocumentoInBean creaModDocumentoInBean, List<DocumentoCollegato> listaDaAggiungere) {
		List<DocumentoCollegato> listaCorrente = creaModDocumentoInBean.getDocCollegato();
		if (listaCorrente == null) {
			creaModDocumentoInBean.setDocCollegato(listaDaAggiungere);
		} else {
			listaCorrente.addAll(listaDaAggiungere);
			creaModDocumentoInBean.setDocCollegato(listaCorrente);
		}
	}

	public TipoDocumentoBean getIdDocType(TipoDocumentoBean tipoDocumentoBeanIn) throws Exception {

		AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());

		String idDominio = null;
		if (loginBean.getDominio() != null && !"".equals(loginBean.getDominio())) {
			if (loginBean.getDominio().split(":").length == 2) {
				idDominio = loginBean.getDominio().split(":")[1];
			}
		}

		// ***********************************
		// INPUT
		// Iddominioin = dominio
		// NomeDocTypeIn = nome del tipo
		// Flgsolovldin = 1
		// ***********************************
		DmpkUtilityFinddoctype_jBean input = new DmpkUtilityFinddoctype_jBean();
		input.setIdspaooin(StringUtils.isNotBlank(idDominio) ? new BigDecimal(idDominio) : null);
		input.setFlgsolovldin(new Integer(1));
		input.setNomedoctypein(tipoDocumentoBeanIn.getDescTipoDocumento());

		// ***********************************
		// OUTPUT
		// IdDocTypeOut = id del tipo
		// ***********************************

		SchemaBean lSchemaBean = new SchemaBean();
		lSchemaBean.setSchema(loginBean.getSchema());

		DmpkUtilityFinddoctype_j lDmpkUtilityFinddoctype = new DmpkUtilityFinddoctype_j();
		StoreResultBean<DmpkUtilityFinddoctype_jBean> output = lDmpkUtilityFinddoctype.execute(getLocale(), lSchemaBean, input);
		TipoDocumentoBean lTipoDocumentoBean = new TipoDocumentoBean();
		if (output.isInError()) {
			addMessage(output.getDefaultMessage(), output.getDefaultMessage(), MessageType.ERROR);
			return lTipoDocumentoBean;
		}

		if (output.getResultBean().getIddoctypeout() != null)
			lTipoDocumentoBean.setIdTipoDocumento(output.getResultBean().getIddoctypeout().toString());

		return lTipoDocumentoBean;

	}
	
	public ProtocollazioneBean recuperaDatiProtocolloPGWeb(ProtocollazioneBean bean) throws Exception {

		if(isClienteComuneMilano()) { 
			
			AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());
			String token = loginBean.getToken();
			String idUserLavoro = loginBean.getIdUserLavoro();

			DmpkRepositoryGuiGetprotdapgwebBean input = new DmpkRepositoryGuiGetprotdapgwebBean();
			input.setCodidconnectiontokenin(token);
			input.setIduserlavoroin(StringUtils.isNotBlank(idUserLavoro) ? new BigDecimal(idUserLavoro) : null);
			input.setSiglaprotin(StringUtils.isNotBlank(bean.getSiglaProtocolloPregresso()) ? bean.getSiglaProtocolloPregresso() : "PG");
			input.setNumprotin(StringUtils.isNotBlank(bean.getNroProtocolloPregresso()) ? new BigDecimal(bean.getNroProtocolloPregresso()) : null);
			input.setAnnoprotin(StringUtils.isNotBlank(bean.getAnnoProtocolloPregresso()) ? new BigDecimal(bean.getAnnoProtocolloPregresso()) : null);
			input.setSubprotin(StringUtils.isNotBlank(bean.getSubProtocolloPregresso()) ? new BigDecimal(bean.getSubProtocolloPregresso()) : null);
			
			DmpkRepositoryGuiGetprotdapgweb lDmpkRepositoryGuiGetprotdapgweb = new DmpkRepositoryGuiGetprotdapgweb();
			StoreResultBean<DmpkRepositoryGuiGetprotdapgwebBean> output = lDmpkRepositoryGuiGetprotdapgweb.execute(getLocale(), loginBean, input);
	
			if (output.isInError()) {
				if(StringUtils.isNotBlank(output.getDefaultMessage())) {
					addMessage(output.getDefaultMessage(), output.getDefaultMessage(), MessageType.WARNING);
				}
			}
			
			try {
				if(StringUtils.isNotBlank(output.getResultBean().getListaout())) {
					DatiProtPGWebXmlBean lDatiProtPGWebXmlBean = new DatiProtPGWebXmlBean();
			        XmlUtilityDeserializer lXmlUtilityDeserializer = new XmlUtilityDeserializer();
			        lDatiProtPGWebXmlBean = lXmlUtilityDeserializer.unbindXml(output.getResultBean().getListaout(), DatiProtPGWebXmlBean.class);      	       
			        if(lDatiProtPGWebXmlBean != null) {
			        	if(StringUtils.isNotBlank(lDatiProtPGWebXmlBean.getOggetto())) {
			        		bean.setOggetto(lDatiProtPGWebXmlBean.getOggetto());
			        	}
			        	if (lDatiProtPGWebXmlBean.getAltreUbicazioni() != null && lDatiProtPGWebXmlBean.getAltreUbicazioni().size() > 0) {
			        		List<AltraViaProtBean> listaAltreVie = new ArrayList<AltraViaProtBean>();
				        	for (AltreUbicazioniBean lAltraVia : lDatiProtPGWebXmlBean.getAltreUbicazioni()) {
								AltraViaProtBean lAltraViaProtBean = new AltraViaProtBean();
								lAltraViaProtBean.setStato(lAltraVia.getStato());
								lAltraViaProtBean.setNomeStato(lAltraVia.getNomeStato());
								if (StringUtils.isBlank(lAltraViaProtBean.getStato()) || _COD_ISTAT_ITALIA.equals(lAltraViaProtBean.getStato())
										|| _NOME_STATO_ITALIA.equals(lAltraViaProtBean.getStato())) {
									if (StringUtils.isNotBlank(lAltraVia.getCodToponimo()) || StringUtils.isBlank(lAltraVia.getToponimoIndirizzo())) {
										lAltraViaProtBean.setFlgFuoriComune(false);
										lAltraViaProtBean.setCodToponimo(lAltraVia.getCodToponimo());
										lAltraViaProtBean.setIndirizzo(lAltraVia.getToponimoIndirizzo());
										lAltraViaProtBean.setComune(getCodIstatComuneRif());
										lAltraViaProtBean.setNomeComune(getNomeComuneRif());
									} else {
										lAltraViaProtBean.setFlgFuoriComune(true);
										lAltraViaProtBean.setTipoToponimo(lAltraVia.getTipoToponimo());
										lAltraViaProtBean.setToponimo(lAltraVia.getToponimoIndirizzo());
										lAltraViaProtBean.setComune(lAltraVia.getComune());
										lAltraViaProtBean.setNomeComune(lAltraVia.getNomeComuneCitta());
									}
									lAltraViaProtBean.setFrazione(lAltraVia.getFrazione());
									lAltraViaProtBean.setCap(lAltraVia.getCap());
								} else {
									lAltraViaProtBean.setIndirizzo(lAltraVia.getToponimoIndirizzo());
									lAltraViaProtBean.setCitta(lAltraVia.getNomeComuneCitta());
								}
								lAltraViaProtBean.setCivico(lAltraVia.getCivico());
								lAltraViaProtBean.setAppendici(lAltraVia.getAppendici());
								lAltraViaProtBean.setZona(lAltraVia.getZona());
								lAltraViaProtBean.setComplementoIndirizzo(lAltraVia.getComplementoIndirizzo());
								listaAltreVie.add(lAltraViaProtBean);
							}		
							bean.setListaAltreVie(listaAltreVie);			
						}
			        }			
				}
			} catch(Exception e) {
				logProtDS.warn(e);
			}
			
		}
		
		return bean;
	}
	
	public ProtocollazioneBean recuperaIdUd(ProtocollazioneBean bean) throws Exception {

		AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());
		String token = loginBean.getToken();
		String idUserLavoro = loginBean.getIdUserLavoro();
		
		DmpkCoreFindudBean input = new DmpkCoreFindudBean();
		input.setCodidconnectiontokenin(token);
		input.setIduserlavoroin(StringUtils.isNotBlank(idUserLavoro) ? new BigDecimal(idUserLavoro) : null);
		input.setCodcategoriaregin("PG");
		input.setAnnoregin(bean.getAnnoProtocollo() != null ? Integer.parseInt(bean.getAnnoProtocollo()) : null);
		input.setNumregin(bean.getNroProtocollo() != null ? Integer.valueOf(bean.getNroProtocollo().intValue()) : null);
		
		DmpkCoreFindud lDmpkCoreFindud = new DmpkCoreFindud();
		StoreResultBean<DmpkCoreFindudBean> output = lDmpkCoreFindud.execute(getLocale(), loginBean, input);
		
		if (output.isInError()) {
			if(StringUtils.isNotBlank(output.getDefaultMessage())) {
				addMessage(output.getDefaultMessage(), output.getDefaultMessage(), MessageType.ERROR);
			}
		}
		
		bean.setIdUd(null);
		if (output.getResultBean() != null) {
			bean.setIdUd(output.getResultBean().getIdudio());
		}
		
		return bean;
	}
	
	public AttiRichiestiBean recuperaDatiAttoRichiesto(AttiRichiestiBean bean) throws Exception {

		AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());
		String token = loginBean.getToken();
		String idUserLavoro = loginBean.getIdUserLavoro();
		
		AttiRichiestiXMLBean attoXml = new AttiRichiestiXMLBean();
		
		
		
		if (StringUtils.isNotBlank(bean.getIdFolder())){
			attoXml.setIdFolder(bean.getIdFolder());
		}else if(StringUtils.isBlank(bean.getTipoProtocollo()) || "PG".equals(bean.getTipoProtocollo())) {
			attoXml.setTipoProtocollo("PG");
			attoXml.setNumeroProtocollo(bean.getNumProtocolloGenerale());
			attoXml.setAnnoProtocollo(bean.getAnnoProtocolloGenerale());		
		} else {
			attoXml.setTipoProtocollo("PS");
			attoXml.setRegProtocolloDiSettore(bean.getSiglaProtocolloSettore());
			attoXml.setNumeroProtocollo(bean.getNumProtocolloSettore());
			attoXml.setSubProtocolloDiSettore(bean.getSubProtocolloSettore());
			attoXml.setAnnoProtocollo(bean.getAnnoProtocolloSettore());
		}			
		
		Riga lRiga = buildRiga(attoXml);
		
		String attoXmlString = transformRigaToXml(lRiga);

		DmpkCoreFindfascinarchivioBean input = new DmpkCoreFindfascinarchivioBean();
		input.setCodidconnectiontokenin(token);
		input.setIduserlavoroin(StringUtils.isNotBlank(idUserLavoro) ? new BigDecimal(idUserLavoro) : null);
		input.setDatifascicoloxmlio(attoXmlString);
		
		DmpkCoreFindfascinarchivio lDmpkCoreFindfascinarchivio = new DmpkCoreFindfascinarchivio();
		StoreResultBean<DmpkCoreFindfascinarchivioBean> output = lDmpkCoreFindfascinarchivio.execute(getLocale(), loginBean, input);
		
		 AttiRichiestiBean returnBean = new AttiRichiestiBean();

		if (output.isInError()) {
			if(StringUtils.isNotBlank(output.getDefaultMessage())) {
				addMessage(output.getDefaultMessage(), output.getDefaultMessage(), MessageType.WARNING);
			}
		}
		
		try {
			if(StringUtils.isNotBlank(output.getResultBean().getDatifascicoloxmlio())) {
				
				Riga RigaOutput = transformXmlToRiga(output.getResultBean().getDatifascicoloxmlio());
				returnBean = populateAttiRichiestiBean(RigaOutput);
				
			}
		} catch(Exception e) {
			logProtDS.warn(e);
		}
		
		return returnBean;
	}


	public boolean isPropostaAtto() {
		boolean isPropostaAtto = getExtraparams().get("isPropostaAtto") != null && "true".equals(getExtraparams().get("isPropostaAtto"));
		return isPropostaAtto;
	}

	public boolean isPropostaAttoMilano() {
		return isPropostaAtto() && ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_PROPOSTA_ATTO_2");
	}
	
	public boolean isRichiestaAccessoAtti() { 
		// Verifico se sono in una richiesta di accesso atti
		return getExtraparams().get("isRichiestaAccessoAtti") != null && "true".equals(getExtraparams().get("isRichiestaAccessoAtti"));
	}
	
	public boolean isRichiestaAccessoAttiRichiedenteInterno(ProtocollazioneBean bean) { 
		// Verifico se sono in una richiesta di accesso atti con richiedente interno
		return isRichiestaAccessoAtti() && TipoRichiedente.RICH_INTERNO.getValue().equalsIgnoreCase(bean.getTipoRichiedente());
	}

	public boolean isTaskDettUdGen() {
		boolean isTaskDettUdGen = getExtraparams().get("isTaskDettUdGen") != null && "true".equals(getExtraparams().get("isTaskDettUdGen"));
		return isTaskDettUdGen;
	}
	
	private String transformRigaToXml(Riga lRigaIn) throws JAXBException {
		StringWriter lStringWriter = new StringWriter();
		SingletonJAXBContext.getInstance().createMarshaller().marshal(lRigaIn, lStringWriter);
		return lStringWriter.toString();
	}
	
	private Riga buildRiga(AttiRichiestiXMLBean lDatiSoggettoBean) throws IllegalAccessException, InvocationTargetException, NoSuchMethodException {
		Riga lRiga = new Riga();
		Field[] lFields = lDatiSoggettoBean.getClass().getDeclaredFields();
		for (Field lField : lFields) {
			NumeroColonna lNumeroColonna = lField.getAnnotation(NumeroColonna.class);
			if (lNumeroColonna != null) {
				String value = BeanUtilsBean2.getInstance().getProperty(lDatiSoggettoBean, lField.getName());
				if (value != null && !value.equalsIgnoreCase("")) {
					Colonna lColonna = new Colonna();
					lColonna.setContent(value);
					lColonna.setNro(new BigInteger(lNumeroColonna.numero()));
					lRiga.getColonna().add(lColonna);
				}
			}
		}
		return lRiga;
	}
	
	private Riga transformXmlToRiga(String xmlStringIn) throws JAXBException {
		Riga rigaOut = (Riga) SingletonJAXBContext.getInstance().createUnmarshaller().unmarshal(new StringReader(xmlStringIn));
		return rigaOut;
	}
	
	private AttiRichiestiBean populateAttiRichiestiBean(Riga lRiga) throws IllegalAccessException, InvocationTargetException, NoSuchMethodException {
		
		AttiRichiestiBean bean = new AttiRichiestiBean();
		
		String siglaProtocollo = null;
		String numeroProtocollo = null;
		String subProtocollo = null;
		String annoProtocollo = null;
				
		// AssegnazioneBean ufficioPrelievo = new AssegnazioneBean();		
		// SoggEsternoProtBean responsabilePrelievo = new SoggEsternoProtBean();
		
		for (int i = 0; i < lRiga.getColonna().size(); i++) {
			String nroColonna = lRiga.getColonna().get(i).getNro().toString();
			String valueColonna = lRiga.getColonna().get(i).getContent();
			if (valueColonna == null)
				valueColonna = "";
			switch (Integer.parseInt(nroColonna)) {
			case 1: // colonna 1 : Tipo protocollo
				bean.setTipoProtocollo(valueColonna);
				break;
			case 2: // colonna 2 : numero di protocollo
				numeroProtocollo = valueColonna;				
				break;
			case 3: // colonna 3 : Registro protocollo di settore
				siglaProtocollo = valueColonna;
				break;
			case 4: // colonna 4 : Anno protocollo
				annoProtocollo = valueColonna;
				break;
			case 5: // colonna 5 : Sub protocollo di settore
				subProtocollo = valueColonna;
				break;
			case 6: // colonna 6 : Stato scansione
				bean.setStatoScansione(valueColonna);
				break;
			case 7: // colonna 7 : ID folder
				bean.setIdFolder(valueColonna);
				break;
			case 8: // colonna 8 : Stato
				bean.setStato(valueColonna);
				break;
			case 9: // colonna 9 : Unità di carico
				bean.setUdc(valueColonna);
				break;
			case 10: // colonna 10 : Denominazione ufficio che ha effettuato il prelievo
				bean.setDescrizioneUfficioPrelievo(valueColonna);
				break;
			case 11: // colonna 11 : Cod. dell’ufficio che ha effettuato il prelievo
				bean.setCodRapidoUfficioPrelievo(valueColonna);
				break;
			case 12: // colonna 12 : ID_UO che ha effettuato il prelievo
				bean.setIdUoUfficioPrelievo(valueColonna);
				bean.setOrganigrammaUfficioPrelievo("UO" + valueColonna);
				break;
			case 13: // colonna 13 : Cognome responsabile prelievo
				bean.setCognomeResponsabilePrelievo(valueColonna);
				break;
			case 14: // colonna 14 : Nome responsabile prelievo
				bean.setNomeResponsabilePrelievo(valueColonna);
				break;
			case 15: // colonna 15 : Username responsabile prelievo
				bean.setUsernameResponsabilePrelievo(valueColonna);
				break;
			case 16: // colonna 16 : ID_USER responsabile prelievo
				bean.setIdUserResponsabilePrelievo(valueColonna);
				break;
			case 17: // colonna 17: Data prelievo (GG/MM/AAAA)
				SimpleDateFormat sdf = new SimpleDateFormat(FMT_STD_DATA);
				Date date = null;
				try {
					date = sdf.parse(valueColonna);
				} catch (ParseException e) {
					logProtDS.error("Errore nel parsing della data", e);
				}
				bean.setDataPrelievo(date);
				break;
			case 18: // colonna 18: Note uff. richiedente
				bean.setNoteUffRichiedente(valueColonna);
				break;
			case 19: // colonna 19: Note Cittadella
				bean.setNoteCittadella(valueColonna);
				break;
			case 20: // colonna 20: Classifica
				bean.setClassifica(valueColonna);
				break;
			case 22: // colonna 22: Competenza di urbanistica
				bean.setCompetenzaDiUrbanistica(valueColonna);
				break;
			case 23: // colonna 23: Cartaceo reperibile
				bean.setCartaceoReperibile(valueColonna);
				break;
			case 24: // colonna 24: Archivio in qui si trova
				bean.setInArchivio(valueColonna);
				break;
			case 25: // colonna 25: Richiesta visione cartaceo
				bean.setFlgRichiestaVisioneCartaceo(valueColonna != null && "1".equalsIgnoreCase(valueColonna) ? true : false);
				break;
			}
			
		}
				
		if(StringUtils.isBlank(bean.getTipoProtocollo()) || "PG".equals(bean.getTipoProtocollo())) {
			bean.setNumProtocolloGenerale(numeroProtocollo);
			bean.setAnnoProtocolloGenerale(annoProtocollo);			
		} else {			
			bean.setSiglaProtocolloSettore(siglaProtocollo);
			bean.setNumProtocolloSettore(numeroProtocollo);		
			bean.setSubProtocolloSettore(subProtocollo);	
			bean.setAnnoProtocolloSettore(annoProtocollo);			
		}

		return bean;
	}
	
	/**
	 * Splitto la denominazione in nome e cognome. Suppongo che il nome sia composto da una sola parola
	 * @param denominazione
	 * @return la denominazione splittata in cognome e nome
	 */
	private String[] dividiCognomeENome(String denominazione){
		String[] result = new String[2]; 
		String[] split = denominazione.split(" ");
		String cognome = "";
		String nome = "";
		for (int i = 0; i < split.length; i++){
			if (i != (split.length - 1)){
				cognome += cognome + " " + split[i];
			}else{
				nome = split[i];
			}
		}
		result[0] = cognome;
		result[1] = nome;
		return result;
	}
	
	/**
	 * *************************************************************************************************************************************************
	 * *********************   SEZIONE INVIO NOTIIFCA PER ASSEGNAZIONE O INVIO PER CONOSCENZA  ********************* 
	 */
	private void invioNotificheAssegnazioneInvioCC(ProtocollazioneBean bean, CreaModDocumentoInBean xmlDocumento,Boolean isUpdate) throws Exception {

		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());
		XmlUtilitySerializer lXmlUtilitySerializer = new XmlUtilitySerializer();
		List<TipoIdBean> listaAssegnatari = getListaAssegnatari(xmlDocumento);
		List<TipoIdBean> listaInvioCC =	getListaAssegnatariPerConoscenza(xmlDocumento);
		
		/**
		 * Operazioni per la presenza di utenti assegnatari
		 */
		if(listaAssegnatari != null && !listaAssegnatari.isEmpty()){
			manageAssegnazioni(bean.getIdUd(), isUpdate, lAurigaLoginBean, lXmlUtilitySerializer, listaAssegnatari);
		}
		/**
		 * Operazioni per la presenza di utenti per invio in conoscenza
		 */
		if(listaInvioCC != null && !listaInvioCC.isEmpty()){
			manageInvioCC(bean.getIdUd(), isUpdate, lAurigaLoginBean, lXmlUtilitySerializer, listaInvioCC);
		}
	}
	
	private void manageAssegnazioni(BigDecimal idUd, Boolean isUpdate, AurigaLoginBean lAurigaLoginBean, XmlUtilitySerializer lXmlUtilitySerializer,
		List<TipoIdBean> listaAssegnatari) throws JAXBException, IllegalAccessException, InvocationTargetException, NoSuchMethodException, Exception {

		/**
		 * Assegnazione per conoscenza di un DOCUMENTO, di conseguenza controllo il parametro nella dmt_def_config_param ATTIVA_NOT_EMAIL_ASSEGN_UD
		 */
		
		List<TipoIdBean> listaAssNew = new ArrayList<TipoIdBean>();
		if (listaAssegnatari != null && !listaAssegnatari.isEmpty()) {
			for(int i = 0; i < listaAssegnatari.size(); i++) {
				if (attivaNotEmailAssegnUD(listaAssegnatari,i)) {
					listaAssNew.add(listaAssegnatari.get(i));
				}
			}	
		}
		
		if(listaAssNew != null && !listaAssNew.isEmpty()) {
			sendNotificaAssegnazioneInvioCC(idUd,lAurigaLoginBean,lXmlUtilitySerializer,listaAssNew,"ASSEGNAZIONE",isUpdate);
		} else {
			logProtDS.warn("Non è stata inviata alcuna notifica e-mail assegnazione" + "lista destinatari listaAssegnatari: " + listaAssegnatari.size()
			+ ", verificare parametro ATTIVA_NOT_EMAIL_ASSEGN_UD");
			//addMessage("Non è stata inviata alcuna notifica e-mail dell'assegnazione", "", MessageType.WARNING);
		}
	}
	
	private void manageInvioCC(BigDecimal idUd, Boolean isUpdate, AurigaLoginBean lAurigaLoginBean, XmlUtilitySerializer lXmlUtilitySerializer,
			List<TipoIdBean> listaInvioCC) throws JAXBException, IllegalAccessException, InvocationTargetException, NoSuchMethodException, Exception {
		
		/**
		 * Invio per conoscenza di un DOCUMENTO, di conseguenza controllo il parametro nella dmt_def_config_param ATTIVA_NOT_EMAIL_ASSEGN_UD
		 */
		List<TipoIdBean> listaInvioCCNew = new ArrayList<TipoIdBean>();
		if (listaInvioCC != null && !listaInvioCC.isEmpty()) {
			for(int i = 0; i < listaInvioCC.size(); i++) {
				if (attivaNotEmailInvioCCUD(listaInvioCC,i)) {
					listaInvioCCNew.add(listaInvioCC.get(i));
				} 
			}	
		}
		
		if(listaInvioCCNew != null && !listaInvioCCNew.isEmpty()) {
			sendNotificaAssegnazioneInvioCC(idUd,lAurigaLoginBean,lXmlUtilitySerializer,listaInvioCCNew,"",isUpdate);
		} else {
			logProtDS.warn("Non è stata inviata alcuna notifica e-mail relativa all'invio per conoscenza" + "lista destinatari listaInvioCC: " + listaInvioCC.size()
			+ ", verificare parametro ATTIVA_NOT_EMAIL_ASSEGN_UD");
			//addMessage("Non è stata inviata alcuna notifica e-mail relativa all'invio per conoscenza", "", MessageType.WARNING);
		}
	}
	
	private void sendNotificaAssegnazioneInvioCC(BigDecimal idUd, AurigaLoginBean lAurigaLoginBean,XmlUtilitySerializer lXmlUtilitySerializer, 
			List<TipoIdBean> listaInvioCC,String tipoOperazione,Boolean isUpdate) throws JAXBException, IllegalAccessException, InvocationTargetException, NoSuchMethodException, Exception {
		
		String token = lAurigaLoginBean.getToken();
		String idUserLavoro = lAurigaLoginBean.getIdUserLavoro();
		
		DmpkIntMgoEmailPreparaemailnotassinvioccBean lInputBean = new DmpkIntMgoEmailPreparaemailnotassinvioccBean();
		lInputBean.setCodidconnectiontokenin(token);
		lInputBean.setIduserlavoroin(StringUtils.isNotBlank(idUserLavoro) ? new BigDecimal(idUserLavoro) : null);
		
		if(isUpdate){
			if("ASSEGNAZIONE".equals(tipoOperazione)){
				lInputBean.setAssinvioccin("assegnazione_competenza");
			}else{
				lInputBean.setAssinvioccin("invio_conoscenza");
			}
		} else {
			if("ASSEGNAZIONE".equals(tipoOperazione)){
				lInputBean.setAssinvioccin("assegnazione_competenza");
			}else{
				lInputBean.setAssinvioccin("invio_conoscenza");
			}
		}

		List<TipoIdBean> listaUdFolder = new ArrayList<TipoIdBean>();
		TipoIdBean udFolder = new TipoIdBean();
		udFolder.setTipo("U");
		udFolder.setId(idUd != null ? String.valueOf(idUd.longValue()) : null);
		listaUdFolder.add(udFolder);
		lInputBean.setUdfolderxmlin(lXmlUtilitySerializer.bindXmlList(listaUdFolder));
		lInputBean.setDestassinvioccxmlin(lXmlUtilitySerializer.bindXmlList(listaInvioCC));
		lInputBean.setCodmotivoinvioin(null);
		lInputBean.setMotivoinvioin(null);
		lInputBean.setMessaggioinvioin(null);
		lInputBean.setLivelloprioritain(null);
		lInputBean.setTsdecorrassinvioccin(null);

		DmpkIntMgoEmailPreparaemailnotassinviocc preparaemailnotassinviocc = new DmpkIntMgoEmailPreparaemailnotassinviocc();
		StoreResultBean<DmpkIntMgoEmailPreparaemailnotassinvioccBean> lStoreResultBean = preparaemailnotassinviocc.execute(getLocale(), lAurigaLoginBean,
				lInputBean);

		if (lStoreResultBean.isInError()) {
				String message = "";
			if("ASSEGNAZIONE".equals(tipoOperazione)) {
				message = "Fallito invio notifica e-mail dell'assegnazione per gli utenti selezionati ";
			} else {
				message = "Fallito invio notifica e-mail dell'invio in conoscenza per gli utenti selezionati ";
			}
			if (StringUtils.isNotBlank(lStoreResultBean.getDefaultMessage())) {
				if("ASSEGNAZIONE".equals(tipoOperazione)) {
					logProtDS.error("Fallito invio notifica e-mail dell'assegnazione per il seguente motivo: " + lStoreResultBean.getDefaultMessage());
				} else {
					logProtDS.error("Fallito invio notifica e-mail dell'invio in conoscenza per il seguente motivo: " + lStoreResultBean.getDefaultMessage());
				}
				message += " per il seguente motivo: " + lStoreResultBean.getDefaultMessage();
			}
			addMessage(message, "", MessageType.WARNING);
		} else {
			if (lStoreResultBean.getResultBean().getFlgemailtosendout() != null && lStoreResultBean.getResultBean().getFlgemailtosendout().intValue() == 1) {
				SenderBean sender = new SenderBean();
				sender.setIdUtenteModPec(lAurigaLoginBean.getSpecializzazioneBean().getIdUtenteModPec());
				sender.setAccount(lStoreResultBean.getResultBean().getIndirizzomittemailout());
				sender.setAddressFrom(lStoreResultBean.getResultBean().getIndirizzomittemailout());
				List<String> addressTo = new ArrayList<String>();
				StringReader sr = new StringReader(lStoreResultBean.getResultBean().getIndirizzidestemailout());
				Lista lista = (Lista) SingletonJAXBContext.getInstance().createUnmarshaller().unmarshal(sr);
				if (lista != null) {
					for (int i = 0; i < lista.getRiga().size(); i++) {
						Vector<String> v = new XmlUtility().getValoriRiga(lista.getRiga().get(i));
						addressTo.add(v.get(0));
					}
				}
				sender.setAddressTo(addressTo);
				sender.setSubject(lStoreResultBean.getResultBean().getOggemailout());
				sender.setBody(lStoreResultBean.getResultBean().getBodyemailout());
				sender.setIsHtml(true);
				sender.setIsPec(false);
				try {
					EmailSentReferenceBean lEmailSentReferenceBean = AurigaMailService.getMailSenderService().send(getLocale(), sender);
					String notSentMails = null;
					for (SenderBean lSenderBean : lEmailSentReferenceBean.getSentMails()) {
						if (!lSenderBean.getIsSent()) {
							if (notSentMails == null) {
								notSentMails = lSenderBean.getAddressTo().get(0);
							} else {
								notSentMails += ", " + lSenderBean.getAddressTo().get(0);
							}
						}
					}
					if (notSentMails != null) {
						if("ASSEGNAZIONE".equals(tipoOperazione)){
							logProtDS.warn("Fallito invio notifica e-mail dell'assegnazione per i seguenti indirizzi: " + notSentMails);
							addMessage("Fallito invio notifica e-mail dell'assegnazione per i seguenti indirizzi: " + notSentMails, "", MessageType.WARNING);
						}else{
							logProtDS.warn("Warning, Fallito invio notifica e-mail dell'invio per conoscenza per i seguenti indirizzi: " + notSentMails);
							addMessage("Fallito invio notifica e-mail dell'invio per conoscenza per i seguenti indirizzi: " + notSentMails, "", MessageType.WARNING);
						}
					}
				} catch (Exception e) {
					if("ASSEGNAZIONE".equals(tipoOperazione)){
						logProtDS.error("Fallito invio notifica e-mail dell'assegnazione:" + e.getMessage(), e);
						addMessage("Fallito invio notifica e-mail dell'assegnazione: " + e.getMessage(), "", MessageType.WARNING);
					}else{
						logProtDS.error("Non è stata inviata alcuna notifica e-mail dell'invio per conoscenza" + e.getMessage(), e);
						addMessage("Fallito invio notifica e-mail dell'invio per conoscenza: " + e.getMessage(), "", MessageType.WARNING);
					}
				}
			} else {
				if("ASSEGNAZIONE".equals(tipoOperazione)){
					logProtDS.warn("Non è stata inviata alcuna notifica e-mail dell'assegnazione");
				}else{
					logProtDS.warn("Warning, Non è stata inviata alcuna notifica e-mail dell'invio per conoscenza,getFlgemailtosendout: "
							+ lStoreResultBean.getResultBean().getFlgemailtosendout());
				}
			}
		}
	}
	
	private List<TipoIdBean> getListaAssegnatari(CreaModDocumentoInBean xmlDocumento) throws Exception {
		List<TipoIdBean> listaDestAssCC = new ArrayList<TipoIdBean>();
		if (xmlDocumento.getAssegnatari() != null && !xmlDocumento.getAssegnatari().isEmpty()) {
			for (AssegnatariBean assegnatarioBean : xmlDocumento.getAssegnatari()) {
				
				TipoIdBean tipoIdBean = new TipoIdBean();
				tipoIdBean.setTipo(getTipoAssegnatarioInvioCC(assegnatarioBean));
				tipoIdBean.setId(assegnatarioBean.getIdSettato());
				tipoIdBean.setFlgMandaNotificaMail(assegnatarioBean.getFlgMandaNotificaMail() != null && assegnatarioBean.getFlgMandaNotificaMail() == Flag.SETTED ?
						true : false );
				listaDestAssCC.add(tipoIdBean);
			}
		}
		return listaDestAssCC;
	}
	
	private List<TipoIdBean> getListaAssegnatariPerConoscenza(CreaModDocumentoInBean xmlDocumento) {
		List<TipoIdBean> listaInvioCC = new ArrayList<TipoIdBean>();
		if (xmlDocumento.getInvioDestCC() != null && !xmlDocumento.getInvioDestCC().isEmpty()) {
			for (AssegnatariBean assegnatarioBean : xmlDocumento.getInvioDestCC()) {
				
				TipoIdBean tipoIdBean = new TipoIdBean();
				tipoIdBean.setTipo(getTipoAssegnatarioInvioCC(assegnatarioBean));
				tipoIdBean.setId(assegnatarioBean.getIdSettato());
				tipoIdBean.setFlgMandaNotificaMail(assegnatarioBean.getFlgMandaNotificaMail() != null && assegnatarioBean.getFlgMandaNotificaMail() == Flag.SETTED ?
						true : false );
				listaInvioCC.add(tipoIdBean);
			}
		}
		return listaInvioCC;
	}
	
	private String getTipoAssegnatarioInvioCC(AssegnatariBean lAssegnazioneBean) {
		TipoAssegnatario[] lTipoAssegnatarios = TipoAssegnatario.values();
		for (TipoAssegnatario lTipoAssegnatario : lTipoAssegnatarios) {
			if (lTipoAssegnatario.toString().equals(lAssegnazioneBean.getTipo().toString()))
				return lTipoAssegnatario.toString();
		}
		return null;
	}
	
	public boolean isAppendRelazioniVsUD(ProtocollazioneBean beanDettaglio) {
		// Se non ho attivato il protocollo wizard inserisco i documenti collegati in append
		return !isAttivoProtocolloWizard(beanDettaglio);
	}
	
	public boolean isAttivoProtocolloWizard(ProtocollazioneBean beanDettaglio) {
		if(beanDettaglio == null || beanDettaglio.getIdUd() == null || StringUtils.isNotBlank(beanDettaglio.getSupportoOriginale())) {
			return ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_PROTOCOLLO_WIZARD");
		}
		return false;
	}
	
	public boolean isAttivoEsibente(ProtocollazioneBean beanDettaglio) {	
		// se è un protocollo in entrata
		if (beanDettaglio.getFlgTipoProv() != null && beanDettaglio.getFlgTipoProv().equalsIgnoreCase("E")) {
			// se è attiva la modalità wizard e il canale selezionato è lo sportello (consegna a mano)
			if (isAttivoProtocolloWizard(beanDettaglio) && beanDettaglio.getMezzoTrasmissione() != null && ("CM".equals(beanDettaglio.getMezzoTrasmissione()) || "PREGR".equals(beanDettaglio.getMezzoTrasmissione()))) {
				return true;			
			} 
			// se l'esibente va mostrato anche in modalità standard
			else if(isAttivoEsibenteSenzaWizard()) {
				return true;
			} 
		}
		return false;
	}
	
	public boolean isAttivoInteressati(ProtocollazioneBean beanDettaglio) {
		// se è attiva la modalità wizard
		if (isAttivoProtocolloWizard(beanDettaglio)) {
			return true;			
		}
		// se gli interessati vanno mostrati anche in modalità standard
		else if(isAttivoInteressatiSenzaWizard()) {
			return true;
		} 
		return false;
	}
	
	public boolean isAttivoEsibenteSenzaWizard() {
		return ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_ESIBENTE_SENZA_WIZARD");
	}
	
	public boolean isAttivoInteressatiSenzaWizard() {
		return ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_INTERESSATI_SENZA_WIZARD");
	}
	
	public boolean isAttivoAltreVieSenzaWizard() {
		return ParametriDBUtil.getParametroDBAsBoolean(getSession(), "ATTIVA_VIE_SENZA_WIZARD");
	}
	
	public boolean isClienteComuneMilano() {
		return ParametriDBUtil.getParametroDB(getSession(), "CLIENTE") != null && 
			   ParametriDBUtil.getParametroDB(getSession(), "CLIENTE").equalsIgnoreCase("CMMI");
	}

	public String getCodIstatComuneRif() {
		return ParametriDBUtil.getParametroDB(getSession(), "ISTAT_COMUNE_RIF");
	}

	public String getNomeComuneRif() {
		return ParametriDBUtil.getParametroDB(getSession(), "NOME_COMUNE_RIF");
	}
	
	public StampaFileBean creaStampa(ProtocollazioneBean bean) throws Exception {
		
		try {		
			
			AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());
			
			String nomeModello = getExtraparams().get("nomeModello");
			String nomeFileStampa = getExtraparams().get("nomeFileStampa");
			String tipoModello = nomeModello.equals("RICEVUTA_REGISTRAZIONE_UD") ? TipoModelloDoc.DOCX_CON_PLACEHOLDER.getValue() : "DOCX_FORM";
			
			DmpkModelliDocExtractvermodello lExtractvermodello = new DmpkModelliDocExtractvermodello();
			DmpkModelliDocExtractvermodelloBean lExtractvermodelloInput = new DmpkModelliDocExtractvermodelloBean();
			lExtractvermodelloInput.setCodidconnectiontokenin(loginBean.getToken());
			lExtractvermodelloInput.setNomemodelloin(nomeModello);
			
			StoreResultBean<DmpkModelliDocExtractvermodelloBean> lExtractvermodelloOutput = lExtractvermodello.execute(getLocale(), loginBean, lExtractvermodelloInput);
			
			if(lExtractvermodelloOutput.isInError()) {
				throw new StoreException(lExtractvermodelloOutput);
			}
			
			String uriModello = lExtractvermodelloOutput.getResultBean().getUriverout();
			
			DmpkModelliDocGetdatixgendamodello lGetdatixgendamodello = new DmpkModelliDocGetdatixgendamodello();
			DmpkModelliDocGetdatixgendamodelloBean lGetdatixgendamodelloInput = new DmpkModelliDocGetdatixgendamodelloBean();
			lGetdatixgendamodelloInput.setCodidconnectiontokenin(loginBean.getToken());
			//lGetdatixgendamodelloInput.setIdobjrifin(bean.getIdUd());
			lGetdatixgendamodelloInput.setFlgtpobjrifin("U");
			lGetdatixgendamodelloInput.setNomemodelloin(nomeModello);
			
			StoreResultBean<DmpkModelliDocGetdatixgendamodelloBean> lGetdatixgendamodelloOutput = lGetdatixgendamodello.execute(getLocale(), loginBean,
					lGetdatixgendamodelloInput);
			
			if(lGetdatixgendamodelloOutput.isInError()) {
				throw new StoreException(lGetdatixgendamodelloOutput);
			}
			
			String templateValues = lGetdatixgendamodelloOutput.getResultBean().getDatixmodelloxmlout();					
			
			File fileModelloPdf = ModelliUtil.fillTemplateAndConvertToPdf(null, uriModello, tipoModello, templateValues, getSession());
			
			StampaFileBean output = new StampaFileBean();
			output.setNomeFile(nomeFileStampa);
			output.setUri(StorageImplementation.getStorage().store(fileModelloPdf));
			
			MimeTypeFirmaBean infoFile = new MimeTypeFirmaBean();
			infoFile.setMimetype("application/pdf");
			infoFile.setDaScansione(false);
			infoFile.setFirmato(false);
			infoFile.setFirmaValida(false);
			infoFile.setBytes(fileModelloPdf.length());
			infoFile.setCorrectFileName(output.getNomeFile());
			File realFile = StorageImplementation.getStorage().getRealFile(output.getUri());
			InfoFileUtility lInfoFileUtility = new InfoFileUtility();
			infoFile.setImpronta(lInfoFileUtility.calcolaImpronta(realFile.toURI().toString(), output.getNomeFile()));
			output.setInfoFile(infoFile);
			
			return output;
			
		} catch(Exception e) {
			logProtDS.error(e.getMessage(), e);
			throw new StoreException("Si è verificato un errore durante la generazione della stampa");
		}
	}
	
	protected void apposizioneTimbroPostReg(ProtocollazioneBean bean) throws Exception {
		
		/*
		 * APPOSIZIONE TIMBRO SUI FILE DEL DOCUMENTO
		 */
		ProtocollazioneBean protBean = get(bean);				
		AurigaLoginBean lAurigaLoginBean = AurigaUserUtil.getLoginInfo(getSession());
		DocumentConfiguration lDocumentConfiguration = (DocumentConfiguration) SpringAppContext.getContext().getBean("DocumentConfiguration");
		InfoFileUtility lFileUtility = new InfoFileUtility();		
		GestioneDocumenti lGestioneDocumenti = new GestioneDocumenti();
		String flgSostVersFileTimbratoPostReg = ParametriDBUtil.getParametroDB(getSession(), "SOST_VERS_FILE_TIMBRATO_POST_REG");
		
		if(protBean != null) {			
			if(StringUtils.isNotBlank(protBean.getUriFilePrimario())){				
				try {				
					FileDaFirmareBean lFileDaFirmareBean = new FileDaFirmareBean();
					lFileDaFirmareBean.setIdFile("primario");
					lFileDaFirmareBean.setNomeFile(protBean.getNomeFilePrimario());
					lFileDaFirmareBean.setUri(protBean.getUriFilePrimario());
					lFileDaFirmareBean.setUriVerPreFirma(protBean.getUriFileVerPreFirma());
					lFileDaFirmareBean.setInfoFile(protBean.getInfoFile());
					
					// il flag relativo al check "apponi timbro" del file primario lo leggo dal bean originale altrimenti mi perdo il valore settato dall'utente
					if(bean.getFlgTimbraFilePostReg() != null && bean.getFlgTimbraFilePostReg()){
						
						FileDaFirmareBean lFilePrimarioBean = timbraFile(lFileDaFirmareBean, bean.getOpzioniTimbro(), String.valueOf(protBean.getIdUd()));
						
						RebuildedFile lRebuildedFile = new RebuildedFile();
						lRebuildedFile.setIdDocumento(protBean.getIdDocPrimario());
						lRebuildedFile.setFile(StorageImplementation.getStorage().extractFile(lFilePrimarioBean.getUri()));
	
						MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
						lMimeTypeFirmaBean = lFileUtility.getInfoFromFile(lRebuildedFile.getFile().toURI().toString(), lRebuildedFile.getFile().getName(), false, null);
	
						FileInfoBean lFileInfoBean = new FileInfoBean();
						lFileInfoBean.setTipo(TipoFile.PRIMARIO);
						GenericFile lGenericFile = new GenericFile();
						lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
						lGenericFile.setIdFormato(lMimeTypeFirmaBean.getIdFormato());
						lGenericFile.setDisplayFilename(lFilePrimarioBean.getNomeFile());
						lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
						lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
						lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
						// Per ciascun file timbrato in automatico va settato l'attributo FLG_TIMBRO_REG_Ver = 1 
						lGenericFile.setFlgTimbroReg(Flag.SETTED);
						lFileInfoBean.setAllegatoRiferimento(lGenericFile);
	
						lRebuildedFile.setInfo(lFileInfoBean);
	
						if(StringUtils.isBlank(flgSostVersFileTimbratoPostReg) || "S".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
							lRebuildedFile.setUpdateVersion(true);
							lRebuildedFile.setAnnullaLastVer(false);
						} else if ("V".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
							lRebuildedFile.setUpdateVersion(false);
							lRebuildedFile.setAnnullaLastVer(true);								
						}
						
						VersionaDocumentoInBean lVersionaDocumentoInBean = new VersionaDocumentoInBean();
						BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBean, lRebuildedFile);
	
						VersionaDocumentoOutBean lVersionaDocumentoOutput = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBean);
	
						if (lVersionaDocumentoOutput.getDefaultMessage() != null) {
							throw new StoreException(lVersionaDocumentoOutput.getDefaultMessage());
						}
					}
				} catch(Exception e) {
					logProtDS.error(e.getMessage(), e);
					addMessage("Non è stato possibile timbrare il file primario", "", MessageType.WARNING);
				}
			}
			// Vers. con omissis
			if ((protBean.getFlgDatiSensibili() != null && protBean.getFlgDatiSensibili()) && protBean.getFilePrimarioOmissis() != null && StringUtils.isNotBlank(protBean.getFilePrimarioOmissis().getUriFile()) && StringUtils.isNotBlank(protBean.getFilePrimarioOmissis().getNomeFile())) {
				try {				
					FileDaFirmareBean lFileDaFirmareBeanOmissis = new FileDaFirmareBean();
					lFileDaFirmareBeanOmissis.setIdFile("primarioOmissis");
					lFileDaFirmareBeanOmissis.setNomeFile(protBean.getFilePrimarioOmissis().getNomeFile());
					lFileDaFirmareBeanOmissis.setUri(protBean.getFilePrimarioOmissis().getUriFile());
					lFileDaFirmareBeanOmissis.setUriVerPreFirma(protBean.getFilePrimarioOmissis().getUriFileVerPreFirma());
					lFileDaFirmareBeanOmissis.setInfoFile(protBean.getFilePrimarioOmissis().getInfoFile());
					
					// il flag relativo al check "apponi timbro" del file primario omissis lo leggo dal bean originale altrimenti mi perdo il valore settato dall'utente
					if(bean.getFilePrimarioOmissis().getFlgTimbraFilePostReg() != null && bean.getFilePrimarioOmissis().getFlgTimbraFilePostReg()){
						
						FileDaFirmareBean lFilePrimarioBeanOmissis = timbraFileOmissis(lFileDaFirmareBeanOmissis, bean.getFilePrimarioOmissis().getOpzioniTimbro(), String.valueOf(protBean.getIdUd()));
						
						RebuildedFile lRebuildedFileOmissis = new RebuildedFile();
						lRebuildedFileOmissis.setIdDocumento(protBean.getFilePrimarioOmissis().getIdDoc() != null ? new BigDecimal(protBean.getFilePrimarioOmissis().getIdDoc()) : null);
						lRebuildedFileOmissis.setFile(StorageImplementation.getStorage().extractFile(lFilePrimarioBeanOmissis.getUri()));
	
						MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = new MimeTypeFirmaBean();
						lMimeTypeFirmaBeanOmissis = lFileUtility.getInfoFromFile(lRebuildedFileOmissis.getFile().toURI().toString(), lRebuildedFileOmissis.getFile().getName(), false, null);
	
						FileInfoBean lFileInfoBeanOmissis = new FileInfoBean();
						lFileInfoBeanOmissis.setTipo(TipoFile.PRIMARIO);
						GenericFile lGenericFileOmissis = new GenericFile();
						lGenericFileOmissis.setMimetype(lMimeTypeFirmaBeanOmissis.getMimetype());
						lGenericFileOmissis.setIdFormato(lMimeTypeFirmaBeanOmissis.getIdFormato());
						lGenericFileOmissis.setDisplayFilename(lFilePrimarioBeanOmissis.getNomeFile());
						lGenericFileOmissis.setImpronta(lMimeTypeFirmaBeanOmissis.getImpronta());
						lGenericFileOmissis.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
						lGenericFileOmissis.setEncoding(lDocumentConfiguration.getEncoding().value());
						// Per ciascun file timbrato in automatico va settato l'attributo FLG_TIMBRO_REG_Ver = 1 
						lGenericFileOmissis.setFlgTimbroReg(Flag.SETTED);
						lFileInfoBeanOmissis.setAllegatoRiferimento(lGenericFileOmissis);
	
						lRebuildedFileOmissis.setInfo(lFileInfoBeanOmissis);
	
						if(StringUtils.isBlank(flgSostVersFileTimbratoPostReg) || "S".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
							lRebuildedFileOmissis.setUpdateVersion(true);
							lRebuildedFileOmissis.setAnnullaLastVer(false);
						} else if ("V".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
							lRebuildedFileOmissis.setUpdateVersion(false);
							lRebuildedFileOmissis.setAnnullaLastVer(true);								
						}
						
						VersionaDocumentoInBean lVersionaDocumentoInBeanOmissis = new VersionaDocumentoInBean();
						BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBeanOmissis, lRebuildedFileOmissis);
	
						VersionaDocumentoOutBean lVersionaDocumentoOutputOmissis = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBeanOmissis);
	
						if (lVersionaDocumentoOutputOmissis.getDefaultMessage() != null) {
							throw new StoreException(lVersionaDocumentoOutputOmissis.getDefaultMessage());
						}
					}
				} catch(Exception e) {
					logProtDS.error(e.getMessage(), e);
					addMessage("Non è stato possibile timbrare il file primario (vers. con omissis)", "", MessageType.WARNING);
				}
			}			
			if (protBean.getListaAllegati()!=null && protBean.getListaAllegati().size()>0){
				for (int i = 0; i < protBean.getListaAllegati().size(); i++){
					AllegatoProtocolloBean lAllegatoProtocolloBean = protBean.getListaAllegati().get(i);
					try {						
						FileDaFirmareBean lFileDaFirmareBean = new FileDaFirmareBean();
						lFileDaFirmareBean.setIdFile("allegato" + lAllegatoProtocolloBean.getUriFileAllegato());
						lFileDaFirmareBean.setInfoFile(lAllegatoProtocolloBean.getInfoFile());
						lFileDaFirmareBean.setNomeFile(lAllegatoProtocolloBean.getNomeFileAllegato());
						lFileDaFirmareBean.setUri(lAllegatoProtocolloBean.getUriFileAllegato());
						lFileDaFirmareBean.setUriVerPreFirma(lAllegatoProtocolloBean.getUriFileVerPreFirma());
						
						// i flag relativi ai check "apponi timbro" degli allegati li leggo dal bean originale, altrimenti mi perdo i valori settati dall'utente
						if(bean.getListaAllegati().get(i).getFlgTimbraFilePostReg() != null && bean.getListaAllegati().get(i).getFlgTimbraFilePostReg()){
							
							FileDaFirmareBean lFileAllegatoBean = timbraFileAllegato(lFileDaFirmareBean,bean, String.valueOf(protBean.getIdUd()), i);
							
							RebuildedFile lRebuildedFile = new RebuildedFile();
							lRebuildedFile.setIdDocumento(lAllegatoProtocolloBean.getIdDocAllegato());
							lRebuildedFile.setFile(StorageImplementation.getStorage().extractFile(lFileAllegatoBean.getUri()));
		
							MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
							lMimeTypeFirmaBean = lFileUtility.getInfoFromFile(lRebuildedFile.getFile().toURI().toString(), lRebuildedFile.getFile().getName(), false, null);
		
							FileInfoBean lFileInfoBean = new FileInfoBean();
							lFileInfoBean.setTipo(TipoFile.ALLEGATO);
							GenericFile lGenericFile = new GenericFile();
		
							lGenericFile.setMimetype(lMimeTypeFirmaBean.getMimetype());
							lGenericFile.setIdFormato(lMimeTypeFirmaBean.getIdFormato());
							lGenericFile.setDisplayFilename(lFileAllegatoBean.getNomeFile());
							lGenericFile.setImpronta(lMimeTypeFirmaBean.getImpronta());
							lGenericFile.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
							lGenericFile.setEncoding(lDocumentConfiguration.getEncoding().value());
							// Per ciascun file timbrato in automatico va settato l'attributo FLG_TIMBRO_REG_Ver = 1 
							lGenericFile.setFlgTimbroReg(Flag.SETTED);
							lFileInfoBean.setPosizione(i);
							lFileInfoBean.setAllegatoRiferimento(lGenericFile);
		
							lRebuildedFile.setInfo(lFileInfoBean);
							
							if(StringUtils.isBlank(flgSostVersFileTimbratoPostReg) || "S".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
								lRebuildedFile.setUpdateVersion(true);
								lRebuildedFile.setAnnullaLastVer(false);
							} else if ("V".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
								lRebuildedFile.setUpdateVersion(false);
								lRebuildedFile.setAnnullaLastVer(true);								
							}
							
							VersionaDocumentoInBean lVersionaDocumentoInBean = new VersionaDocumentoInBean();
							BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBean, lRebuildedFile);
		
							VersionaDocumentoOutBean lVersionaDocumentoOutput = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBean);
		
							if (lVersionaDocumentoOutput.getDefaultMessage() != null) {
								throw new StoreException(lVersionaDocumentoOutput.getDefaultMessage());
							}
						}
						// Vers. con omissis
						if ((lAllegatoProtocolloBean.getFlgDatiSensibili() != null && lAllegatoProtocolloBean.getFlgDatiSensibili()) && StringUtils.isNotBlank(lAllegatoProtocolloBean.getUriFileOmissis())) {
							
							FileDaFirmareBean lFileDaFirmareBeanOmissis = new FileDaFirmareBean();
							lFileDaFirmareBeanOmissis.setIdFile("allegatoOmissis" + lAllegatoProtocolloBean.getUriFileOmissis());
							lFileDaFirmareBeanOmissis.setInfoFile(lAllegatoProtocolloBean.getInfoFileOmissis());
							lFileDaFirmareBeanOmissis.setNomeFile(lAllegatoProtocolloBean.getNomeFileOmissis());
							lFileDaFirmareBeanOmissis.setUri(lAllegatoProtocolloBean.getUriFileOmissis());
							lFileDaFirmareBeanOmissis.setUriVerPreFirma(lAllegatoProtocolloBean.getUriFileVerPreFirmaOmissis());
							
							if(bean.getListaAllegati().get(i).getFlgTimbraFilePostRegOmissis() != null && bean.getListaAllegati().get(i).getFlgTimbraFilePostRegOmissis()){
								
								FileDaFirmareBean lFileAllegatoBeanOmissis = timbraFileAllegatoOmissis(lFileDaFirmareBeanOmissis, bean, String.valueOf(protBean.getIdUd()), i);
								
								RebuildedFile lRebuildedFileOmissis = new RebuildedFile();
								lRebuildedFileOmissis.setIdDocumento(lAllegatoProtocolloBean.getIdDocOmissis());
								lRebuildedFileOmissis.setFile(StorageImplementation.getStorage().extractFile(lFileAllegatoBeanOmissis.getUri()));
			
								MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = new MimeTypeFirmaBean();
								lMimeTypeFirmaBeanOmissis = lFileUtility.getInfoFromFile(lRebuildedFileOmissis.getFile().toURI().toString(), lRebuildedFileOmissis.getFile().getName(), false, null);
			
								FileInfoBean lFileInfoBeanOmissis = new FileInfoBean();
								lFileInfoBeanOmissis.setTipo(TipoFile.ALLEGATO);
								GenericFile lGenericFileOmissis = new GenericFile();
			
								lGenericFileOmissis.setMimetype(lMimeTypeFirmaBeanOmissis.getMimetype());
								lGenericFileOmissis.setIdFormato(lMimeTypeFirmaBeanOmissis.getIdFormato());
								lGenericFileOmissis.setDisplayFilename(lFileAllegatoBeanOmissis.getNomeFile());
								lGenericFileOmissis.setImpronta(lMimeTypeFirmaBeanOmissis.getImpronta());
								lGenericFileOmissis.setAlgoritmo(lDocumentConfiguration.getAlgoritmo().value());
								lGenericFileOmissis.setEncoding(lDocumentConfiguration.getEncoding().value());
								// Per ciascun file timbrato in automatico va settato l'attributo FLG_TIMBRO_REG_Ver = 1 
								lGenericFileOmissis.setFlgTimbroReg(Flag.SETTED);
								lFileInfoBeanOmissis.setPosizione(i);
								lFileInfoBeanOmissis.setAllegatoRiferimento(lGenericFileOmissis);
			
								lRebuildedFileOmissis.setInfo(lFileInfoBeanOmissis);
								
								if(StringUtils.isBlank(flgSostVersFileTimbratoPostReg) || "S".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
									lRebuildedFileOmissis.setUpdateVersion(true);
									lRebuildedFileOmissis.setAnnullaLastVer(false);
								} else if ("V".equalsIgnoreCase(flgSostVersFileTimbratoPostReg)) {
									lRebuildedFileOmissis.setUpdateVersion(false);
									lRebuildedFileOmissis.setAnnullaLastVer(true);								
								}
								
								VersionaDocumentoInBean lVersionaDocumentoInBeanOmissis = new VersionaDocumentoInBean();
								BeanUtilsBean2.getInstance().getPropertyUtils().copyProperties(lVersionaDocumentoInBeanOmissis, lRebuildedFileOmissis);
			
								VersionaDocumentoOutBean lVersionaDocumentoOutputOmissis = lGestioneDocumenti.versionadocumento(getLocale(), lAurigaLoginBean, lVersionaDocumentoInBeanOmissis);
			
								if (lVersionaDocumentoOutputOmissis.getDefaultMessage() != null) {
									throw new StoreException(lVersionaDocumentoOutputOmissis.getDefaultMessage());
								}
							}
						}
					} catch(Exception e) {
						logProtDS.error(e.getMessage(), e);
						addMessage("Non è stato possibile timbrare l'allegato N. " + lAllegatoProtocolloBean.getNumeroProgrAllegato() + " (vers. con omissis)", "", MessageType.WARNING);
					}
				}
			}
		}
	}

	/**
	 * APPOSIZIONE TIMBRO PER FILE PRIMARIO
	 */
	private FileDaFirmareBean timbraFile(FileDaFirmareBean lFileDaTimbrareBean, OpzioniTimbroDocBean lOpzioniTimbroDocBean, String idUd) throws Exception {
		
		OpzioniTimbroBean lOpzioniTimbroBean = buildOpzioniApponiTimbro(idUd, lFileDaTimbrareBean, lOpzioniTimbroDocBean);
		
		// Timbro il file
		TimbraResultBean lTimbraResultBean = new TimbraUtility().timbra(lOpzioniTimbroBean, getSession());
		// Verifico se la timbratura è andata a buon fine
		if (lTimbraResultBean.isResult()) {
			// Aggiungo il file timbrato nella lista dei file da pubblicare
			lFileDaTimbrareBean.setUri(lTimbraResultBean.getUri());
		} else {
			// // La timbratura è fallita, pubblico il file sbustato
			// files.add(StorageImplementation.getStorage().extractFile(uriFileSbustato));
			String errorMessage = "Si è verificato un errore durante la timbratura del file";
			if (StringUtils.isNotBlank(lTimbraResultBean.getError())) {
				errorMessage += ": " + lTimbraResultBean.getError();
			}
			throw new Exception(errorMessage);
		}	
		
		File lFileTimbrato = StorageImplementation.getStorage().extractFile(lFileDaTimbrareBean.getUri());		
		MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
		lMimeTypeFirmaBean = new InfoFileUtility().getInfoFromFile(lFileTimbrato.toURI().toString(), lFileDaTimbrareBean.getNomeFile(), false, null);
		lFileDaTimbrareBean.setNomeFile(FilenameUtils.getBaseName(lFileDaTimbrareBean.getNomeFile()) + ".pdf");
		lMimeTypeFirmaBean.setFirmato(false);
		lMimeTypeFirmaBean.setFirmaValida(false);
		lMimeTypeFirmaBean.setConvertibile(false);
		lMimeTypeFirmaBean.setDaScansione(false);
		lFileDaTimbrareBean.setInfoFile(lMimeTypeFirmaBean);	
		
		return lFileDaTimbrareBean;
	}
	
	private FileDaFirmareBean timbraFileOmissis(FileDaFirmareBean lFileDaTimbrareBeanOmissis, OpzioniTimbroDocBean lOpzioniTimbroDocBean, String idUd) throws Exception {
		
		OpzioniTimbroBean lOpzioniTimbroBeanOmissis = buildOpzioniApponiTimbro(idUd, lFileDaTimbrareBeanOmissis, lOpzioniTimbroDocBean);
		
		// Timbro il file
		TimbraResultBean lTimbraResultBeanOmissis = new TimbraUtility().timbra(lOpzioniTimbroBeanOmissis, getSession());
		// Verifico se la timbratura è andata a buon fine
		if (lTimbraResultBeanOmissis.isResult()) {
			// Aggiungo il file timbrato nella lista dei file da pubblicare
			lFileDaTimbrareBeanOmissis.setUri(lTimbraResultBeanOmissis.getUri());
		} else {
			// // La timbratura è fallita, pubblico il file sbustato
			// files.add(StorageImplementation.getStorage().extractFile(uriFileSbustato));
			String errorMessage = "Si è verificato un errore durante la timbratura del file";
			if (StringUtils.isNotBlank(lTimbraResultBeanOmissis.getError())) {
				errorMessage += ": " + lTimbraResultBeanOmissis.getError();
			}
			throw new Exception(errorMessage);
		}	
		
		File lFileTimbratoOmissis = StorageImplementation.getStorage().extractFile(lFileDaTimbrareBeanOmissis.getUri());		
		MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = new MimeTypeFirmaBean();
		lMimeTypeFirmaBeanOmissis = new InfoFileUtility().getInfoFromFile(lFileTimbratoOmissis.toURI().toString(), lFileDaTimbrareBeanOmissis.getNomeFile(), false, null);
		lFileDaTimbrareBeanOmissis.setNomeFile(FilenameUtils.getBaseName(lFileDaTimbrareBeanOmissis.getNomeFile()) + ".pdf");
		lMimeTypeFirmaBeanOmissis.setFirmato(false);
		lMimeTypeFirmaBeanOmissis.setFirmaValida(false);
		lMimeTypeFirmaBeanOmissis.setConvertibile(false);
		lMimeTypeFirmaBeanOmissis.setDaScansione(false);
		lFileDaTimbrareBeanOmissis.setInfoFile(lMimeTypeFirmaBeanOmissis);	
		
		return lFileDaTimbrareBeanOmissis;
	}
	
	private OpzioniTimbroBean buildOpzioniApponiTimbro(String idUd, FileDaFirmareBean lFileDaTimbrareBean, OpzioniTimbroDocBean lOpzioniTimbroDocBean) throws Exception, Exception {
		
		OpzioniTimbroBean lOpzioniTimbroBean = new OpzioniTimbroBean();
		lOpzioniTimbroBean.setMimetype(lFileDaTimbrareBean.getInfoFile() != null ? lFileDaTimbrareBean.getInfoFile().getMimetype() : null);
		lOpzioniTimbroBean.setUri(lFileDaTimbrareBean.getUri());
		lOpzioniTimbroBean.setNomeFile(lFileDaTimbrareBean.getNomeFile());
		lOpzioniTimbroBean.setIdUd(idUd);
		lOpzioniTimbroBean.setRemote(true);
		lOpzioniTimbroBean = new TimbraUtility().loadSegnatureRegistrazioneDefault(lOpzioniTimbroBean, getSession(), getLocale());
		
		/**
		 * Se l'utente vuole saltare la scelta delle preference di apposizione timbro allora:
		 * Scelta delle preference di apposizione timbro, se sono presenti le preference utilizzo queste altrimenti
		 * vengono recuperate detro il config.xml dal bean OpzioniTimbroAutoDocRegBean.
		 * Altrimenti utilizzo le preference utilizzate per ogni file.
		 */		
		
		OpzioniTimbroAttachEmail lOpzTimbroAutoDocRegBean = null;
		try{
			 lOpzTimbroAutoDocRegBean = (OpzioniTimbroAttachEmail) SpringAppContext.getContext().getBean("OpzioniTimbroAutoDocRegBean");
		} catch (NoSuchBeanDefinitionException e) {
			/**
			 * Se il Bean OpzioniTimbroAutoDocRegBean non è correttamente configurato vengono utilizzare le preference del 
			 * bean OpzioniTimbroAttachEmail affinchè la timbratura vada a buon fine.
			 */
			logProtDS.warn("OpzioniTimbroAutoDocRegBean non definito nel file di configurazione");
		}
		
		String rotazioneTimbroPref =  getExtraparams().get("rotazioneTimbroPref");
		String posizioneTimbroPref =  getExtraparams().get("posizioneTimbroPref");
		String tipoPaginaTimbroPref = getExtraparams().get("tipoPaginaTimbroPref");
			
		String rotazioneTimbroBean = lOpzTimbroAutoDocRegBean.getRotazioneTimbro() != null &&
				!"".equals(lOpzTimbroAutoDocRegBean.getRotazioneTimbro()) ? lOpzTimbroAutoDocRegBean.getRotazioneTimbro().value() : "verticale";
		String posizioneTimbroBean =  lOpzTimbroAutoDocRegBean.getPosizioneTimbro() != null &&
				!"".equals(lOpzTimbroAutoDocRegBean.getPosizioneTimbro()) ? lOpzTimbroAutoDocRegBean.getPosizioneTimbro().value() : "altoSn";
		String tipoPaginaTimbroBean = lOpzTimbroAutoDocRegBean.getPaginaTimbro().getTipoPagina() != null ? 
				lOpzTimbroAutoDocRegBean.getPaginaTimbro().getTipoPagina().value() : "TUTTE";
		
		if(StringUtils.isNotBlank(getExtraparams().get("skipSceltaApponiTimbro")) && "true".equals(getExtraparams().get("skipSceltaApponiTimbro"))){
			
			/**
			 * In ordine viene data la seguente priorità di opzioni di generazione timbro
			 * 1) Preference di generazione timbro globale
			 * 2) Preference presenti nel config.xml
			 */
			
			lOpzioniTimbroBean.setRotazioneTimbro(StringUtils.isNotBlank(rotazioneTimbroPref) ? rotazioneTimbroPref : rotazioneTimbroBean);
			lOpzioniTimbroBean.setPosizioneTimbro(StringUtils.isNotBlank(posizioneTimbroPref) ? posizioneTimbroPref : posizioneTimbroBean);
			lOpzioniTimbroBean.setTipoPagina(StringUtils.isNotBlank(tipoPaginaTimbroPref) ? tipoPaginaTimbroPref : tipoPaginaTimbroBean);
			lOpzioniTimbroBean.setTimbroSingolo(false);
			lOpzioniTimbroBean.setMoreLines(false);
			
		} else {
			/**
			 * In ordine viene data la seguente priorità di opzioni di generazione timbro
			 * 1) Preference di generazione timbro presenti nella select di scelta per ogni file
			 * 2) Preference di generazione timbro globale
			 * 3) Preference presenti nel config.xml
			 */
		
			if( lOpzioniTimbroDocBean != null ){
				
				String rotazioneOpzTimbro =  lOpzioniTimbroDocBean.getRotazioneTimbro();
				String posizioneOpzTimbro  =  lOpzioniTimbroDocBean.getPosizioneTimbro();
				String tipoPaginaOpzTimbro  = lOpzioniTimbroDocBean.getTipoPaginaTimbro();
				
				if(StringUtils.isNotBlank(rotazioneOpzTimbro)){
					lOpzioniTimbroBean.setRotazioneTimbro(rotazioneOpzTimbro);
				} else {
					lOpzioniTimbroBean.setRotazioneTimbro(StringUtils.isNotBlank(rotazioneTimbroPref) ? rotazioneTimbroPref : rotazioneTimbroBean);
				}
				if(StringUtils.isNotBlank(posizioneOpzTimbro)){
					lOpzioniTimbroBean.setPosizioneTimbro(posizioneOpzTimbro);
				} else {
					lOpzioniTimbroBean.setPosizioneTimbro(StringUtils.isNotBlank(posizioneTimbroPref) ? posizioneTimbroPref : posizioneTimbroBean);
				}
				if(StringUtils.isNotBlank(tipoPaginaOpzTimbro)){
					if("intervallo".equals(tipoPaginaOpzTimbro)){
						lOpzioniTimbroBean.setTipoPagina(null);
						lOpzioniTimbroBean.setPaginaDa(String.valueOf(lOpzioniTimbroDocBean.getPaginaDa()));
						lOpzioniTimbroBean.setPaginaA(String.valueOf(lOpzioniTimbroDocBean.getPaginaA()));
					}else{
						lOpzioniTimbroBean.setTipoPagina(tipoPaginaOpzTimbro);
					}
				}else{
					lOpzioniTimbroBean.setTipoPagina(StringUtils.isNotBlank(tipoPaginaTimbroPref) ? tipoPaginaTimbroPref : tipoPaginaTimbroBean);
				}
				
				lOpzioniTimbroBean.setTimbroSingolo(false);
				lOpzioniTimbroBean.setMoreLines(false);
			
			}
		}
		
		return lOpzioniTimbroBean;
	}
	
	/**
	 *APPOSIZIONE TIMBRO PER FILE ALLEGATO
	 */
	private FileDaFirmareBean timbraFileAllegato(FileDaFirmareBean lFileDaTimbrareBean,	ProtocollazioneBean bean, String idUd, Integer index) throws Exception {
		
		OpzioniTimbroBean lOpzioniTimbroBean = buildOpzioniApponiTimbroAllegato(idUd, lFileDaTimbrareBean, bean.getListaAllegati().get(index).getOpzioniTimbro());
		
		// Timbro il file
		TimbraResultBean lTimbraResultBean = new TimbraUtility().timbra(lOpzioniTimbroBean, getSession());
		// Verifico se la timbratura è andata a buon fine
		if (lTimbraResultBean.isResult()) {
			// Aggiungo il file timbrato nella lista dei file da pubblicare
			lFileDaTimbrareBean.setUri(lTimbraResultBean.getUri());
		} else {
			// // La timbratura è fallita, pubblico il file sbustato
			// files.add(StorageImplementation.getStorage().extractFile(uriFileSbustato));
			String errorMessage = "Si è verificato un errore durante la timbratura del file";
			if (StringUtils.isNotBlank(lTimbraResultBean.getError())) {
				errorMessage += ": " + lTimbraResultBean.getError();
			}
			throw new Exception(errorMessage);
		}	
		
		File lFileTimbrato = StorageImplementation.getStorage().extractFile(lFileDaTimbrareBean.getUri());		
		MimeTypeFirmaBean lMimeTypeFirmaBean = new MimeTypeFirmaBean();
		lMimeTypeFirmaBean = new InfoFileUtility().getInfoFromFile(lFileTimbrato.toURI().toString(), lFileDaTimbrareBean.getNomeFile(), false, null);
		lFileDaTimbrareBean.setNomeFile(FilenameUtils.getBaseName(lFileDaTimbrareBean.getNomeFile()) + ".pdf");
		lMimeTypeFirmaBean.setFirmato(false);
		lMimeTypeFirmaBean.setFirmaValida(false);
		lMimeTypeFirmaBean.setConvertibile(false);
		lMimeTypeFirmaBean.setDaScansione(false);
		lFileDaTimbrareBean.setInfoFile(lMimeTypeFirmaBean);
		
		return lFileDaTimbrareBean;
	}
	
	private FileDaFirmareBean timbraFileAllegatoOmissis(FileDaFirmareBean lFileDaTimbrareBeanOmissis,	ProtocollazioneBean bean, String idUd, Integer index) throws Exception {
		
		OpzioniTimbroBean lOpzioniTimbroBeanOmissis = buildOpzioniApponiTimbroAllegato(idUd, lFileDaTimbrareBeanOmissis, bean.getListaAllegati().get(index).getOpzioniTimbroOmissis());
		
		// Timbro il file
		TimbraResultBean lTimbraResultBeanOmissis = new TimbraUtility().timbra(lOpzioniTimbroBeanOmissis, getSession());
		// Verifico se la timbratura è andata a buon fine
		if (lTimbraResultBeanOmissis.isResult()) {
			// Aggiungo il file timbrato nella lista dei file da pubblicare
			lFileDaTimbrareBeanOmissis.setUri(lTimbraResultBeanOmissis.getUri());
		} else {
			// // La timbratura è fallita, pubblico il file sbustato
			// files.add(StorageImplementation.getStorage().extractFile(uriFileSbustato));
			String errorMessage = "Si è verificato un errore durante la timbratura del file";
			if (StringUtils.isNotBlank(lTimbraResultBeanOmissis.getError())) {
				errorMessage += ": " + lTimbraResultBeanOmissis.getError();
			}
			throw new Exception(errorMessage);
		}		
		
		File lFileTimbratoOmissis = StorageImplementation.getStorage().extractFile(lFileDaTimbrareBeanOmissis.getUri());		
		MimeTypeFirmaBean lMimeTypeFirmaBeanOmissis = new MimeTypeFirmaBean();
		lMimeTypeFirmaBeanOmissis = new InfoFileUtility().getInfoFromFile(lFileTimbratoOmissis.toURI().toString(), lFileDaTimbrareBeanOmissis.getNomeFile(), false, null);
		lFileDaTimbrareBeanOmissis.setNomeFile(FilenameUtils.getBaseName(lFileDaTimbrareBeanOmissis.getNomeFile()) + ".pdf");
		lMimeTypeFirmaBeanOmissis.setFirmato(false);
		lMimeTypeFirmaBeanOmissis.setFirmaValida(false);
		lMimeTypeFirmaBeanOmissis.setConvertibile(false);
		lMimeTypeFirmaBeanOmissis.setDaScansione(false);
		lFileDaTimbrareBeanOmissis.setInfoFile(lMimeTypeFirmaBeanOmissis);	
		
		return lFileDaTimbrareBeanOmissis;
	}
	
	private OpzioniTimbroBean buildOpzioniApponiTimbroAllegato(String idUd, FileDaFirmareBean lFileDaTimbrareBean, OpzioniTimbroDocBean lOpzioniTimbroDocBean) throws Exception {
		
		OpzioniTimbroBean lOpzioniTimbroBean = new OpzioniTimbroBean();
		lOpzioniTimbroBean.setMimetype(lFileDaTimbrareBean.getInfoFile() != null ? lFileDaTimbrareBean.getInfoFile().getMimetype() : null);
		lOpzioniTimbroBean.setUri(lFileDaTimbrareBean.getUri());
		lOpzioniTimbroBean.setNomeFile(lFileDaTimbrareBean.getNomeFile());
		lOpzioniTimbroBean.setIdUd(idUd);
		lOpzioniTimbroBean.setRemote(true);
		lOpzioniTimbroBean = new TimbraUtility().loadSegnatureRegistrazioneDefault(lOpzioniTimbroBean, getSession(), getLocale());
		
		/**
		 * Se l'utente vuole saltare la scelta delle preference di apposizione timbro allora:
		 * Scelta delle preference di apposizione timbro, se sono presenti le preference utilizzo queste altrimenti
		 * vengono recuperate detro il config.xml dal bean OpzioniTimbroAutoDocRegBean.
		 * Altrimenti utilizzo le preference utilizzate per ogni file.
		 */

		OpzioniTimbroAttachEmail lOpzTimbroAutoDocRegBean = null;
		try{
			 lOpzTimbroAutoDocRegBean = (OpzioniTimbroAttachEmail) SpringAppContext.getContext().getBean("OpzioniTimbroAutoDocRegBean");
		} catch (NoSuchBeanDefinitionException e) {
			/**
			 * Se il Bean OpzioniTimbroAutoDocRegBean non è correttamente configurato vengono utilizzare le preference del 
			 * bean OpzioniTimbroAttachEmail affinchè la timbratura vada a buon fine.
			 */
			logProtDS.warn("OpzioniTimbroAutoDocRegBean non definito nel file di configurazione");
		}
		
		String rotazioneTimbroPref =  getExtraparams().get("rotazioneTimbroPref");
		String posizioneTimbroPref =  getExtraparams().get("posizioneTimbroPref");
		String tipoPaginaTimbroPref = getExtraparams().get("tipoPaginaTimbroPref");
			
		String rotazioneTimbroBean = lOpzTimbroAutoDocRegBean.getRotazioneTimbro() != null &&
				!"".equals(lOpzTimbroAutoDocRegBean.getRotazioneTimbro()) ? lOpzTimbroAutoDocRegBean.getRotazioneTimbro().value() : "verticale";
		String posizioneTimbroBean =  lOpzTimbroAutoDocRegBean.getPosizioneTimbro() != null &&
				!"".equals(lOpzTimbroAutoDocRegBean.getPosizioneTimbro()) ? lOpzTimbroAutoDocRegBean.getPosizioneTimbro().value() : "altoSn";
		String tipoPaginaTimbroBean = lOpzTimbroAutoDocRegBean.getPaginaTimbro().getTipoPagina() != null ? 
				lOpzTimbroAutoDocRegBean.getPaginaTimbro().getTipoPagina().value() : "TUTTE";
		
		if(StringUtils.isNotBlank(getExtraparams().get("skipSceltaApponiTimbro")) && "true".equals(getExtraparams().get("skipSceltaApponiTimbro"))){
			
			/**
			 * In ordine viene data la seguente priorità di opzioni di generazione timbro
			 * 1) Preference di generazione timbro globale
			 * 2) Preference presenti nel config.xml
			 */
			
			lOpzioniTimbroBean.setRotazioneTimbro(StringUtils.isNotBlank(rotazioneTimbroPref) ? rotazioneTimbroPref : rotazioneTimbroBean);
			lOpzioniTimbroBean.setPosizioneTimbro(StringUtils.isNotBlank(posizioneTimbroPref) ? posizioneTimbroPref : posizioneTimbroBean);
			lOpzioniTimbroBean.setTipoPagina(StringUtils.isNotBlank(tipoPaginaTimbroPref) ? tipoPaginaTimbroPref : tipoPaginaTimbroBean);
			lOpzioniTimbroBean.setTimbroSingolo(false);
			lOpzioniTimbroBean.setMoreLines(false);
			
		} else {
			/**
			 * In ordine viene data la seguente priorità di opzioni di generazione timbro
			 * 1) Preference di generazione timbro presenti nella select di scelta per ogni file
			 * 2) Preference di generazione timbro globale
			 * 3) Preference presenti nel config.xml
			 */
		
			if( lOpzioniTimbroDocBean != null ){
				
				String rotazioneOpzTimbro =   lOpzioniTimbroDocBean.getRotazioneTimbro();
				String posizioneOpzTimbro  =  lOpzioniTimbroDocBean.getPosizioneTimbro();
				String tipoPaginaOpzTimbro  = lOpzioniTimbroDocBean.getTipoPaginaTimbro();
				
				if(StringUtils.isNotBlank(rotazioneOpzTimbro)){
					lOpzioniTimbroBean.setRotazioneTimbro(rotazioneOpzTimbro);
				} else {
					lOpzioniTimbroBean.setRotazioneTimbro(StringUtils.isNotBlank(rotazioneTimbroPref) ? rotazioneTimbroPref : rotazioneTimbroBean);
				}
				if(StringUtils.isNotBlank(posizioneOpzTimbro)){
					lOpzioniTimbroBean.setPosizioneTimbro(posizioneOpzTimbro);
				} else {
					lOpzioniTimbroBean.setPosizioneTimbro(StringUtils.isNotBlank(posizioneTimbroPref) ? posizioneTimbroPref : posizioneTimbroBean);
				}
				if(StringUtils.isNotBlank(tipoPaginaOpzTimbro)){
					if("intervallo".equals(tipoPaginaOpzTimbro)){
						lOpzioniTimbroBean.setTipoPagina(null);
						lOpzioniTimbroBean.setPaginaDa(String.valueOf(lOpzioniTimbroDocBean.getPaginaDa()));
						lOpzioniTimbroBean.setPaginaA(String.valueOf(lOpzioniTimbroDocBean.getPaginaA()));
					}else{
						lOpzioniTimbroBean.setTipoPagina(tipoPaginaOpzTimbro);
					}
				}else{
					lOpzioniTimbroBean.setTipoPagina(StringUtils.isNotBlank(tipoPaginaTimbroPref) ? tipoPaginaTimbroPref : tipoPaginaTimbroBean);
				}
				
				lOpzioniTimbroBean.setTimbroSingolo(false);
				lOpzioniTimbroBean.setMoreLines(false);
			}
		}
		
		return lOpzioniTimbroBean;
	}
	
	/**
	 * ATTIVA_NOT_EMAIL_ASSEGN_UD con valori: 
	 * on-demand: si verifica il check lato gui flgMandaNotificaMail
	 * true
	 * false / null
	 */
	private Boolean attivaNotEmailAssegnUD(List<TipoIdBean> listaAssegnatari, Integer index) {
		
		boolean attivo = false;
		if (ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_ASSEGN_UD") != null &&
			"true".equals(ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_ASSEGN_UD"))) {
			attivo = true;
		} else 	if (ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_ASSEGN_UD") != null &&
				"on-demand".equals(ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_ASSEGN_UD"))) {
			if(listaAssegnatari.get(index) != null &&
			   listaAssegnatari.get(index).getFlgMandaNotificaMail() != null &&
			   listaAssegnatari.get(index).getFlgMandaNotificaMail() ) {
					attivo = true;
			}
		}
		return attivo;
	}
	
	/**
	 * ATTIVA_NOT_EMAIL_INVIO_CC_UD con valori: 
	 * on-demand: si verifica il check lato gui flgMandaNotificaMail
	 * true
	 * false / null
	 */
	private Boolean attivaNotEmailInvioCCUD(List<TipoIdBean> listaAssegnatari,Integer index) {
		
		boolean attivo = false;
		if (ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_INVIO_CC_UD") != null &&
			"true".equals(ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_INVIO_CC_UD"))) {
			attivo = true;
		} else 	if (ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_INVIO_CC_UD") != null &&
				"on-demand".equals(ParametriDBUtil.getParametroDB(getSession(), "ATTIVA_NOT_EMAIL_INVIO_CC_UD"))) {
			if(listaAssegnatari.get(index) != null &&
			   listaAssegnatari.get(index).getFlgMandaNotificaMail() != null &&
			   listaAssegnatari.get(index).getFlgMandaNotificaMail() ) {
					attivo = true;
			}
		}
		return attivo;
	}
	
	public ProtocollazioneBean modificaTipologiaUD(ProtocollazioneBean bean) throws Exception {

		AurigaLoginBean loginBean = AurigaUserUtil.getLoginInfo(getSession());

		DmpkCoreUpddocudBean input = new DmpkCoreUpddocudBean();
		input.setCodidconnectiontokenin(loginBean.getToken());
		input.setIduserlavoroin(StringUtils.isNotBlank(loginBean.getIdUserLavoro()) ? new BigDecimal(loginBean.getIdUserLavoro()): null);

		input.setIduddocin(bean.getIdDocPrimario());
		input.setFlgtipotargetin("D");

		CreaModDocumentoInBean lCreaModDocumentoInBean = new CreaModDocumentoInBean();
		lCreaModDocumentoInBean.setTipoDocumento(getExtraparams().get("tipoDocumento"));

		XmlUtilitySerializer lXmlUtilitySerializer = new XmlUtilitySerializer();
		input.setAttributiuddocxmlin(lXmlUtilitySerializer.bindXml(lCreaModDocumentoInBean));

		DmpkCoreUpddocud lDmpkCoreUpddocud = new DmpkCoreUpddocud();
		StoreResultBean<DmpkCoreUpddocudBean> lUpddocudOutput = lDmpkCoreUpddocud.execute(getLocale(), loginBean,input);

		if (lUpddocudOutput.isInError()) {
			throw new StoreException(lUpddocudOutput);
		}

		return bean;
	}

}
