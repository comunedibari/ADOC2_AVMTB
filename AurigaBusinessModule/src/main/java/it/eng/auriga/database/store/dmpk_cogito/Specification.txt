1        PACKAGE               DMPK_COGITO AUTHID CURRENT_USER IS
2        
3          /**************************************   INFORMAZIONI GENERALI   ****************************************************/
4          --
5          -- Argomenti delle stored per il controllo della transazione:
6          -- FlgRollBckFullIn -> se 1 in caso di errore viene fatta la rollback completa (non a savepoint),
7          --         altrimenti la rollback delle sole modifiche effettuate nella stored
8          --         ATTENZIONE: la rollback, di qualsiasi tipo, non riguarda la scrittura di eventuali log
9          -- FlgAutoCommitIn  -> se vale 1, dopo la rollback e qualunque sia l'esito (positivo o no), la stored esegue una commit finale
10          -- Tutte le funzioni/procedure che NON hanno gli argomenti in input FlgRollBckFullIn e FlgAutoCommitIn
11          -- NON ESEGUONO AL LORO INTERNO ALCUNA COMMIT nè ROLLBACK
12          --
13          -- Tutte le funzioni, tranne quelle da utilizzarsi nelle select, restituiscono 1 in caso di successo, altrimenti 0
14          -- Tali funzioni restituiscono, in caso di result 0, un n.ro, un contesto e un messaggio di errore:
15          -- il n.ro è: <0 se errore ORACLE non specificamente gestito
16          --      da 1->1000 errore "grave" (SEVERE_ERROR) gestito
17          --      >1000 errore non grave gestito
18          -- il contesto indica il package e/o funzione/procedura in cui si è verificato l'errore
19        
20        
21          -- Funzione per ricercare i record T_COGITO_LOG
22          FUNCTION TrovaCogitoLog(
23                                  CodIdConnectionTokenIn    IN        DMT_CONNECTION_TOKEN.CI_CONNECTION_TOKEN%TYPE, -- (obblig). Codice identificativo del token di connessione
24                                  IdUserLavoroIn            IN        DMT_USERS.ID_USER%type DEFAULT NULL,           -- Id. dell'utente a nome di cui si lavora. Se non valorizzato è l'utente connesso
25                                  FlgPreimpostaFiltroIn     IN        PLS_INTEGER DEFAULT NULL,                      -- (valori 1/0/NULL) Se vale 1 i filtri e l'ordinamento vengono settati secondo le impostazioni dell'utente di lavoro, altrimenti restano come passati in input
26                                  --------------- inizio filtri di ricerca-------------------
27                                  IdCogitoLogIO             IN OUT    T_COGITO_LOG.ID_COGITO%type,                   -- 1° filtro di ricerca: id. del record da ricercare
28                                  IdCogitoOperationIO       IN OUT    T_COGITO_LOG.ID_COGITO_OPERATION%type,         -- 2° filtro di ricerca: id. operazione da ricercare
29                                  TsChiamataIO              IN OUT    T_COGITO_LOG.Ts_Inizio_Chiamata%type,          -- 3° filtro di ricerca: Stringa con il timestamp (nel formato GG/MM/AAAA HH24:MI:SS) di al quale è attiva la chiamata chiamata
30                                  NriLivelliRestituiteIO    IN OUT    T_COGITO_LOG.Nri_Livelli_Restituite%type,      -- 4° filtro di ricerca: stringa contenuta nel campo Nri_Livelli_Restituite (ricerca case insensitive in like senza forzare il % finale)
31                                  NriLivelliSceltaIO        IN OUT    T_COGITO_LOG.NRI_LIVELLI_SCELTA%type,          -- 5° filtro di ricerca: stringa contenuta nel campo NRI_LIVELLI_SCELTA (ricerca case insensitive in like senza forzare il % finale)
32                                  AltriCriteriIO            IN OUT    NOCOPY CLOB,  -- Altri criteri di ricerca sugli attributi addizionali dei tipi documenti (XML conforme a schema LISTA_STD.xsd). Se più di uno vengono applicati in AND.
33                                                                                    -- Ogni criterio è un tag Riga che può contenere le seguenti colonne:
34                                                                                    --  1) Nome (ATTR_NAME) dell'attributo cui è relativo il criterio
35                                                                                    --  2) (obblig.) Operatore logico. Valori possibili:
36                                                                                    --    "uguale" (ricerca esatta)
37                                                                                    --    "simile a (case-sensitive)" (ricerca case-sensitive in like)
38                                                                                    --    "simile a (case-insensitive)" (ricerca case-insensitive in like e che ignora i caratteri quali spazi, ., ecc)
39                                                                                    --    "maggiore" (se attributo numerico o data)
40                                                                                    --    "maggiore o uguale" (se attributo numerico o data)
41                                                                                    --    "minore" (se attributo numerico o data)
42                                                                                    --    "minore o uguale" (se attributo numerico o data)
43                                                                                    --    "tra" (se attributo numerico o data)
44                                                                                    --    "non valorizzato"
45                                                                                    --    "valorizzato"
46                                                                                    --    "spuntato" (se attributo di tipo casella di spunta)
47                                                                                    --    "non spuntato" (se attributo di tipo casella di spunta)
48                                                                                    --  3) 1° valore di confronto (obblig. e gestito solo se l'operatore non ha uno dei seguenti valori: valorizzato, non valorizzato, spuntato, non spuntato) (se l'attributo è numerico deve avere la virgola come separatore dei decimali, se è di tipo data deve essere in uno dei formato dati dai parametri di conf. FMT_STD_DATA e FMT_STD_TIMESTAMP)
49                                                                                    --  4) 2° valore di confronto (obblig. e gestito solo se l'operatore è "tra") (se l'attributo è numerico deve avere la virgola come separatore dei decimali, se è di tipo data deve essere in uno dei formato dati dai parametri di conf. FMT_STD_DATA e FMT_STD_TIMESTAMP)
50                                                                                    --  5) Label dell''attributo cui è relativo il criterio (se sotto-attributo di complesso <label del complesso> - <label del sotto-attributo>
51                                  ------------- inizio argomenti standard di tutte le funzioni di ricerca che devono restituire una lista --------------
52                                  ColOrderByIO              IN OUT  VARCHAR2,       -- Indica il/i numeri della/e colonna dell'XML (CLOB ListaXMLOut) di output per cui ordinare i record nell'XML stesso (si può ordinare solo per le colonne da 1 a 17). Se l'ordinamento è per più colonne queste vanno separate con "," (es: 2; 2,3)
53                                                                                    -- in output può essere diverso che in input solo se in input è NULL: in tal caso significa che esiste sul tipo di ordinamento una qualche preimpostazione di sistema/utente ecc.
54                                                                                    -- se non valorizzato (neppure in output) la lista di record restituita non è ordinata
55                                  FlgDescOrderByIO          IN OUT  VARCHAR2,       -- E' una stringa di 1 o 0/NULL, tanti quanti le colonne di ordinamento, separati da ",": 1 significa che l'ordinamento per la data colonna deve essere discendente anzichè ascendente (es: 1; 1,0; 1, )
56                                                                                    -- in output può essere diverso che in input solo se in input è NULL: in tal caso significa che esiste sul verso di ordinamento una qualche preimpostazione di sistema/utente ecc.
57                                  FlgSenzaPaginazioneIn     IN      PLS_INTEGER DEFAULT NULL,  -- (valori 1/0/NULL) Se 1 l'estrazione non è paginata, altrimenti sì
58                                  NroPaginaIO               IN OUT  PLS_INTEGER,               -- E' il numero della pagina da estrarre; se NULL e l'estrazione è paginata viene estratta la prima pagina
59                                  BachSizeIO                IN OUT  PLS_INTEGER,               -- Indica il massimo n.ro di record da estrarre se l'estrazione non è paginata (FlgSenzaPaginazioneIn=1)
60                                                                                               -- Indica la dimensione (n.ro di record) della pagina se l'estrazione è paginata (FlgSenzaPaginazioneIn 0 o NULL) e in tal caso se non è valorizzato la dimensione della pagina è quella settata per l'utente di lavoro o è pari al valore del parametro STD_PAGE_NUM_ROW del dominio di lavoro
61                                  OverFlowLimitIn           IN      PLS_INTEGER DEFAULT NULL,  -- E' il n.ro di record soddisfacenti la ricerca superato il quale la funzione deve restituire errore di overflow
62                                  FlgSenzaTotIn             IN      PLS_INTEGER DEFAULT NULL,  -- (valori 1/0/NULL) Se 1 significa che non è richiesto come output il totale dei record soddisfacenti la ricerca (se la ricerca è paginata per la prima pagina il totale viene calcolato comunque, per le successive no)
63                                  NroTotRecOut              OUT     PLS_INTEGER,               -- E' il n.ro di record complessivi trovati (valorizzato solo se FlgSenzaTotIn è 0 o NULL o se si estrae la prima pagina)
64                                  NroRecInPaginaOut         OUT     PLS_INTEGER,               -- E' il numero di record nella pagina (valorizzato solo se l'estrazione è paginata, ovvero se FlgSenzaPaginazioneIn 0 o NULL)
65                                  ------------- fine argomenti standard di tutte le funzioni di ricerca che devono restituire una lista --------------
66                                  ListaXMLOut               OUT     NOCOPY CLOB,-- Lista dei tipi di documenti trovati (XML conforme a schema LISTA_STD.xsd)
67                                                                                -- Ogni tipo di documento è un tag Riga che può contenere le seguenti colonne:
68                                                                                -- 1:  Identificativo del tipo di documento
69                                                                                -- 2:  Nome del tipo di documento
70                                                                                -- 3:  Descrizione dettagliata del tipo di documento
71                                                                                -- 4:  Nome del tipo di documento più generale in cui ricade
72                                                                                -- 5:  Identificativo del tipo di documento più generale in cui ricade
73                                                                                -- 6:  (valori 1/2/0) Se 1 indica che può essere un allegato di un unità documentaria, se 2 che deve esserlo necessariamente, se 0 che non può essere un allegato
74                                                                                -- 7:  Natura del tipo di documento (atto pubblico, scrittura privata ecc).
75                                                                                -- 8:  Indica se in genere i documenti del dato tipo sono in entrata (E), interni (I) o in uscita (U) dal soggetto produttore / AOO
76                                                                                -- 9:  Livelli e descrizione dell'eventuale classificazione in cui ricadono tutti i documenti del dato tipo
77                                                                                -- 10: Supporto fisico su cui normalmente nascono i documenti del dato tipo
78                                                                                -- 11: Nome del formato elettronico che hanno in genere i documenti del dato tipo
79                                                                                -- 12: Indica se in genere un documento cartaceo del dato tipo in possesso del soggetto produttore è: originale unico (OU), originale non unico (ONU), copia (C)
80                                                                                -- 13: (valori 1/0) Se 1 indica che è richiesta la scansione dei documenti del dato tipo in caso siano originariamente cartacei
81                                                                                -- 14: Periodo di conservazione ("Illimitato" o espresso come n.ro di anni) dei documenti del dato tipo
82                                                                                -- 15: Descrizione del supporto di conservazione previsto per i documenti del dato tipo
83                                                                                -- 16: Specifiche di accessibilità
84                                                                                -- 17: Specifiche di riproducibilità
85                                                                                -- 18: (valori 1/0) Se 1 è un tipo di documento che ha modelli associati, se 0 no
86                                                                                -- 19: Folder dato in automatico ai documenti del dato tipo (le parti variabili sono indicate in brackets)
87                                                                                -- 20: Annotazioni sul tipo di documento
88                                                                                -- 21: Flag di annullamento logico (valori 1/0)
89                                                                                -- 22: Motivi dell'annullamento logico
90                                                                                -- 23: Cod. identificativo del tipo di documento nel sistema di provenienza
91                                                                                -- 24: Timestamp di creazione del tipo di documento (nel formato dato dal parametro di conf. FMT_STD_TIMESTAMP)
92                                                                                -- 25: Descrizione dell'utente di creazione del tipo di documento
93                                                                                -- 26: Timestamp di ultima modifica dei dati del tipo di documento (nel formato dato dal parametro di conf. FMT_STD_TIMESTAMP)
94                                                                                -- 27: Descrizione dell'utente di ultima modifica dei dati del tipo di documento
95                                                                                -- 28: (valori 1/0) Indicatore di tipo di documento riservato dal sistema e non modificabile da applicativo
96                                                                                -- 29: (valori 1/0): se 1 è richiesta abilitazione esplicita per visualizzare documenti del dato tipo
97                                                                                -- 30: (valori 1/0): se 1 è richiesta abilitazione esplicita per gestire (modificare, versionare, cancellare) documenti del dato tipo
98                                                                                -- 31: (valori 1/0): se 1 è richiesta abilitazione esplicita per assegnare il dato tipo ad un documento
99                                                                                -- 32: (valori 1/0): se 1 è richiesta abilitazione esplicita per firmare documenti del dato tipo
100                                  FlgAbilInsOut             OUT     PLS_INTEGER,-- (valori 1/0) Se 1 si ha abilitazione a inserimento di tipo di documento
101                                  FlgAbilUpdOut             OUT     PLS_INTEGER,-- (valori 1/0) Se 1 si ha abilitazione a modifica di tipo di documento
102                                  FlgAbilDelOut             OUT     PLS_INTEGER,-- (valori 1/0) Se 1 si ha abilitazione a cancellazione di tipo di documento
103                                  FlgMostraAltriAttrOut     OUT     PLS_INTEGER,-- (valori 1/0) Se 1 nella GUI vanno mostrati gli attributi addizionali per un nuovo di tipo di documento (ce ne sono di visibile all'utente), se 0 no
104                                  ErrContextOut             OUT     VARCHAR2,   -- Contesto (ovvero package e/o funzione/procedura) in cui si è verificato l'errore
105                                  ErrCodeOut                OUT     PLS_INTEGER,-- N.ro errore di uscita
106                                  ErrMsgOut                 OUT     VARCHAR2,   -- Messaggio d'errore
107                                  NomeTagRigaIn             IN      VARCHAR2 default null,   --se valorizzato è il nome del tag riga che deve avere l'xml in output
108                                  NomeTagColonnaIn          IN      DMVA_STRING default null --se valorizzatorappresenta i nomi dei tag colonne dell'xml di output
109              )return PLS_INTEGER;  -- Vale 1 se tutto è andato a buon fine, altrimenti 0
110              
111        	-- Funzione per inserire o aggiornare un record in tabella T_COGITO_LOG
112          function IUCogitoLog(
113                               CodIdConnectionTokenIn      IN         DMT_CONNECTION_TOKEN.CI_CONNECTION_TOKEN%TYPE, -- (obblig). Codice identificativo del token di connessione
114                               IdUserLavoroIn              IN         DMT_USERS.ID_USER%type DEFAULT NULL,           -- Id. dell'utente a nome di cui si lavora. Se non valorizzato è l'utente connesso
115                               --------------------------------------------------------------------------
116                               -- custom arguments INIZIO
117                               --
118                               IdCogitoLogIO               IN OUT     T_COGITO_LOG.ID_COGITO%type,                 -- Identificativo del record da modificare. Se non valorizzato il record è da inserire ex-novo
119                                                                                                                   -- In output, salvo in caso di errore, è sempre valorizzato                                              
120                               IdCogitoOperationIn         IN         T_COGITO_LOG.ID_COGITO_OPERATION%type,
121                               TsInizioChiamataIn          IN         VARCHAR2, 
122                               TsFineChiamataIn            IN         VARCHAR2, 
123                               NriLivelliRestituiteIn      IN         T_COGITO_LOG.Nri_Livelli_Restituite%type,                       
124                               NriLivelliSceltaIn          IN         T_COGITO_LOG.NRI_LIVELLI_SCELTA%type,      
125        					   ErrMsgCogitoIn			   IN 		  CLOB,							-- Errore restituito dal servizio COGITO
126                               --
127                               -- custom arguments FINE
128                               --------------------------------------------------------------------------                       
129                               FlgIgnoreWarningIn          IN         PLS_INTEGER DEFAULT NULL,   -- (valori 1/0/NULL) Se 0 o NULL significa che in presenza di WARNING la stored si comporta come in caso di errore; se 1 gli WARNING vengono ignorati
130                               FlgRollBckFullIn            IN         PLS_INTEGER DEFAULT NULL,   -- (valori 1/0/NULL) Se 1 in caso di errore viene fatta la rollback completa (non a savepoint), altrimenti la rollback delle sole modifiche effettuate nella stored
131                                                                                                  -- ATTENZIONE: La rollback, di qualsiasi tipo, non riguarda la scrittura di eventuali log
132                               FlgAutoCommitIn             IN         PLS_INTEGER DEFAULT NULL,   -- (valori 1/0/NULL) Se vale 1, dopo la rollback e qualunque sia l'esito (positivo o meno), la funzione esegue una commit finale
133                               WarningMsgOut               OUT        VARCHAR2,                   -- Messaggio di warning (valorizzato solo se non c'è errore)
134                               ErrContextOut               OUT        VARCHAR2,                   -- Contesto (ovvero package e/o funzione/procedura) in cui si è verificato l'errore
135                               ErrCodeOut                  OUT        PLS_INTEGER,                -- N.ro errore di uscita
136                               ErrMsgOut                   OUT        VARCHAR2                    -- Messaggio d'errore
137                              ) return PLS_INTEGER;                                               -- Vale 1 se tutto è andato a buon fine (senza warning), altrimenti 0 (in caso di errore o warning)
138        
139          -- Funzione di eliminazione di un record dalla tabella T_COGITO_LOG
140          function DCogitoLog(
141                              CodIdConnectionTokenIn    IN        DMT_CONNECTION_TOKEN.CI_CONNECTION_TOKEN%TYPE, -- (obblig). Codice identificativo del token di connessione
142                              IdUserLavoroIn            IN        DMT_USERS.ID_USER%type DEFAULT NULL,           -- Id. dell'utente a nome di cui si lavora. Se non valorizzato è l'utente connesso
143                              IdCogitoLogIn             IN        T_COGITO_LOG.ID_COGITO%TYPE,                   -- (obblig.) Identificativo del record t_cogito_log da eliminare
144                              FlgIgnoreWarningIn        IN        PLS_INTEGER DEFAULT NULL,                      -- (valori 1/0/NULL) Se 0 o NULL significa che in presenza di WARNING la stored si comporta come in caso di errore; se 1 gli WARNING vengono ignorati
145                              FlgRollBckFullIn          IN        PLS_INTEGER DEFAULT NULL,                      -- (valori 1/0/NULL) Se 1 in caso di errore viene fatta la rollback completa (non a savepoint), altrimenti la rollback delle sole modifiche effettuate nella stored
146                                                                                                                 -- ATTENZIONE: La rollback, di qualsiasi tipo, non riguarda la scrittura di eventuali log
147                              FlgAutoCommitIn           IN        PLS_INTEGER DEFAULT NULL,                      -- (valori 1/0/NULL) Se vale 1, dopo la rollback e qualunque sia l'esito (positivo o meno), la funzione esegue una commit finale
148                              WarningMsgOut             OUT       VARCHAR2,                                      -- Messaggio di warning (valorizzato solo se non c'è errore)
149                              ErrContextOut             OUT       VARCHAR2,                                      -- Contesto (ovvero package e/o funzione/procedura) in cui si è verificato l'errore
150                              ErrCodeOut                OUT       PLS_INTEGER,                                   -- N.ro errore di uscita
151                              ErrMsgOut                 OUT       VARCHAR2                                       -- Messaggio d'errore
152                             ) return PLS_INTEGER;                                                               -- Vale 1 se tutto è andato a buon fine (senza warning), altrimenti 0 (in caso di errore o warning)
153        
154          -- Funzione per ottenere tutti i dati di dettaglio di un record T_COGITO_LOG
155          function LoadDettCogitoLog(
156                                     CodIdConnectionTokenIn    IN        DMT_CONNECTION_TOKEN.CI_CONNECTION_TOKEN%TYPE,   -- (obblig). Codice identificativo del token di connessione
157                                     IdUserLavoroIn            IN        DMT_USERS.ID_USER%type DEFAULT NULL,             -- Id. dell'utente a nome di cui si lavora. Se non valorizzato è l'utente connesso
158                                     IdCogitoLogIO             IN OUT    T_COGITO_LOG.ID_COGITO%type,                     -- (obblig.) Identificativo del record t_cogito_log di cui caricare il dettaglio                             
159                                     IdCogitoOperationOut      OUT       T_COGITO_LOG.ID_COGITO_OPERATION%type,                             
160                                     idAooOut                  OUT       T_COGITO_LOG.ID_AOO%type,
161                                     idUserOut                 OUT       T_COGITO_LOG.ID_USER%type,                                                          
162                                     TsInizioChiamataOut       OUT       VARCHAR2, 
163                                     TsFineChiamataOut         OUT       VARCHAR2, 
164                                     NriLivelliRestituiteOut   OUT       T_COGITO_LOG.Nri_Livelli_Restituite%type,                       
165                                     NriLivelliSceltaOut       OUT       T_COGITO_LOG.NRI_LIVELLI_SCELTA%type,         
166                                     WarningCogitoLogOut       OUT       T_COGITO_LOG.WARNING%type,         
167                                     ErrContextCogitoLogOut    OUT       T_COGITO_LOG.ERRCONTEXT%type,                                      
168                                     RowidOut                  OUT       VARCHAR2,                                        -- Rowid del record
169                                     FlgMostraAltriAttrOut     OUT       PLS_INTEGER,                                     -- (valori 1/0) Se 1 nella GUI vanno mostrati gli attributi addizionali (ce ne sono di visibile all'utente), se 0 no
170                                     ErrContextOut             OUT       VARCHAR2,                                        -- Contesto (ovvero package e/o funzione/procedura) in cui si è verificato l'errore
171                                     ErrCodeOut                OUT       PLS_INTEGER,                                     -- N.ro errore di uscita
172                                     ErrMsgOut                 OUT       VARCHAR2                                         -- Messaggio d'errore
173                                    ) return PLS_INTEGER;                                                                 -- Vale 1 se tutto è andato a buon fine, altrimenti 0
174        
175              
176        end DMPK_COGITO;